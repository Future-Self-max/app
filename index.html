<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeepShafts</title>
    <link rel="manifest" href="manifest.json">

    <!-- Sehr wichtig fÃ¼r Android/Chrome: -->
    <meta name="theme-color" content="#000000"> <!-- Oder deine Hintergrundfarbe -->

    <!-- FÃ¼r iOS (falls du auch iPhone testen willst): -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="Logo.jpg"> <!-- Dein Icon in 192Ã—192 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto:wght@700&display=swap');

        /* --- MOBILE OPTIMIZATION --- */
        #orientation-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a0f0d;
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            text-align: center;
            padding: 20px;
            font-family: var(--font-heading);
        }

        #orientation-warning i {
            font-size: 80px;
            margin-bottom: 20px;
            color: var(--accent-gold);
            animation: rotateDevice 2s infinite ease-in-out;
        }

        @keyframes rotateDevice {
            0% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(-90deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        @media screen and (orientation: portrait) and (max-width: 1024px) {
            #orientation-warning {
                display: flex;
            }

            #ui-layer,
            #world-container {
                display: none !important;
            }
        }

        /* Responsive UI Overrides */
        @media screen and (max-width: 1024px) {
            .hud-top {
                gap: 5px;
                padding: 5px 10px;
                /* Even closer to corners */
                justify-content: space-between;
            }

            .currency-pill {
                min-width: 110px;
                padding: 4px 12px;
            }

            .currency-label {
                font-size: 14px;
            }

            .popup-panel {
                width: 95%;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
            }

            .popup-content {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .popup-panel,
            .popup-panel * {
                touch-action: pan-y !important;
                /* Allow scrolling and interaction */
            }

            .research-panel {
                width: 98%;
                height: 95%;
            }

            .research-content {
                overflow-x: auto;
            }

            .research-content,
            .research-content * {
                touch-action: auto !important;
            }




            #world-container,
            #world-container * {
                touch-action: pan-y !important;
            }

            #world-container {
                overflow-y: auto !important;
            }
        }

        :root {
            --bg-sky: #87CEEB;
            --bg-ground-dark: #3E2723;
            --bg-shaft: #5D4037;
            --ui-green: #7CB342;
            --ui-green-dark: #558B2F;
            --ui-blue: #42A5F5;
            --ui-blue-dark: #1E88E5;
            --ui-panel: #263238;
            --accent-gold: #FFC107;
            --accent-supercash: #00E676;
            --font-heading: 'Fredoka One', cursive;
            --font-body: 'Roboto', sans-serif;

            /* GLASSMORPHISM VARS */
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --glass-blur: blur(12px);

            /* GOLD & GEM DESIGN */
            --gold-gem-gradient: repeating-linear-gradient(45deg, #FFD54F, #FFD54F 5px, #FFC107 5px, #FFC107 10px, #00E5FF 10px, #00E5FF 12px);
            --gold-gem-glow: 0 0 15px rgba(255, 213, 79, 0.8), 0 0 5px rgba(0, 229, 255, 0.4);
        }

        /* SUPER SHINE GLINT EFFECT */
        .glint-effect {
            position: relative;
            overflow: hidden;
        }

        .glint-effect::after {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: glint-sweep 3s infinite linear;
        }

        @keyframes glint-sweep {
            0% {
                left: -150%;
            }

            30% {
                left: 150%;
            }

            100% {
                left: 150%;
            }
        }

        /* SVG SPARKLE ANIMATION */
        @keyframes sparkle-flicker {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(0.8) rotate(0deg);
            }

            50% {
                opacity: 1;
                transform: scale(1.2) rotate(45deg);
            }
        }

        .svg-sparkle {
            animation: sparkle-flicker 1.5s infinite ease-in-out;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-drag: none;
            touch-action: none;
        }

        /* --- WEATHER PARTICLES --- */
        .weather-particle {
            position: absolute;
            pointer-events: none;
            z-index: 100;
            /* Above ground, below HUD */
        }

        .raindrop {
            width: 2px;
            height: 15px;
            background: rgba(174, 194, 224, 0.6);
            animation: fall-rain linear infinite;
        }

        .snowflake {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            filter: blur(1px);
            animation: fall-snow linear infinite;
        }

        @keyframes fall-rain {
            0% {
                transform: translateY(-100px) rotate(15deg);
            }

            100% {
                transform: translateY(110vh) rotate(15deg);
            }
        }

        @keyframes fall-snow {
            0% {
                transform: translateY(-50px) translateX(0);
            }

            25% {
                transform: translateY(25vh) translateX(20px);
            }

            50% {
                transform: translateY(50vh) translateX(-20px);
            }

            75% {
                transform: translateY(75vh) translateX(20px);
            }

            100% {
                transform: translateY(110vh) translateX(0);
            }
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #221816;
            color: #fff;
            font-family: var(--font-body);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5000;
            /* Extremely high to stay above all game elements and overlays */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* GLOBAL SETTINGS BUTTON */
        .hud-top {
            display: flex;
            justify-content: flex-start;
            padding: 15px;
            pointer-events: auto;
            align-items: flex-start;
            gap: 15px;
            width: fit-content;
        }


        .currency-pill {
            background: var(--glass-bg);
            border-radius: 30px;
            padding: 5px 15px 5px 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--glass-border);
            font-family: var(--font-heading);
            font-size: 1.2rem;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            box-shadow: var(--glass-shadow);
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.5);
            min-width: 140px;
            transition: transform 0.1s;
        }

        .currency-pill.pulse {
            animation: pillPulse 0.2s ease-out;
        }

        @keyframes pillPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 215, 0, 0);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
                border-color: #FFD54F;
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 215, 0, 0);
            }
        }

        .icon-coin-hud {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, #FFD54F, #FF6F00);
            border-radius: 45% 55% 50% 50% / 50% 50% 50% 50%;
            /* Organic nugget shape */
            border: 2px solid #fff;
            box-shadow: 0 0 15px rgba(255, 111, 0, 0.8), 0 0 25px rgba(255, 213, 79, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: #FFF8E1;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            animation: nuggetPulse 3s infinite ease-in-out;
            position: relative;
        }

        .icon-coin-hud::after {
            content: 'âœ¦';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 14px;
            color: white;
            animation: sparkle-flicker 1s infinite alternate;
        }

        @keyframes nuggetPulse {

            0%,
            100% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.05);
                filter: brightness(1.2);
            }
        }

        .icon-supercash {
            width: 32px;
            height: 24px;
            background: linear-gradient(135deg, #69F0AE 0%, #00C853 100%);
            border: 2px solid #fff;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            border: 2px solid #fff;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            /* NEW: Diamond Style */
            background: none;
            border: none;
            box-shadow: none;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-supercash::after {
            content: 'ðŸ’Ž';
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.5));
        }

        .hud-bottom {
            background: rgba(30, 30, 30, 0.6);
            height: 80px;
            display: flex;
            justify-content: center;
            gap: 30px;
            align-items: center;
            padding: 0 30px 10px 30px;
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            margin: 0 auto 15px auto;
            width: fit-content;
            pointer-events: auto;
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .hud-bottom.collapsed {
            width: 60px;
            height: 60px;
            padding: 0;
            gap: 0;
            border-radius: 50%;
            overflow: hidden;
        }

        .hud-bottom.collapsed .nav-btn {
            display: none;
        }

        .btn-toggle-menu {
            position: absolute;
            top: -15px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: var(--ui-panel);
            border: 2px solid var(--accent-gold);
            border-radius: 50%;
            color: var(--accent-gold);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .hud-bottom.collapsed .btn-toggle-menu {
            top: 50%;
            right: 50%;
            transform: translate(50%, -50%);
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            font-size: 1.5rem;
        }

        .btn-toggle-menu:hover {
            transform: scale(1.1);
        }

        /* SETTINGS BUTTON */
        .btn-settings {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            z-index: 2001;
            /* Above HUD */
            transition: all 0.2s;
        }

        .btn-settings:hover {
            transform: rotate(45deg) scale(1.1);
            background: rgba(0, 0, 0, 0.6);
            border-color: white;
        }


        /* SETTINGS BUTTON */
        .btn-settings {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            z-index: 2001;
            /* Above HUD */
            transition: all 0.2s;
        }

        .btn-settings:hover {
            transform: rotate(45deg) scale(1.1);
            background: rgba(0, 0, 0, 0.6);
            border-color: white;
        }


        /* --- MISSION SYSTEM UI --- */
        .mission-widget {
            position: absolute;
            top: 60px;
            /* Below HUD - Top Center */
            right: auto;
            left: 50%;
            transform: translateX(-50%);
            width: 260px;
            /* Wider for desktop text */
            background: rgba(33, 33, 33, 0.95);
            border: 1px solid var(--accent-gold);
            border-radius: 12px;
            z-index: 4000;
            font-family: var(--font-body);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
        }

        .mission-widget.expanded {
            height: auto;
            max-height: 80vh;
        }

        /* MOBILE OVERRIDES (Includes Landscape Phones) */
        @media screen and (max-width: 1024px) {
            .mission-widget {
                top: 80px !important;
                right: 10px !important;
                bottom: auto !important;
                left: auto !important;

                /* Default Collapsed State: Scaled Down */
                transform: scale(0.6) !important;
                transform-origin: top right !important;

                width: 50px !important;
                height: 50px !important;
                border-radius: 50%;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                font-size: 14px !important;
            }

            /* EXPANDED STATE: Reset Scale & Full Size */
            .mission-widget.expanded {
                transform: scale(1.0) !important;
                /* RESET SCALE */
                transform-origin: top right !important;
                width: 300px !important;
                /* Wider */
                height: auto !important;
                max-height: 60vh !important;
                border-radius: 12px;
                justify-content: flex-start;
                align-items: stretch;
                overflow-y: auto;
            }

            .mission-widget.expanded .mission-item {
                padding: 10px;
                gap: 5px;
            }

            .mission-widget.expanded .mission-name {
                font-size: 0.9rem;
            }

            /* HIDE CONTENT WHEN COLLAPSED */
            .mission-widget:not(.expanded) .mission-info-compact,
            .mission-widget:not(.expanded) .mission-toggle-btn {
                display: none;
            }

            /* Ensure header fills width when collapsed */
            .mission-widget:not(.expanded) .mission-header-compact {
                padding: 0;
                justify-content: center;
                width: 100%;
                height: 100%;
            }
        }

        .mission-header-compact {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            gap: 10px;
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.1), transparent);
        }

        .mission-header-compact:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .mission-icon-main {
            font-size: 24px;
            display: flex;
            /* Centering fix */
            justify-content: center;
            align-items: center;
            animation: pulse-mission-icon 2s infinite;
        }

        @media screen and (max-width: 1024px) {
            .mission-widget:not(.expanded) .mission-icon-main {
                font-size: 24px !important;
                /* Normal size inside scaled widget */
            }
        }

        @keyframes pulse-mission-icon {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
                filter: drop-shadow(0 0 5px gold);
            }

            100% {
                transform: scale(1);
            }
        }

        .mission-info-compact {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .mission-title-compact {
            font-size: 0.85rem;
            color: #fff;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mission-progress-bg {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .mission-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #69F0AE, #00C853);
            width: 0%;
            transition: width 0.5s ease;
        }

        .mission-toggle-btn {
            color: var(--accent-gold);
            font-size: 12px;
            transition: transform 0.3s;
        }

        .mission-widget.expanded .mission-toggle-btn {
            transform: rotate(180deg);
        }

        /* EXPANDED LIST */
        .mission-list-container {
            display: none;
            flex-direction: column;
            padding: 10px;
            gap: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .mission-widget.expanded .mission-list-container {
            display: flex;
        }

        .mission-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: 1px solid transparent;
            transition: background 0.2s;
        }

        .mission-item.completed {
            background: rgba(105, 240, 174, 0.15);
            border-color: #69F0AE;
            box-shadow: 0 0 10px rgba(105, 240, 174, 0.2);
        }

        .mission-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mission-name {
            font-size: 0.9rem;
            font-weight: bold;
            color: #eceff1;
        }

        .mission-reward {
            font-size: 0.8rem;
            color: var(--accent-supercash);
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 230, 118, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .mission-status-text {
            font-size: 0.75rem;
            color: #B0BEC5;
            text-align: right;
        }

        .btn-claim-mission {
            background: linear-gradient(135deg, #FFD54F, #FF6F00);
            border: none;
            color: #3E2723;
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-family: var(--font-heading);
            text-transform: uppercase;
            animation: pulse-claim 1s infinite;
            width: 100%;
        }

        @keyframes pulse-claim {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 193, 7, 0);
            }

            50% {
                transform: scale(1.02);
                box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 193, 7, 0);
            }
        }

        /* COMPACT MOBILE OVERRIDE */
        @media screen and (max-width: 600px) {
            .mission-widget {
                width: 95%;
                /* Wider on mobile */
                top: 70px;
            }
        }

        /* POPUP FOR COMPLETION (JUICY) */
        .mission-complete-overlay {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: radial-gradient(circle, #FFD54F, #FF6F00);
            padding: 2px;
            border-radius: 12px;
            z-index: 9000;
            pointer-events: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .mission-complete-inner {
            background: #212121;
            border-radius: 10px;
            padding: 20px 40px;
            text-align: center;
            color: white;
            font-family: var(--font-heading);
        }

        .anim-mission-pop {
            animation: popCheck 1.5s ease-out forwards;
        }

        @keyframes popCheck {
            0% {
                transform: translateX(-50%) scale(0) rotate(-10deg);
                opacity: 0;
            }

            20% {
                transform: translateX(-50%) scale(1.2) rotate(5deg);
                opacity: 1;
            }

            40% {
                transform: translateX(-50%) scale(1.0) rotate(0deg);
            }

            80% {
                transform: translateX(-50%) scale(1.0) translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateX(-50%) scale(1.0) translateY(-50px);
                opacity: 0;
            }
        }


        /* --- MANAGER SYSTEM UI --- */
        .manager-slot {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, #455A64 0%, #263238 100%);
            border: 2px solid #546E7A;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: absolute;
            z-index: 50;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow:
                0 4px 10px rgba(0, 0, 0, 0.5),
                inset 0 2px 4px rgba(255, 255, 255, 0.1);
            overflow: visible;
            /* For outer glows */
            pointer-events: auto !important;
        }

        /* Metallic Ring Effect */
        .manager-slot::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.15);
            pointer-events: none;
        }

        .manager-slot:hover {
            transform: scale(1.15);
            border-color: #FFD54F;
            box-shadow:
                0 0 15px rgba(255, 213, 79, 0.4),
                0 6px 15px rgba(0, 0, 0, 0.6);
        }

        .manager-slot.empty {
            background: rgba(38, 50, 56, 0.6);
            backdrop-filter: blur(4px);
            border-style: dashed;
            border-width: 1.5px;
        }

        .manager-slot.empty::after {
            content: '+';
            color: #FFD54F;
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 213, 79, 0.5);
        }

        .manager-icon {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.4);
        }

        .manager-swap-btn {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 20px;
            height: 20px;
            background: #263238;
            border: 1.5px solid #FFD54F;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100 !important;
            color: #FFD54F;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        }

        .manager-swap-btn:hover {
            transform: scale(1.2) rotate(180deg);
            background: #FFD54F;
            color: #263238;
            box-shadow: 0 0 10px #FFD54F;
        }

        .manager-swap-btn svg {
            width: 14px;
            height: 14px;
            display: block;
        }

        .manager-active-glow {
            box-shadow: 0 0 15px #00E676, 0 0 5px #00E676 inset;
            border-color: #00E676;
            animation: pulseManager 1s infinite;
        }

        @keyframes pulseManager {
            0% {
                transform: scale(1);
                box-shadow: 0 0 15px #00E676;
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 25px #00E676;
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 15px #00E676;
            }
        }

        .manager-timer-pie {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            /* Minimal loader implementation could be complex, using simple text for now */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .pos-shaft-manager {
            left: 20px;
            top: 15px;
            /* Shaft visual is 160h. Shaft tunnel starts at 100. */
        }

        .pos-shaft-manager-right {
            right: 20px;
            top: 15px;
        }

        .pos-ele-manager {
            /* Relative to Elevator Shaft container - Move to the right */
            right: -25px;
            top: 10px;
            z-index: 100 !important;
        }

        .pos-wh-manager {
            /* Now relative to warehouse container */
            top: 120px;
            left: 0px;
            z-index: 100 !important;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            opacity: 0.6;
            transition: all 0.2s;
            cursor: pointer;
            transform-origin: center;
        }

        .nav-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .nav-btn.active {
            opacity: 1;
            transform: translateY(-8px) scale(1.1);
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }

        .nav-text {
            font-size: 0.8rem;
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* MODAL */
        #modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            backdrop-filter: blur(8px);
        }

        .popup-panel {
            background: rgba(40, 44, 52, 0.85);
            /* Darker glass for better contrast */
            width: 90%;
            max-width: 480px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            overflow: hidden;
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: center;
            color: #fff;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        @keyframes popIn {
            from {
                transform: scale(0.6);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .popup-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-family: var(--font-heading);
            font-size: 1.8rem;
            border-bottom: 1px solid var(--glass-border);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .popup-close {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .popup-close:hover {
            transform: scale(1.2);
        }

        .popup-content {
            padding: 25px;
            background: transparent;
            color: #eee;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        .stat-next {
            color: #AED581;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 6px;
        }

        .btn-buy-upgrade {
            background: linear-gradient(135deg, rgba(139, 195, 74, 0.9), rgba(85, 139, 47, 0.9));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 18px;
            width: 100%;
            font-family: var(--font-heading);
            font-size: 1.4rem;
            cursor: pointer;
            margin-top: 15px;
            text-transform: uppercase;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: all 0.2s;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .btn-buy-upgrade:hover {
            box-shadow: 0 10px 25px rgba(139, 195, 74, 0.5);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .btn-buy-upgrade:active {
            transform: translateY(2px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* --- RESEARCH TREE UI --- */
        #research-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 10, 20, 0.85);
            /* Deep dark blue/black overlay */
            z-index: 4000;
            display: none;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            backdrop-filter: blur(12px);
        }

        .research-panel {
            background: linear-gradient(135deg, rgba(20, 30, 48, 0.95), rgba(36, 59, 85, 0.95));
            width: 95%;
            max-width: 900px;
            height: 85%;
            max-height: 650px;
            border-radius: 40px;
            border: 2px solid rgba(0, 229, 255, 0.3);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 150, 255, 0.2) inset;
            display: flex;
            flex-direction: column;
            animation: researchPopIn 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            position: relative;
        }

        .research-svg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 800px;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .research-connection {
            stroke: rgba(0, 150, 255, 0.2);
            stroke-width: 5;
            fill: none;
            stroke-linecap: round;
        }

        .research-connection.active {
            stroke: #00E676;
            filter: drop-shadow(0 0 10px rgba(0, 230, 118, 0.6));
            stroke-dasharray: 15, 10;
            animation: industrialFlow 1.5s linear infinite;
        }

        @keyframes industrialFlow {
            to {
                stroke-dashoffset: -25;
            }
        }

        @keyframes researchPopIn {
            from {
                transform: scale(0.9) translateY(40px);
                opacity: 0;
            }

            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .research-header {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 2px solid rgba(0, 150, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-heading);
            font-size: 2rem;
            color: #E3F2FD;
            text-shadow: 0 2px 10px rgba(0, 150, 255, 0.5);
            letter-spacing: 2px;
        }

        .research-close {
            background: none;
            border: none;
            color: #90CAF9;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .research-close:hover {
            color: #FFF;
            transform: scale(1.1) rotate(90deg);
        }

        .research-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
            background: radial-gradient(circle at center, rgba(0, 150, 255, 0.08) 0%, transparent 75%);
        }

        #research-tree-container {
            position: relative;
            width: 800px;
            height: 520px;
            perspective: 1000px;
            /* Required for 3D flip */
            transform-origin: top left;
            transition: transform 0.3s ease-out;
        }

        .research-node {
            width: 150px;
            height: 100px;
            position: absolute;
            cursor: pointer;
            z-index: 2;
        }

        .research-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .research-node:hover .research-card-inner {
            transform: rotateY(180deg);
        }

        .research-card-front,
        .research-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: 2px solid #37474F;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .research-card-front {
            background: linear-gradient(135deg, #1A2634, #101820);
        }

        .research-card-back {
            background: linear-gradient(135deg, #263238, #1A2634);
            transform: rotateY(180deg);
            font-size: 0.8rem;
            color: #E3F2FD;
            line-height: 1.2;
        }

        .research-node.unlocked .research-card-front,
        .research-node.unlocked .research-card-back {
            border-color: #00E676;
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.3);
        }

        .research-node.locked {
            opacity: 0.7;
            filter: grayscale(0.6);
        }

        .research-node-icon {
            font-size: 2rem;
            margin-bottom: 4px;
        }

        .research-node-name {
            font-family: var(--font-heading);
            font-size: 0.9rem;
            color: #FFF;
            font-weight: bold;
            text-transform: uppercase;
        }

        .research-node-cost {
            font-size: 0.75rem;
            color: #FFD54F;
            margin-top: 5px;
            background: rgba(0, 0, 0, 0.4);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .research-card-back b {
            color: #00E5FF;
            display: block;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-size: 0.7rem;
        }

        /* HIDE OLD TOOLTIP SYSTEM */
        #research-global-tooltip {
            display: none !important;
        }

        .research-node.unlocked::after {
            content: 'âœ“';
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background: #00E676;
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        /* TOOLTIP */
        .research-node .tooltip {
            visibility: hidden;
            width: 180px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: center;
            border-radius: 10px;
            padding: 10px;
            position: absolute;
            z-index: 100;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            border: 1px solid rgba(0, 150, 255, 0.5);
            font-size: 0.8rem;
            pointer-events: none;
        }

        .research-node:hover .tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        /* WORLD CONTAINER */
        #world-container {
            flex: 1;
            position: relative;
            overflow-y: scroll;
            scrollbar-width: none;
            background: #221816;
            display: flex;
            justify-content: center;
        }

        #world-container::-webkit-scrollbar {
            display: none;
        }

        #game-world {
            position: relative;
            width: 100%;
            height: auto;
            /* Dynamic Height */
            min-height: 2000px;
            /* Start with decent size */
            overflow: visible;
            /* Allow content to dictate size */
        }

        /* STAGE: The Fixed Layout Container (1200px) -> NOW FULL WIDTH for BG */
        #game-stage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Make stage cover full expanded world */
            overflow: hidden;
            /* Prevent scrolls from transforms */
        }

        /* NEW WRAPPER: Holds the actual game entities centered */
        .game-content-wrapper {
            position: relative;
            width: 1400px;
            height: 100%;
            margin: 0 auto;
            z-index: 5;
            /* Ensure it stays above night-overlay (4) even with transform stacking context */
        }

        /* ENV */
        .sky-area,
        .mountain-layer,
        .dirt-mask,
        .grass-layer,
        .night-overlay {
            width: 5000px;
            left: 50%;
            margin-left: -2500px;
        }

        .sky-area {
            position: absolute;
            top: 0;
            height: 220px;
            background: linear-gradient(to bottom, #4FC3F7, #B3E5FC);
            z-index: 0;
            border-radius: 0 0 20px 20px;
            overflow: hidden;
            /* ADDED: Clip anything inside the sky area */
        }

        .sky-area::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            width: 100px;
            height: 30px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50px;
            box-shadow: 40px 10px 0 rgba(255, 255, 255, 0.6), 90px 5px 0 rgba(255, 255, 255, 0.6);
            filter: blur(2px);
        }

        .dirt-mask {
            position: absolute;
            top: 200px;
            height: 5000px;
            /* Long enough for scrolling */
            background-color: var(--bg-ground-dark);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.03) 2px, transparent 2px),
                radial-gradient(circle at 30% 50%, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                radial-gradient(circle at 70% 30%, rgba(255, 255, 255, 0.03) 2px, transparent 2px),
                radial-gradient(circle at 90% 80%, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            z-index: 1;
        }

        .grass-layer {
            position: absolute;
            top: 180px;
            height: 40px;
            background: linear-gradient(to bottom, #43A047, #2E7D32);
            z-index: 3;
            border-bottom: 5px solid #1B5E20;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        }

        /* Realistic Tree Silhouettes - Background */
        .grass-layer::after {
            content: '';
            position: absolute;
            top: -30px;
            left: 0;
            width: 100%;
            height: 30px;
            background-image:
                /* Tree trunks */
                radial-gradient(ellipse 8px 25px at 5% 100%, #1B5E20 40%, transparent 40%),
                radial-gradient(ellipse 10px 28px at 15% 100%, #2E7D32 40%, transparent 40%),
                radial-gradient(ellipse 12px 30px at 25% 100%, #1B5E20 40%, transparent 40%),
                radial-gradient(ellipse 8px 24px at 35% 100%, #2E7D32 40%, transparent 40%),
                radial-gradient(ellipse 10px 27px at 45% 100%, #1B5E20 40%, transparent 40%),
                radial-gradient(ellipse 9px 26px at 55% 100%, #2E7D32 40%, transparent 40%),
                radial-gradient(ellipse 11px 29px at 65% 100%, #1B5E20 40%, transparent 40%),
                radial-gradient(ellipse 8px 25px at 75% 100%, #2E7D32 40%, transparent 40%),
                radial-gradient(ellipse 10px 28px at 85% 100%, #1B5E20 40%, transparent 40%),
                radial-gradient(ellipse 9px 27px at 95% 100%, #2E7D32 40%, transparent 40%),
                /* Tree crowns */
                radial-gradient(ellipse 25px 20px at 5% 60%, #43A047 60%, transparent 60%),
                radial-gradient(ellipse 30px 25px at 15% 55%, #388E3C 60%, transparent 60%),
                radial-gradient(ellipse 35px 28px at 25% 50%, #43A047 60%, transparent 60%),
                radial-gradient(ellipse 28px 22px at 35% 58%, #388E3C 60%, transparent 60%),
                radial-gradient(ellipse 32px 26px at 45% 52%, #43A047 60%, transparent 60%),
                radial-gradient(ellipse 30px 24px at 55% 56%, #388E3C 60%, transparent 60%),
                radial-gradient(ellipse 34px 27px at 65% 51%, #43A047 60%, transparent 60%),
                radial-gradient(ellipse 28px 23px at 75% 57%, #388E3C 60%, transparent 60%),
                radial-gradient(ellipse 32px 26px at 85% 53%, #43A047 60%, transparent 60%),
                radial-gradient(ellipse 30px 25px at 95% 55%, #388E3C 60%, transparent 60%);
            background-repeat: repeat-x;
            background-size: 100% 100%;
        }

        /* Foreground Trees - Closer, slightly larger */
        .grass-layer::before {
            content: '';
            position: absolute;
            top: -50px;
            left: 0;
            width: 100%;
            height: 50px;
            z-index: 1;
            background-image:
                /* Foreground tree trunks */
                radial-gradient(ellipse 12px 40px at 10% 100%, #1B5E20 40%, transparent 40%),
                radial-gradient(ellipse 14px 45px at 30% 100%, #2E7D32 40%, transparent 40%),
                radial-gradient(ellipse 13px 42px at 50% 100%, #1B5E20 40%, transparent 40%),
                radial-gradient(ellipse 15px 46px at 70% 100%, #2E7D32 40%, transparent 40%),
                radial-gradient(ellipse 12px 41px at 90% 100%, #1B5E20 40%, transparent 40%),
                /* Foreground tree crowns */
                radial-gradient(ellipse 40px 35px at 10% 50%, #43A047 60%, transparent 60%),
                radial-gradient(ellipse 45px 38px at 30% 48%, #388E3C 60%, transparent 60%),
                radial-gradient(ellipse 42px 36px at 50% 49%, #43A047 60%, transparent 60%),
                radial-gradient(ellipse 48px 40px at 70% 47%, #388E3C 60%, transparent 60%),
                radial-gradient(ellipse 40px 35px at 90% 50%, #43A047 60%, transparent 60%);
            background-repeat: repeat-x;
            background-size: 100% 100%;
        }

        .dirt-mask {
            position: absolute;
            top: 220px;
            /* Below grass(180) + height(40) */
            left: 0;
            width: 100%;
            bottom: 0px;
            /* Dirt Texture Pattern */
            background-color: #5D4037;
            background-image:
                repeating-linear-gradient(45deg, rgba(0, 0, 0, 0.05) 0px, rgba(0, 0, 0, 0.05) 2px, transparent 2px, transparent 10px),
                linear-gradient(to bottom, #3E2723, #5D4037);
            z-index: 2;
        }

        /* MINER SACK LOGIC */
        .miner-carrying-sack .pickaxe {
            display: none;
        }

        .miner-carrying-sack .sack {
            display: block !important;
        }

        .sack {
            display: none;
        }

        .dropped-gear {
            position: absolute;
            top: 100px;
            /* Adjust based on floor */
            width: 40px;
            height: 40px;
            z-index: 5;
            /* Behind miner */
            pointer-events: none;
            transition: opacity 0.2s;
        }

        /* GRID SYSTEM - Relative to WRAPPER now */
        .game-grid {
            position: absolute;
            top: 180px;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr 140px 1fr;
            /* L-SHAFT | ELEV | R-SHAFT (Warehouse sits on top of right side or beyond) */
            z-index: 10;
            /* Ensure auto-placement doesn't break things */
            grid-auto-flow: dense;
            pointer-events: none;
            /* KEY FIX: Let clicks pass through grid holes to Warehouse */
        }

        .game-grid>* {
            pointer-events: auto;
            /* KEY FIX: Enable clicks on Shafts, Elevator, Buttons inside grid */
        }

        /* ELEVATOR */
        .elevator-shaft {
            background: #263238;
            border-left: 6px solid #192024;
            border-right: 6px solid #192024;
            position: relative;
            height: 100%;
            box-shadow: inset 0 0 20px black;

            /* FORCE GRID PLACEMENT */
            grid-column: 2;
            grid-row: 1 / span 5;
            /* Reduced span to avoid stretching usage */
        }

        .elevator-rail {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #555;
            transform: translateX(-50%);
            border-left: 1px solid #777;
        }

        .elevator-cable {
            position: absolute;
            top: 0;
            left: 50%;
            width: 12px;
            height: 10px;
            /* Chain Look */
            background:
                repeating-linear-gradient(0deg, #37474F 0px, #37474F 5px, #192024 5px, #192024 10px),
                repeating-linear-gradient(90deg, transparent 0px, transparent 4px, #455A64 4px, #455A64 8px);
            z-index: 19;
            transform: translateX(-50%);
            transform-origin: top;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.6);
            border-left: 2px solid #192024;
            border-right: 2px solid #192024;
        }

        .elevator-cabin {
            position: absolute;
            width: 110px;
            height: 100px;
            left: 9px;
            z-index: 20;
            transition: top 0.1s linear, filter 0.3s;
            /* Sub-pixel smoothness */
            will-change: top;
        }

        /* --- PULLEY STYLES --- */
        .elevator-pulley {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 21;
            /* Above cable */
            pointer-events: none;
            width: 100px;
            height: 60px;
        }

        .pulley-gear-large {
            fill: #455A64;
            stroke: #263238;
            stroke-width: 1.5;
            transform-origin: center;
        }

        .pulley-gear-small {
            fill: #607D8B;
            stroke: #263238;
            stroke-width: 1;
            transform-origin: center;
        }

        .pulley-teeth {
            fill: #263238;
        }

        .elevator-shaft.moving .pulley-gear-large {
            animation: gearSpin 2s infinite linear;
        }

        .elevator-shaft.moving .pulley-gear-small {
            animation: gearSpinReverse 0.8s infinite linear;
        }

        @keyframes gearSpin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @keyframes gearSpinReverse {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(-360deg);
            }
        }

        /* --- MODERN INDUSTRIAL CABIN --- */
        .elevator-cabin.moving {
            animation: cabinVibrate 0.1s infinite alternate ease-in-out;
        }

        @keyframes cabinVibrate {
            0% {
                transform: translate(-0.5px, 0);
            }

            100% {
                transform: translate(0.5px, 0.5px);
            }
        }

        .cabin-metal-base {
            fill: #263238;
            stroke: #192024;
            stroke-width: 3;
        }

        .cabin-rivet {
            fill: #455A64;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 0.5;
        }

        .cabin-window {
            fill: rgba(0, 150, 255, 0.1);
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 1;
            backdrop-filter: blur(2px);
        }

        .cabin-window-reflection {
            fill: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
        }

        .elevator-fill {
            position: absolute;
            bottom: 12px;
            left: 20px;
            right: 20px;
            background: linear-gradient(45deg, #FFD54F, #FFB300);
            opacity: 1;
            height: 0;
            transition: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 50px;
            border: 1px solid #B68A00;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4), inset 0 2px 5px rgba(255, 255, 255, 0.3);
            border-radius: 2px 2px 0 0;
            z-index: 5;
        }

        .operator-anim {
            animation: opIdle 2s infinite ease-in-out;
            transform-origin: bottom center;
        }

        @keyframes opIdle {

            0%,
            100% {
                transform: scaleY(1);
            }

            50% {
                transform: scaleY(1.05);
            }
        }

        /* --- ELEVATOR LEVER ANIMATIONS --- */
        .control-lever,
        .operator-anim .arm-r {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-box: view-box;
            /* Use global coordinates for origin */
        }

        /* Set explicit origins to match SVG placement */
        .control-lever {
            transform-origin: 62px 55px;
        }

        .operator-anim .arm-r {
            transform-origin: 50px 48px;
        }

        /* State: Moving UP (Push Lever Forward/Right) */
        .elevator-cabin.move-up .control-lever {
            transform: rotate(10deg);
        }

        .elevator-cabin.move-up .operator-anim .arm-r {
            transform: rotate(-50deg) !important;
            /* Gentle push */
        }

        /* State: Moving DOWN (Pull Lever Back/Left) */
        .elevator-cabin.move-down .control-lever {
            transform: rotate(-10deg);
        }

        .elevator-cabin.move-down .operator-anim .arm-r {
            transform: rotate(-30deg) !important;
            /* Gentle pull */
        }

        /* SHAFTS */
        .shaft-container {
            display: flex;
            flex-direction: column;
            padding-top: 30px;
            gap: 20px;
        }

        .mine-shaft {
            height: 160px;
            /* DEEP CAVE BACKGROUND - Rough Stone Texture */
            background-color: #3E2723;
            background-image:
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.05) 0%, transparent 60%),
                repeating-radial-gradient(circle at 10% 10%, rgba(0, 0, 0, 0.2) 0px, transparent 10px),
                repeating-radial-gradient(circle at 90% 90%, rgba(0, 0, 0, 0.2) 0px, transparent 10px),
                linear-gradient(to bottom, #2d1d1a, #3E2723, #1a100e);
            border-radius: 12px;
            position: relative;
            margin-right: -6px;
            border: 8px solid #1a0f0d;
            border-left: 12px solid #5D4037;
            /* Pseudo-3D effect on left wall */
            box-shadow:
                inset 0 0 80px rgba(0, 0, 0, 0.9),
                inset 10px 10px 30px rgba(0, 0, 0, 0.7),
                0 10px 30px rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        /* Pillars / Supports */
        .mine-shaft::before {
            content: '';
            position: absolute;
            left: 50px;
            top: 0;
            bottom: 0;
            width: 20px;
            background: repeating-linear-gradient(90deg, #5D4037, #4E342E 2px, #3E2723 4px);
            box-shadow: 5px 0 10px rgba(0, 0, 0, 0.6), inset 2px 0 2px rgba(255, 255, 255, 0.1);
            z-index: 1;
        }

        /* Second Pillar */
        .mine-shaft::after {
            content: '';
            position: absolute;
            left: 300px;
            top: 0;
            bottom: 0;
            width: 20px;
            background: repeating-linear-gradient(90deg, #5D4037, #4E342E 2px, #3E2723 4px);
            box-shadow: 5px 0 10px rgba(0, 0, 0, 0.6), inset 2px 0 2px rgba(255, 255, 255, 0.1);
            z-index: 1;
        }

        .shaft-tunnel {
            position: absolute;
            left: 100px;
            top: 20px;
            width: 480px;
            height: 70px;
            /* DEEP EARTH TEXTURE */
            background-color: #2C1810;
            background-image:
                /* Rough Spots */
                repeating-radial-gradient(circle at 10% 10%, rgba(0, 0, 0, 0.2) 0px, transparent 8px),
                repeating-radial-gradient(circle at 90% 90%, rgba(0, 0, 0, 0.1) 0px, transparent 12px),
                /* Horizontal Rock Strata */
                linear-gradient(to right, transparent, rgba(0, 0, 0, 0.05) 50%, transparent),
                /* Base Tunnel Gradient */
                linear-gradient(to bottom, #2C1810, #1A0F0A);
            background-size: 40px 40px, 60px 60px, 100% 100%, 100% 100%;
            box-shadow:
                inset 0 8px 15px rgba(0, 0, 0, 1),
                /* Deep top shadow */
                inset 0 -4px 6px rgba(121, 85, 72, 0.05);
            border-radius: 8px;
            border: 2px solid #140b07;
        }

        /* Wooden Support Beams - More Realistic */
        .shaft-tunnel::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 100px;
            width: 14px;
            height: calc(100% + 10px);
            background: linear-gradient(to right, #5D4037, #795548, #5D4037);
            box-shadow:
                inset 2px 0 4px rgba(0, 0, 0, 0.4),
                inset -2px 0 4px rgba(0, 0, 0, 0.3),
                2px 0 6px rgba(0, 0, 0, 0.5);
            border-radius: 2px;
            border: 1px solid #3E2723;
        }

        .shaft-tunnel::after {
            content: '';
            position: absolute;
            top: -5px;
            left: 300px;
            width: 14px;
            height: calc(100% + 10px);
            background: linear-gradient(to right, #5D4037, #795548, #5D4037);
            box-shadow:
                inset 2px 0 4px rgba(0, 0, 0, 0.4),
                inset -2px 0 4px rgba(0, 0, 0, 0.3),
                2px 0 6px rgba(0, 0, 0, 0.5);
            border-radius: 2px;
            border: 1px solid #3E2723;
        }

        /* 3D FLOOR FOR MINE SHAFT */
        /* 3D FLOOR FOR MINE SHAFT WITH RAILS */
        .shaft-floor {
            position: absolute;
            bottom: 0;
            left: 70px;
            /* Start after first pillarish area */
            right: 0;
            height: 60px;
            background: #251b19;
            /* Darker dirt base */
            transform: perspective(300px) rotateX(40deg);
            transform-origin: bottom;
            pointer-events: none;
            z-index: 2;
            border-top: 2px solid #150f0e;
        }

        /* Sleepers (Wooden planks) */
        .shaft-floor::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(90deg,
                    transparent,
                    transparent 40px,
                    #3E2723 40px,
                    #3E2723 50px,
                    rgba(0, 0, 0, 0.5) 50px,
                    rgba(0, 0, 0, 0.5) 52px);
            opacity: 0.8;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
        }

        /* Rails (Iron Bars) */
        .shaft-floor::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 20px;
            /* Two rails */
            border-top: 4px solid #78909C;
            border-bottom: 4px solid #78909C;
            box-shadow:
                0 -1px 0 #37474F,
                /* Depth for top rail */
                0 5px 2px rgba(0, 0, 0, 0.5);
            /* Shadow */
        }

        .shaft-level-box {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 30;
        }

        /* BUTTONS - 3D STYLE */
        .btn-upgrade-simple {
            background: linear-gradient(to bottom, #66BB6A, #43A047);
            border: none;
            border-bottom: 4px solid #2E7D32;
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-transform: uppercase;
            font-size: 0.9rem;
            transition: all 0.1s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 0 rgba(0, 0, 0, 0.3);
        }

        .btn-upgrade-simple:active {
            transform: translateY(3px);
            border-bottom-width: 1px;
            box-shadow: none;
        }

        .btn-upgrade-simple:disabled {
            background: #B0BEC5;
            border-bottom: 4px solid #78909C;
            cursor: not-allowed;
            transform: none;
        }

        /* EXTREME INDUSTRIAL BIN BOX */
        .bin-box {
            position: absolute;
            left: 135px;
            /* Slightly adjusted for wider stance */
            bottom: 25px;
            width: 80px;
            height: 55px;
            /* Industrial Dark Metal Base */
            background:
                /* Rivets/Bolts Pattern */
                radial-gradient(circle at 6px 6px, #cfd8dc 2px, transparent 2.5px),
                radial-gradient(circle at 74px 6px, #cfd8dc 2px, transparent 2.5px),
                radial-gradient(circle at 6px 49px, #cfd8dc 2px, transparent 2.5px),
                radial-gradient(circle at 74px 49px, #cfd8dc 2px, transparent 2.5px),
                /* Vertical Ribs */
                linear-gradient(90deg, transparent 20px, rgba(0, 0, 0, 0.4) 20px, rgba(0, 0, 0, 0.4) 22px, rgba(255, 255, 255, 0.1) 22px, rgba(255, 255, 255, 0.1) 23px, transparent 23px),
                linear-gradient(90deg, transparent 58px, rgba(0, 0, 0, 0.4) 58px, rgba(0, 0, 0, 0.4) 60px, rgba(255, 255, 255, 0.1) 60px, rgba(255, 255, 255, 0.1) 61px, transparent 61px),
                /* Base Metal Gradient */
                linear-gradient(to bottom, #455A64, #263238);

            border: 2px solid #263238;
            border-top: 4px solid #546E7A;
            /* Reinforced Rim */
            border-bottom: 4px solid #1c252a;
            /* Heavy Base */
            border-radius: 4px 4px 8px 8px;

            box-shadow:
                inset 0 0 15px rgba(0, 0, 0, 0.8),
                /* Deep inner shadow */
                0 5px 10px rgba(0, 0, 0, 0.6);
            /* Drop shadow */

            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 5;
            overflow: hidden;
        }

        /* RIGHT SIDE OVERRIDES */
        .right-side .bin-box {
            left: auto;
            right: 135px;
        }

        .right-side.mine-shaft {
            border-left: 8px solid #1a0f0d;
            border-right: 12px solid #5D4037;
            box-shadow:
                inset 0 0 80px rgba(0, 0, 0, 0.9),
                inset -10px 10px 30px rgba(0, 0, 0, 0.7),
                0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .right-side .rock-face {
            left: 0;
            right: auto;
            border-left: 0;
            border-right: 0;
            border-radius: 0 40% 40% 0 / 0 50% 50% 0;
        }

        .right-side .shaft-level-box {
            left: 20px !important;
            right: auto !important;
        }

        .right-side .pos-shaft-manager {
            right: 20px;
            left: auto;
        }

        .right-side .worker-badge {
            left: -10px !important;
            right: auto !important;
        }

        /* Mirrored Pillars / Supports */
        .right-side.mine-shaft::before {
            left: auto;
            right: 50px;
        }

        .right-side.mine-shaft::after {
            left: auto;
            right: 300px;
        }

        .right-side .shaft-tunnel::before {
            left: auto;
            right: 100px;
        }

        .right-side .shaft-tunnel::after {
            left: auto;
            right: 300px;
        }

        .right-side .shaft-floor {
            left: 0;
            right: 70px;
            transform: perspective(300px) rotateX(40deg);
        }

        /* Centering Shafts relative to their grid cells */
        #shafts-anchor {
            justify-self: end;
        }

        #shafts-right-anchor {
            justify-self: start;
        }

        /* Ensure shafts don't shrink */
        .mine-shaft {
            width: 600px;
        }

        /* Hazard Stripes Frame at Bottom */
        .bin-box::before {
            content: '';
            position: absolute;
            bottom: 0px;
            left: 0;
            width: 100%;
            height: 8px;
            background: repeating-linear-gradient(45deg,
                    #FFD600,
                    #FFD600 5px,
                    #212121 5px,
                    #212121 10px);
            border-top: 2px solid #263238;
            opacity: 1;
            z-index: 10;
        }

        /* Metallic Sheen Overlay */
        .bin-box::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, transparent 40%, transparent 60%, rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
            z-index: 11;
        }

        /* Status Light */
        .bin-status-light {
            position: absolute;
            top: 6px;
            right: 15px;
            /* Between ribs */
            width: 6px;
            height: 6px;
            background: #00E676;
            border-radius: 50%;
            box-shadow: 0 0 5px #00E676;
            animation: binPulse 2s infinite;
            z-index: 12;
        }

        @keyframes binPulse {
            0% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
                box-shadow: 0 0 8px #00E676;
            }

            100% {
                opacity: 0.5;
            }
        }

        .bin-resource {
            width: 90%;
            background:
                repeating-linear-gradient(45deg,
                    #FFD54F,
                    #FFD54F 6px,
                    #FFC107 6px,
                    #FFC107 12px),
                radial-gradient(circle at 30% 30%, #FFEB3B, #FFA000);
            height: 0%;
            transition: height 0.3s ease-out;
            border-radius: 3px 3px 0 0;
            box-shadow:
                0 0 15px rgba(255, 193, 7, 0.8),
                0 0 25px rgba(255, 193, 7, 0.4),
                inset 0 2px 5px rgba(255, 235, 59, 0.5);
            position: relative;
        }

        .bin-resource::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30%;
            background: linear-gradient(to bottom, rgba(255, 235, 59, 0.6), transparent);
            border-radius: 3px 3px 0 0;
        }

        .rock-face {
            position: absolute;
            right: 0;
            top: 5px;
            bottom: 5px;
            width: 100px;
            /* Beefier vein */
            background:
                /* Cracks */
                radial-gradient(circle at 30% 20%, rgba(0, 0, 0, 0.3) 0%, transparent 20%),
                radial-gradient(circle at 70% 80%, rgba(0, 0, 0, 0.3) 0%, transparent 20%),
                /* Gold Veins */
                repeating-linear-gradient(115deg, transparent, transparent 20px, rgba(255, 215, 0, 0.3) 22px, pixelated),
                /* Rock Texture */
                linear-gradient(135deg, #4E342E, #2d1d1a);

            border-left: 0;
            border-radius: 40% 0 0 40% / 50% 0 0 50%;
            /* Rough shape */
            box-shadow:
                inset 10px 0 20px rgba(0, 0, 0, 0.6),
                /* Inner depth */
                -5px 0 15px rgba(0, 0, 0, 0.5);
            /* Drop shadow */
            z-index: 3;
            overflow: hidden;
        }

        /* Gold Sparkles embedded */
        .rock-face::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                radial-gradient(2px 2px at 20px 30px, #FFD54F, rgba(0, 0, 0, 0)),
                radial-gradient(2px 2px at 40px 70px, #FFD54F, rgba(0, 0, 0, 0)),
                radial-gradient(3px 3px at 60px 40px, #FFC107, rgba(0, 0, 0, 0)),
                radial-gradient(2px 2px at 80px 80px, #FFA000, rgba(0, 0, 0, 0));
            background-repeat: repeat;
            opacity: 0.8;
            filter: drop-shadow(0 0 2px #FFC107);
        }

        /* --- TORCH SYSTEM --- */
        .torch {
            position: absolute;
            top: -5px;
            width: 12px;
            height: 35px;
            z-index: 10;
            pointer-events: none;
            transform-origin: center bottom;
        }

        .torch-stick {
            position: absolute;
            bottom: 0;
            left: 4px;
            width: 5px;
            height: 22px;
            background: linear-gradient(to right, #3E2723, #5D4037, #3E2723);
            border-radius: 2px;
            transform: rotate(-12deg);
            box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .torch-flame {
            position: absolute;
            top: -5px;
            left: -2px;
            width: 14px;
            height: 20px;
            background: radial-gradient(circle at center bottom, #FFF 10%, #FFD600 40%, #FF6F00 70%, transparent 90%);
            border-radius: 50% 50% 20% 20%;
            filter: blur(1px);
            animation: flameFlicker 0.1s infinite alternate ease-in-out;
            transform-origin: center bottom;
            opacity: 0.9;
            box-shadow: 0 0 10px #FF6F00;
        }

        .torch-glow {
            position: absolute;
            top: -60px;
            left: -65px;
            width: 140px;
            height: 140px;
            background: radial-gradient(circle, rgba(255, 100, 0, 0.3) 0%, rgba(150, 50, 0, 0.1) 55%, transparent 75%);
            animation: glowPulse 2s infinite alternate ease-in-out;
            mix-blend-mode: screen;
            z-index: -1;
        }

        @keyframes flameFlicker {
            0% {
                transform: scale(1, 1) rotate(-3deg) skewX(-2deg);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.15, 0.9) rotate(3deg) skewX(2deg);
                opacity: 1;
            }

            100% {
                transform: scale(0.9, 1.2) rotate(-2deg) skewX(-1deg);
                opacity: 0.85;
            }
        }

        @keyframes glowPulse {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }

            100% {
                transform: scale(1.3);
                opacity: 1;
            }
        }

        /* CHARACTERS */
        .character-transporter {
            position: absolute;
            width: 100px;
            height: 100px;
            pointer-events: none;
            z-index: 10;
            transition: left 0.1s linear;
        }

        .character-container {
            position: absolute;
            width: 100px;
            height: 100px;
            pointer-events: none;
            z-index: 40;
            transition: left 0.1s linear;
        }

        .character-container {
            bottom: 5px;
        }



        /* Transporter Y: Grass (180) - CartHeightOffset + Pad ~ 110px from Top of Stage */
        .character-transporter {
            top: 110px;
        }

        /* Animation classes */
        .anim-walk .leg-l {
            animation: walkLegL 0.6s infinite linear;
        }

        .anim-walk .leg-r {
            animation: walkLegR 0.6s infinite linear;
        }

        .anim-walk .arm-l {
            animation: walkArm 0.6s infinite linear;
        }

        .anim-walk .arm-r {
            animation: walkArm 0.6s infinite linear reverse;
        }

        .anim-mine .torso {
            animation: mineTorso 0.6s infinite ease-in-out;
        }

        .anim-mine .arm-r {
            animation: minePickaxe 0.6s infinite ease-in-out;
        }

        @keyframes walkLegL {
            0% {
                transform: rotate(25deg);
            }

            50% {
                transform: rotate(-25deg);
            }

            100% {
                transform: rotate(25deg);
            }
        }

        @keyframes walkLegR {
            0% {
                transform: rotate(-25deg);
            }

            50% {
                transform: rotate(25deg);
            }

            100% {
                transform: rotate(-25deg);
            }
        }

        @keyframes walkArm {
            0% {
                transform: rotate(20deg);
            }

            50% {
                transform: rotate(-20deg);
            }

            100% {
                transform: rotate(20deg);
            }
        }

        @keyframes mineHit {

            0%,
            100% {
                transform: rotate(20deg);
            }

            50% {
                transform: rotate(-45deg);
            }
        }

        /* WAREHOUSE CART WOBBLE */
        .cart-wobble {
            animation: cartWobble 0.4s infinite ease-in-out;
        }

        @keyframes cartWobble {

            0%,
            100% {
                transform: translate(0, 35px) rotate(0deg);
            }

            25% {
                transform: translate(0, 34px) rotate(1deg);
            }

            75% {
                transform: translate(0, 36px) rotate(-1deg);
            }
        }

        .pushing-lean {
            transform: rotate(-15deg);
            transform-origin: bottom center;
        }

        /* SITTING ANIMATION (Resting) */
        .anim-sit .torso {
            transform: translateY(15px) rotate(-10deg) !important;
            transition: transform 0.5s ease;
        }

        /* WORKING MOOD (Smile) */
        .working-mood .miner-smile {
            opacity: 1 !important;
        }

        .working-mood .miner-moustache {
            opacity: 0 !important;
        }

        .anim-sit .leg-l {
            transform: rotate(-90deg) !important;
            transition: transform 0.5s ease;
        }

        .anim-sit .leg-r {
            transform: rotate(-90deg) !important;
            transition: transform 0.5s ease;
        }

        .anim-sit .pickaxe {
            opacity: 0;
            /* Hide pickaxe when sitting */
        }

        @keyframes mineTorso {

            0%,
            100% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(15deg);
            }
        }

        @keyframes minePickaxe {

            0%,
            100% {
                transform: rotate(20deg);
            }

            45% {
                transform: rotate(-85deg) translate(-10px, -10px);
            }

            /* Strike Forward and High */
            60% {
                transform: rotate(-90deg) translate(-12px, -12px);
            }

            /* Impact peak */
        }

        .float-text {
            position: absolute;
            color: #FFD54F;
            font-family: var(--font-heading);
            font-size: 1.8rem;
            text-shadow: 2px 2px 0 #000;
            pointer-events: none;
            animation: floatUp 1s cubic-bezier(0.23, 1, 0.32, 1) forwards;
            z-index: 5000;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(0.8);
                opacity: 0;
            }

            20% {
                opacity: 1;
                transform: translateY(-20px) scale(1.2);
            }

            100% {
                transform: translateY(-80px) scale(1);
                opacity: 0;
            }
        }

        /* --- SHOP & SETTINGS STYLES --- */
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .shop-item {
            background: linear-gradient(135deg, #37474F, #263238);
            border: 3px solid #455A64;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shop-item:hover {
            transform: scale(1.05);
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.4);
        }

        .shop-item.boost-active {
            border-color: #00E676;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.5);
            animation: boostPulse 1s infinite;
        }

        @keyframes boostPulse {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(0, 230, 118, 0.5);
            }

            50% {
                box-shadow: 0 0 25px rgba(0, 230, 118, 0.8);
            }
        }

        .shop-item-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .shop-item-name {
            font-family: var(--font-heading);
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .shop-item-price {
            color: #69F0AE;
            font-weight: bold;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: #ccc;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.on {
            background: #7CB342;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.on::after {
            left: 26px;
        }

        .btn-danger {
            background: linear-gradient(to bottom, #E53935, #B71C1C);
            border-bottom-color: #7F0000;
        }

        /* --- PULSING AFFORDABLE BUTTON -> NOW GENTLE WIGGLE --- */
        .btn-affordable {
            animation: gentleWiggle 2s infinite ease-in-out;
            box-shadow: 0 0 15px rgba(139, 195, 74, 0.6);
            /* Soft glow remains */
        }

        @keyframes gentleWiggle {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-1.5deg);
            }

            75% {
                transform: rotate(1.5deg);
            }
        }

        /* --- MINING PARTICLES --- */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 100;
            animation: particleFall 0.8s ease-out forwards;
        }

        @keyframes particleFall {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translate(var(--px), var(--py)) scale(0.3);
            }
        }

        /* --- ANIMATED CLOUDS --- */
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50px;
            filter: blur(3px);
            animation: cloudDrift linear infinite;
        }

        @keyframes cloudDrift {
            from {
                transform: translateX(-200px);
            }

            to {
                transform: translateX(1400px);
            }
        }

        /* --- SPARKLE EFFECT --- */
        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #FFD54F;
            border-radius: 50%;
            animation: sparkle 1.5s infinite;
            pointer-events: none;
        }

        @keyframes sparkle {

            0%,
            100% {
                opacity: 0;
                transform: scale(0);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* --- WELCOME BACK POPUP --- */
        .welcome-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1E88E5, #1565C0);
            border: 4px solid #fff;
            border-radius: 20px;
            padding: 30px 50px;
            text-align: center;
            z-index: 5000;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .welcome-popup h2 {
            font-family: var(--font-heading);
            margin: 0 0 10px;
            font-size: 2rem;
        }

        .welcome-earnings {
            font-size: 2.5rem;
            color: #FFD54F;
            font-family: var(--font-heading);
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
        }

        .welcome-popup button {
            margin-top: 20px;
            padding: 12px 40px;
            font-size: 1.2rem;
        }

        /* FLYING COINS */
        .flying-coin {
            position: fixed;
            width: 18px;
            height: 18px;
            background: radial-gradient(circle at 30% 30%, #FFF59D, #FFD54F, #FF6F00);
            border: 2px solid #fff;
            border-radius: 40% 60% 50% 50%;
            z-index: 10000;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(255, 213, 79, 1), 0 0 40px rgba(255, 111, 0, 0.5);
            filter: brightness(1.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .flying-coin::after {
            content: '';
            position: absolute;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 140%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, transparent 60%);
            opacity: 0.5;
            animation: sparklePulse 0.4s infinite alternate;
        }

        @keyframes sparklePulse {
            from {
                opacity: 0.2;
                transform: scale(0.8);
            }

            to {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        /* MINING SPARKS */
        .mining-spark {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FFF59D;
            border-radius: 50%;
            box-shadow: 0 0 8px #FFF176;
            z-index: 9999;
            pointer-events: none;
            animation: sparkOut 0.4s ease-out forwards;
        }

        @keyframes sparkOut {
            0% {
                transform: scale(1) translate(0, 0);
                opacity: 1;
            }

            100% {
                transform: scale(0) translate(var(--sx), var(--sy));
                opacity: 0;
            }
        }

        @keyframes coinSpin {
            0% {
                transform: scaleX(1);
            }

            50% {
                transform: scaleX(0.1);
            }

            100% {
                transform: scaleX(1);
            }
        }

        /* --- DAY_NIGHT CYCLE & LIGHTING --- */
        .night-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000015;
            /* Deep dark blue */
            opacity: 0;
            /* Starts Day */
            pointer-events: none;
            z-index: 4;
            /* Above BG (Grass is 2), Below Game (Wh is 5) */
            transition: opacity 2s linear;
            mix-blend-mode: multiply;
            /* Better darkening */
            height: 5000px;
        }

        /* LIGHT SOURCES (Only visible when overlay opacity > 0) */
        /* Use mix-blend-mode or simple opacity tricks.
           Since overlay is multiply, anything below is dark.
           To "light up" something below, we need to cut a hole in the overlay (hard with many moving lights).

           Alt Approach: Lights are transparent divs with a radial gradient GLOW that adds color/light ON TOP of the dark overlay.
           Z-Index: Overlay = 100. Lights = 101.
           Light Blend Mode: screen or overlay.
        */

        .light-source {
            position: absolute;
            pointer-events: none;
            z-index: 101;
            /* Above darkness */
            background: radial-gradient(circle, rgba(255, 220, 100, 0.6) 0%, rgba(255, 180, 50, 0.2) 40%, transparent 70%);
            opacity: 0;
            transition: opacity 2s;
            mix-blend-mode: screen;
            /* Additive light */
        }

        .miner-light {
            width: 120px;
            height: 120px;
            left: -60px;
            /* Center on miner */
            top: -60px;
            background: radial-gradient(circle, rgba(255, 255, 200, 0.8) 0%, rgba(255, 255, 200, 0.1) 50%, transparent 70%);
            transform-origin: center;
        }

        .elevator-light {
            width: 200px;
            height: 300px;
            background: radial-gradient(ellipse at top, rgba(255, 255, 255, 0.7) 0%, rgba(200, 200, 255, 0.1) 60%, transparent 80%);
            top: 60px;
            left: -55px;
            /* Adjust to center on cabin */
            /* Clip path to look like a cone? */
            clip-path: polygon(40% 0%, 60% 0%, 100% 100%, 0% 100%);
        }

        .warehouse-window-glow {
            position: absolute;
            background: #FFD54F;
            box-shadow: 0 0 20px #FFC107;
            opacity: 0;
            transition: opacity 2s;
            z-index: 102;
        }

        .mountain-layer {
            position: absolute;
            bottom: -20px;
            width: 100%;
            height: 500px;
            z-index: 1;
            background-repeat: repeat-x;
            background-size: 1100px 100%;
            /* Realistic Blue Mountains - High Contrast with brown dirt */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 400' preserveAspectRatio='none'%3E%3Cdefs%3E%3ClinearGradient id='far' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%231565C0;stop-opacity:0.4' /%3E%3Cstop offset='100%25' style='stop-color:%231E88E5;stop-opacity:0.6' /%3E%3C/linearGradient%3E%3ClinearGradient id='mid' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%230D47A1;stop-opacity:0.7' /%3E%3Cstop offset='100%25' style='stop-color:%231565C0;stop-opacity:0.9' /%3E%3C/linearGradient%3E%3ClinearGradient id='near' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2301579B;stop-opacity:0.9' /%3E%3Cstop offset='100%25' style='stop-color:%23002f5c;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3C!-- Realistic Jagged Layers --%3E%3Cpath d='M0 400 L120 180 L250 320 L400 120 L600 350 L800 150 L1000 400 Z' fill='url(%23far)' /%3E%3Cpath d='M-50 400 L150 220 L350 380 L550 180 L750 360 L950 200 L1100 400 Z' fill='url(%23mid)' /%3E%3Cpath d='M-30 400 L180 140 L380 340 L620 100 L880 380 L1020 160 L1050 400 Z' fill='url(%23near)' /%3E%3C!-- Sharp Snow Caps --%3E%3Cpath d='M180 140 L140 200 Q180 185 220 200 Z' fill='%23E1F5FE' opacity='0.7' /%3E%3Cpath d='M620 100 L570 180 Q620 160 670 180 Z' fill='white' opacity='0.8' /%3E%3Cpath d='M1020 160 L980 220 Q1020 205 1060 220 Z' fill='%23B3E5FC' opacity='0.6' /%3E%3C/svg%3E");
            filter: drop-shadow(0 -10px 20px rgba(0, 0, 0, 0.3));
        }

        .fossil {
            position: absolute;
            font-size: 24px;
            opacity: 0.2;
            pointer-events: none;
            filter: grayscale(100%) contrast(50%);
            transform-origin: center;
        }

        .bird {
            position: absolute;
            width: 12px;
            height: 6px;
            background: #1a1a1a;
            /* Body color */
            border-radius: 50%;
            /* Teardrop body */
            animation: birdFly 20s linear infinite, birdBob 1.2s ease-in-out infinite;
            top: 50px;
            opacity: 0.9;
            z-index: 3;
            pointer-events: none;
            /* Small head detail */
            box-shadow: -3px -1px 0 -1px #1a1a1a;
        }

        .eagle::before,
        .eagle::after {
            content: '';
            position: absolute;
            top: -8px;
            /* High wing mount */
            width: 25px;
            height: 15px;
            background: #1a1a1a;
            /* Realistic biological wing profile with primary feathers */
            clip-path: path('M25 15 C 20 12, 12 0, 0 5 C 5 10, 15 15, 25 15 Z');
            animation: wingFlap 1.2s ease-in-out infinite alternate;
        }

        .eagle::before {
            right: 50%;
            /* Center to body */
            transform-origin: right bottom;
        }

        .eagle::after {
            left: 50%;
            transform-origin: left bottom;
            transform: scaleX(-1);
        }

        @keyframes birdBob {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        @keyframes wingFlap {
            0% {
                transform: rotate(35deg) skewX(10deg);
            }

            100% {
                transform: rotate(-45deg) skewX(-5deg);
            }
        }

        @keyframes birdFly {
            0% {
                transform: translateX(-200px) translateY(0) scale(0.6);
            }

            20% {
                transform: translateX(200px) translateY(-40px) scale(0.8);
            }

            40% {
                transform: translateX(600px) translateY(20px) scale(0.7);
            }

            60% {
                transform: translateX(1000px) translateY(-30px) scale(0.9);
            }

            80% {
                transform: translateX(1400px) translateY(30px) scale(0.7);
            }

            100% {
                transform: translateX(2000px) translateY(0) scale(0.6);
            }
        }

        /* --- HELICOPTER STYLES --- */
        .helicopter-entity {
            position: absolute;
            width: 120px;
            height: 60px;
            z-index: 1000;
            cursor: pointer;
            pointer-events: auto;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
            transition: transform 0.1s linear;
        }

        .helicopter-entity:hover {
            filter: drop-shadow(0 8px 20px rgba(255, 213, 79, 0.4)) brightness(1.1);
        }

        .heli-rotor {
            transform-origin: 60px 10px;
            animation: heliSpin 0.1s linear infinite;
        }

        .heli-tail-rotor {
            transform-origin: 10px 30px;
            animation: heliSpin 0.15s linear infinite;
        }

        @keyframes heliMainSpin {
            from {
                transform: rotateY(0deg);
            }

            to {
                transform: rotateY(360deg);
            }
        }

        @keyframes heliTailSpin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .heli-beacon {
            animation: heliBeaconPulse 1s ease-in-out infinite;
        }

        @keyframes heliBeaconPulse {

            0%,
            100% {
                opacity: 0.4;
                filter: brightness(1);
            }

            50% {
                opacity: 1;
                filter: brightness(1.5) drop-shadow(0 0 5px #ff1744);
            }
        }

        .heli-pulse {
            animation: heliPulse 2s ease-in-out infinite;
        }

        @keyframes heliPulse {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.2) drop-shadow(0 0 15px rgba(255, 255, 255, 0.4));
            }
        }

        /* MONSTER INVASION - VISUAL OVERHAUL (FIXED) */
        #monster-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        /* --- HIGH DETAIL BUSHES (Permanent) --- */
        .thief-bush {
            position: absolute;
            width: 120px;
            height: 80px;
            z-index: 0;
            /* Background layer */
            transform-origin: bottom center;
            transform: scale(0.3);
            /* Tiny on horizon */
            filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.5));
            pointer-events: auto;
            /* display: block; Explicitly visible */
        }

        .thief-bush svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        /* Animation when monster is about to spawn */
        .thief-bush.shaking {
            animation: aggressiveShake 0.5s infinite ease-in-out;
        }

        @keyframes aggressiveShake {

            0%,
            100% {
                transform: scale(0.3) rotate(0deg);
            }

            25% {
                transform: scale(0.35) rotate(3deg);
            }

            75% {
                transform: scale(0.35) rotate(-3deg);
            }
        }

        /* --- KOBOLD (GOBLIN) ENTITY - SVG BASED --- */
        /* --- KOBOLD (GOBLIN) ENTITY - SVG BASED --- */
        .monster-entity {
            position: absolute;
            width: 100px;
            height: 100px;
            z-index: 3;
            pointer-events: auto;
            cursor: pointer;
            transition: top 0.1s linear, left 0.1s linear, transform 0.1s linear;
            /* Faster transition for smooth hopping */
            filter: drop-shadow(2px 4px 6px rgba(0, 0, 0, 0.4));
        }

        /* BODY Container - Holds the goblin image */
        .goblin-body {
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3CradialGradient id='skinGrad' cx='50%25' cy='40%25'%3E%3Cstop offset='0%25' style='stop-color:%2389C442;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%23558B2F;stop-opacity:1'/%3E%3C/radialGradient%3E%3ClinearGradient id='bodyGrad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%233E2723;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%231B1614;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3C!-- Shadow --%3E%3Cellipse cx='50' cy='95' rx='35' ry='6' fill='rgba(0,0,0,0.6)' opacity='0.8'/%3E%3C!-- Legs --%3E%3Cpath d='M38 75 Q36 85 38 92 L42 92 Q43 85 40 75 Z' fill='url(%23skinGrad)' stroke='%23558B2F' stroke-width='1'/%3E%3Cpath d='M58 75 Q56 85 58 92 L62 92 Q63 85 60 75 Z' fill='url(%23skinGrad)' stroke='%23558B2F' stroke-width='1'/%3E%3C!-- Feet --%3E%3Cellipse cx='40' cy='93' rx='6' ry='3' fill='%23424242'/%3E%3Cellipse cx='60' cy='93' rx='6' ry='3' fill='%23424242'/%3E%3C!-- Torso --%3E%3Cpath d='M32 45 Q28 55 30 75 L40 75 L50 77 L60 75 L70 75 Q72 55 68 45 Q62 40 50 40 Q38 40 32 45 Z' fill='url(%23bodyGrad)' stroke='%231B1614' stroke-width='1.5'/%3E%3C!-- Vest --%3E%3Cpath d='M35 48 L38 75 L50 76 L62 75 L65 48 Q60 45 50 45 Q40 45 35 48 Z' fill='%235D4037' opacity='0.7' stroke='%23424242' stroke-width='0.5'/%3E%3C!-- Belt --%3E%3Crect x='32' y='70' width='36' height='6' fill='%23795548' stroke='%23424242' stroke-width='0.8' rx='1'/%3E%3Ccircle cx='50' cy='73' r='3' fill='%23FFB300' stroke='%23F57C00' stroke-width='0.5'/%3E%3C!-- Arms --%3E%3Cpath d='M32 48 Q20 52 18 62 Q20 68 28 65 L32 58 Z' fill='url(%23skinGrad)' stroke='%23558B2F' stroke-width='1'/%3E%3Cpath d='M68 48 Q75 50 78 58 L75 62 L70 58 Z' fill='url(%23skinGrad)' stroke='%23558B2F' stroke-width='1'/%3E%3C!-- Head --%3E%3Cellipse cx='50' cy='28' rx='20' ry='18' fill='url(%23skinGrad)' stroke='%23558B2F' stroke-width='1.2'/%3E%3C!-- Ears --%3E%3Cpath d='M30 25 Q18 20 16 28 Q18 35 28 32 Z' fill='%2389C442' stroke='%23558B2F' stroke-width='0.8'/%3E%3Cpath d='M70 25 Q82 20 84 28 Q82 35 72 32 Z' fill='%2389C442' stroke='%23558B2F' stroke-width='0.8'/%3E%3C!-- Face Details --%3E%3Cellipse cx='42' cy='26' rx='5' ry='6' fill='%23FFEB3B' opacity='0.3'/%3E%3Ccircle cx='42' cy='26' r='4' fill='%23FF1744' stroke='%23B71C1C' stroke-width='0.8'/%3E%3Ccircle cx='42' cy='24.5' r='1.5' fill='%23000'/%3E%3Cellipse cx='58' cy='26' rx='5' ry='6' fill='%23FFEB3B' opacity='0.3'/%3E%3Ccircle cx='58' cy='26' r='4' fill='%23FF1744' stroke='%23B71C1C' stroke-width='0.8'/%3E%3Ccircle cx='58' cy='24.5' r='1.5' fill='%23000'/%3E%3Cpath d='M36 22 Q39 19 45 20' stroke='%23424242' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Cpath d='M55 20 Q61 19 64 22' stroke='%23424242' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3Cpath d='M48 30 L47 35 L50 36 L53 35 L52 30 Z' fill='%23689F38' stroke='%23558B2F' stroke-width='0.5'/%3E%3Cpath d='M40 36 Q50 42 60 36' stroke='%23424242' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3Cpath d='M40 36 L42 38 L44 36 L46 38 L48 36 L50 38 L52 36 L54 38 L56 36 L58 38 L60 36' fill='%23FFF' stroke='%23424242' stroke-width='0.5'/%3E%3C!-- Hair --%3E%3Cpath d='M35 15 L33 8 L37 12 L38 6 L40 12 L43 8 L45 13' fill='%23424242' opacity='0.6'/%3E%3Cpath d='M65 15 L67 8 L63 12 L62 6 L60 12 L57 8 L55 13' fill='%23424242' opacity='0.6'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* SEPARATE DRILL ELEMENT */
        .thief-drill {
            position: absolute;
            width: 40px;
            height: 40px;
            right: 15px;
            /* Held in right hand */
            top: 55px;
            /* Hand height */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'%3E%3Cg transform='rotate(-25 20 20)'%3E%3Crect x='15' y='-5' width='10' height='20' fill='%235D4037' rx='2'/%3E%3Crect x='17' y='15' width='6' height='25' fill='%2390A4AE' stroke='%23546E7A'/%3E%3C!-- Screw --%3E%3Cpath d='M17 38 L20 45 L23 38' fill='%23CFD8DC' stroke='%2378909C'/%3E%3Cline x1='17' y1='20' x2='23' y2='25' stroke='%2337474F'/%3E%3Cline x1='17' y1='25' x2='23' y2='30' stroke='%2337474F'/%3E%3Cline x1='17' y1='30' x2='23' y2='35' stroke='%2337474F'/%3E%3C/g%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            transform-origin: center top;
            z-index: 4;
            transition: transform 0.1s;
        }

        /* Running - Waddle Animation */
        .monster-entity.running .goblin-body {
            animation: waddle 0.4s ease-in-out infinite alternate;
        }

        .monster-entity.running .thief-drill {
            animation: drillBob 0.4s ease-in-out infinite alternate;
        }

        @keyframes waddle {
            from {
                transform: rotate(-5deg) translateY(0px);
            }

            to {
                transform: rotate(5deg) translateY(-5px);
            }
        }

        @keyframes drillBob {
            from {
                transform: rotate(0deg) translateY(0px);
            }

            to {
                transform: rotate(10deg) translateY(-5px);
            }
        }

        /* Stealing - Drilling Animation */
        .monster-entity.stealing .thief-drill {
            animation: drillSpin 0.1s linear infinite;
        }

        @keyframes drillSpin {
            0% {
                transform: translateY(2px) rotate(0deg);
            }

            25% {
                transform: translateY(0px) rotate(-5deg);
            }

            50% {
                transform: translateY(2px) rotate(0deg);
            }

            75% {
                transform: translateY(0px) rotate(5deg);
            }

            100% {
                transform: translateY(2px) rotate(0deg);
            }
        }

        /* Running Animation */
        .monster-entity.running {
            animation: goblinRun 0.4s steps(2) infinite;
        }

        @keyframes goblinRun {

            0%,
            100% {
                background-position-y: 0px;
            }

            50% {
                background-position-y: -2px;
            }
        }

        /* Spawning effect */
        .monster-entity.spawning {
            opacity: 0;
            animation: fadeSpawn 0.4s ease-out forwards;
        }

        @keyframes fadeSpawn {
            from {
                opacity: 0;
                filter: blur(3px);
            }

            to {
                opacity: 1;
                filter: blur(0px);
            }
        }

        /* Background Runner Variant */
        .monster-entity.background-runner {
            width: 60px;
            height: 60px;
            z-index: 0;
            filter: blur(0.5px) brightness(0.8);
            pointer-events: none;
            transition: left 2s linear, top 2s linear;
            /* Smooth run */
        }

        /* Hit Effect */
        .monster-entity.hit {
            filter: brightness(2) sepia(1) hue-rotate(-50deg);
        }

        /* COMBAT UI */
        .challenge-ui {
            position: absolute;
            top: 0px;
            left: 20px;
            width: 60px;
            height: 6px;
            background: #212121;
            border: 1px solid #fff;
            display: none;
        }

        .monster-entity:hover .challenge-ui,
        .monster-entity.combat .challenge-ui {
            display: block;
        }

        .hp-bar {
            height: 100%;
            background: #D32F2F;
            width: 100%;
            transition: width 0.1s;
        }

        /* Floating Steal Text */
        .steal-text {
            position: absolute;
            color: #FF5252;
            font-family: var(--font-heading);
            font-weight: bold;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatSteal 1.5s forwards ease-out;
            z-index: 100;
            text-shadow: 2px 2px 0 black;
        }

        @keyframes floatSteal {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-100px) scale(0.5);
                opacity: 0;
            }
        }

        /* RECOVERY POPUP */
        .recovery-popup {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: #69F0AE;
            /* Green */
            border: 2px solid #00E676;
            padding: 10px 20px;
            border-radius: 12px;
            font-family: var(--font-heading);
            font-size: 1.2rem;
            text-align: center;
            pointer-events: none;
            z-index: 500;
            box-shadow: 0 4px 15px rgba(0, 230, 118, 0.4);
            animation: popupFloat 3s forwards ease-out;
            min-width: 200px;
        }

        .recovery-popup .bonus {
            color: #FFD700;
            /* Gold */
            font-size: 1.4rem;
            display: block;
            margin-top: 5px;
            text-transform: uppercase;
            text-shadow: 0 2px 0 #000;
        }

        @keyframes popupFloat {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.8);
            }

            10% {
                opacity: 1;
                transform: translateY(0) scale(1.1);
            }

            20% {
                transform: translateY(0) scale(1);
            }

            80% {
                opacity: 1;
                transform: translateY(-50px);
            }

            100% {
                opacity: 0;
                transform: translateY(-80px);
            }
        }

        /* MOBILE LANDSCAPE OPTIMIZATIONS */
        @media (max-height: 500px) and (orientation: landscape) {
            .hud-bottom {
                height: 60px;
                padding-bottom: 5px;
                gap: 20px;
            }

            .nav-btn div {
                font-size: 20px !important;
            }

            .nav-text {
                font-size: 0.6rem;
            }

            .currency-pill {
                font-size: 1rem;
                min-width: 120px;
                padding: 3px 10px 3px 3px;
                gap: 8px;
            }

            .icon-coin-hud {
                width: 30px;
                height: 30px;
                font-size: 16px;
            }

            .icon-supercash {
                font-size: 18px;
            }

            .hud-top {
                padding: 5px 10px;
            }

            /* --- OVERLAY OPTIMIZATIONS FOR SMALL HEIGHTS --- */
            .popup-header {
                padding: 10px 20px !important;
                font-size: 1.3rem !important;
            }

            .popup-content {
                padding: 12px 20px !important;
            }

            .research-header {
                padding: 10px 25px !important;
                font-size: 1.5rem !important;
            }

            .research-panel {
                border-radius: 20px !important;
            }

            .stats-row {
                margin-bottom: 5px !important;
                padding-bottom: 4px !important;
                font-size: 0.9rem !important;
            }

            .shop-item {
                padding: 8px !important;
            }

            .shop-item-icon {
                font-size: 1.8rem !important;
            }
        }
    </style>
</head>

<body>

    <div id="orientation-warning">
        <i>ðŸ“±</i>
        <h2>Please rotate your phone</h2>
        <p>This game is best played in landscape mode!</p>
    </div>

    <div id="ui-layer">
        <div class="hud-top">
            <div style="display:flex; flex-direction:column; gap:10px;">
                <div class="currency-pill">
                    <div class="icon-coin-hud">$</div><span id="txt-cash">0</span>
                </div>
                <div class="currency-pill" style="border-color: rgba(0,230,118,0.5);">
                    <div class="icon-supercash"></div><span id="txt-supercash" style="color: #69F0AE;">0</span>
                </div>
            </div>

        </div>
        <div class="hud-bottom">
            <div class="btn-toggle-menu" onclick="game.toggleMenu()">Ã—</div>
            <div class="nav-btn active" onclick="game.showMine()">
                <div style="font-size:30px;">â›ï¸</div> <span class="nav-text">MINE</span>
            </div>
            <div class="nav-btn" onclick="game.showMap()">
                <div style="font-size:30px;">ðŸ—ºï¸</div> <span class="nav-text">MAP</span>
            </div>
            <div class="nav-btn" onclick="game.openResearch()" id="btn-research-nav">
                <div style="font-size:30px;">ðŸ§ª</div> <span class="nav-text">RESEARCH</span>
            </div>
            <div class="nav-btn" onclick="game.openShop()" id="btn-shop-nav">
                <div style="font-size:30px;">ðŸ›’</div> <span class="nav-text">SHOP</span>
            </div>
            <div class="nav-btn" onclick="game.openSettings()" id="settings-mobile-btn">
                <div style="font-size:30px;">âš™ï¸</div> <span class="nav-text">SETTINGS</span>
            </div>
        </div>
        <div id="modal-overlay">
            <div class="popup-panel">
                <div class="popup-header"> <span id="popup-title">Title</span> <button class="popup-close"
                        onclick="game.closeModal()">&times;</button> </div>
                <div class="popup-content">
                    <div id="popup-stats"></div> <button id="popup-buy-btn" class="btn-buy-upgrade">Upgrade</button>
                    <div id="popup-balance-msg"
                        style="text-align:center; color:#E53935; margin-top:10px; font-weight:bold; display:none;">Not
                        enough cash!</div>
                </div>
            </div>
        </div>

        <div id="research-overlay">
            <div class="research-panel">
                <div class="research-header">
                    <span>LABORATORY & RESEARCH</span>
                    <button class="research-close" onclick="game.closeResearch()">&times;</button>
                </div>
                <div class="research-content">
                    <!-- Global Tooltip for Research -->
                    <div id="research-global-tooltip"></div>
                    <div id="research-tree-container">
                        <!-- Research Tree Nodes will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN GAME CONTAINER -->
    <div id="world-container">
        <div id="game-world">
            <div id="game-stage">
                <!-- Backgrounds (Full width of stage) -->
                <div class="sky-area">
                    <div class="mountain-layer" id="mountain-bg"></div>
                    <!-- Added very small, majestic eagles to the background -->
                    <div class="bird eagle" style="animation-delay: 0s; top: 40px; left: 100px;"></div>
                    <div class="bird eagle" style="animation-delay: -5s; top: 80px; left: 400px;"></div>
                    <div class="bird eagle" style="animation-delay: -10s; top: 120px; left: 700px;"></div>
                </div>
                <div class="dirt-mask" id="dirt-layer"></div>
                <div class="grass-layer"></div>
                <div class="night-overlay" id="night-overlay"></div>

                <!-- WRAPPER: Holds everything content-related -->
                <div class="game-content-wrapper">
                    <div id="monster-layer"></div>

                    <div id="monster-layer"></div>

                    <!-- Warehouse Visual -->
                    <!-- Lifted up to sit on grass. Grass is at 180px relative to wrapper. top:-20px relative to wrapper? No.
                         Wrapper top starts at 0. Grass is at 180px in stage (absolute). wrapper is relative.
                         If we put wrapper inside stage, wrapper starts at 0,0.
                         Grass is absolute in stage.
                         Wait, if grid starts at 180px (top of dirt), then Warehouse sitting ON grass (180px) should be positioned relative to that?
                         Standard coordinates:
                         Grid top: 180px.
                         Warehouse visual: absolute.
                         Old: top 40px (relative to stage). Grass at 180. 40 is WAY above grass? No.
                         Ah, 180 is where DIRT starts. Grass is AT 180.
                         So 40 was indeed weird.
                         
                         Let's try top: 30px (since visual has some padding/SVG space).
                         User said "Warehouse is in the floor". It needs to go UP.
                         Old: top 40px.
                         New: top 10px?
                         Let's try placing it carefully.
                     -->
                    <!-- Warehouse Visual (BACK INTERIOR LAYER) -->
                    <!-- Positioned to be BEHIND the carts (z-index 5, Carts are in surface-layer which is z-index auto? No, carts have z-index 10) -->
                    <!-- We need to ensure Back Layer < Carts < Front Layer -->
                    <!-- Carts are in #surface-angels-layer. Let's make sure that layer is z-index 10. -->

                    <div class="warehouse-visual"
                        style="position: absolute; top: 20px; left: 1050px; width: 320px; height: 160px; z-index: 5;">
                        <!-- Top 30px: Warehouse is 160h. Grass at 180. 180-160 = 20. Adding a tiny bit more to ensure it sits deep. -->
                        <!-- Ultra-Realistic Warehouse Interior -->
                        <svg width="100%" height="160" viewBox="0 0 320 160" style="overflow:visible;">
                            <!-- Polished Concrete Floor (Perspective) -->
                            <defs>
                                <linearGradient id="floorGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#B0BEC5;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#CFD8DC;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <path d="M0 160 L90 115 L230 115 L320 160 Z" fill="url(#floorGrad)" />
                            <!-- Floor Markings -->
                            <line x1="100" y1="115" x2="0" y2="160" stroke="#FDD835" stroke-width="1" opacity="0.3"
                                stroke-dasharray="5,5" />
                            <line x1="220" y1="115" x2="320" y2="160" stroke="#FDD835" stroke-width="1" opacity="0.3"
                                stroke-dasharray="5,5" />

                            <!-- Back Wall (Loading Dock) -->
                            <rect x="90" y="35" width="140" height="80" fill="#ECEFF1" stroke="#90A4AE"
                                stroke-width="2" />
                            <!-- Dock Door -->
                            <rect x="120" y="50" width="80" height="65" fill="#546E7A" stroke="#37474F"
                                stroke-width="2" />
                            <line x1="120" y1="82" x2="200" y2="82" stroke="#263238" stroke-width="1" />
                            <!-- Handle -->
                            <rect x="155" y="95" width="10" height="8" fill="#F44336" rx="1" />

                            <!-- Perspective Ceiling (White/Grey) -->
                            <path d="M0 0 L90 35 L230 35 L320 0 Z" fill="#FAFAFA" />

                            <!-- Side Walls (Clean Grey) -->
                            <path d="M0 0 L90 35 L90 115 L0 160 Z" fill="#E0E0E0" />
                            <path d="M320 0 L230 35 L230 115 L320 160 Z" fill="#E0E0E0" />

                            <!-- Pallet Racking (Left Side) -->
                            <g opacity="0.9">
                                <rect x="15" y="45" width="60" height="5" fill="#FF6F00" />
                                <rect x="15" y="65" width="60" height="5" fill="#FF6F00" />
                                <rect x="15" y="85" width="60" height="5" fill="#FF6F00" />
                                <!-- Verticals -->
                                <rect x="15" y="45" width="3" height="45" fill="#E65100" />
                                <rect x="37" y="45" width="3" height="45" fill="#E65100" />
                                <rect x="72" y="45" width="3" height="45" fill="#E65100" />
                            </g>

                            <!-- Pallet Racking (Right Side) -->
                            <g opacity="0.9">
                                <rect x="245" y="45" width="60" height="5" fill="#1976D2" />
                                <rect x="245" y="65" width="60" height="5" fill="#1976D2" />
                                <rect x="245" y="85" width="60" height="5" fill="#1976D2" />
                                <!-- Verticals -->
                                <rect x="245" y="45" width="3" height="45" fill="#0D47A1" />
                                <rect x="267" y="45" width="3" height="45" fill="#0D47A1" />
                                <rect x="302" y="45" width="3" height="45" fill="#0D47A1" />
                            </g>

                            <!-- Cargo Boxes on Pallets -->
                            <rect x="20" y="52" width="15" height="12" fill="#8D6E63" stroke="#5D4037" />
                            <rect x="38" y="52" width="15" height="12" fill="#6D4C41" stroke="#5D4037" />
                            <rect x="250" y="72" width="15" height="12" fill="#A1887F" stroke="#5D4037" />
                            <rect x="270" y="72" width="15" height="12" fill="#8D6E63" stroke="#5D4037" />

                            <!-- High-Bay Lights -->
                            <circle cx="80" cy="20" r="4" fill="#FFF9C4" opacity="0.8" />
                            <circle cx="160" cy="20" r="4" fill="#FFF9C4" opacity="0.8" />
                            <circle cx="240" cy="20" r="4" fill="#FFF9C4" opacity="0.8" />
                        </svg>

                        <!-- Upgrade Button Area -->
                        <div
                            style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); text-align:center; z-index: 6;">
                            <button id="btn-wh" class="btn-upgrade-simple" onclick="game.openUpgrade('WH')">Lvl
                                1</button>
                        </div>
                    </div>

                    <!-- Dropoff Zone (Now right of centered elevator at 1400px world) -->
                    <div style="position: absolute; left: 800px; top: 180px; width: 70px; height: 35px; background: #37474F; z-index: 6; border: 3px solid #263238; border-bottom:0; display:flex; flex-direction:column-reverse; align-items:center; box-shadow: 0 5px 10px rgba(0,0,0,0.4); overflow:hidden;"
                        class="glint-effect">
                        <div id="depot-fill"
                            style="width:100%; background:var(--gold-gem-gradient); opacity:1; height:0%; transition:height 0.2s; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);">
                        </div>
                    </div>

                    <!-- Transporter Layer -->
                    <div id="surface-angels-layer"
                        style="position:absolute; top:0; left:0; width:100%; height:300px; pointer-events:none; z-index: 10;">
                    </div>

                    <!-- Warehouse FRONT Layer (Roof & Pillars) -->
                    <!-- Sits ON TOP of Carts (z-index 20) -->
                    <div class="warehouse-front"
                        style="position: absolute; top: 20px; left: 1050px; width: 320px; height: 160px; z-index: 20; pointer-events: none;">
                        <svg width="100%" height="160" viewBox="0 0 320 160" style="overflow:visible;">
                            <!-- Steel Frame Structure -->
                            <!-- Left H-Beam Column -->
                            <rect x="0" y="0" width="20" height="160" fill="#455A64" stroke="#263238"
                                stroke-width="2" />
                            <rect x="5" y="0" width="10" height="160" fill="#546E7A" />

                            <!-- Right H-Beam Column -->
                            <rect x="300" y="0" width="20" height="160" fill="#455A64" stroke="#263238"
                                stroke-width="2" />
                            <rect x="305" y="0" width="10" height="160" fill="#546E7A" />

                            <!-- Corrugated Metal Siding (Vertical Lines) -->
                            <g opacity="0.3">
                                <line x1="25" y1="30" x2="25" y2="160" stroke="#37474F" stroke-width="1" />
                                <line x1="35" y1="30" x2="35" y2="160" stroke="#37474F" stroke-width="1" />
                                <line x1="45" y1="30" x2="45" y2="160" stroke="#37474F" stroke-width="1" />
                                <line x1="285" y1="30" x2="285" y2="160" stroke="#37474F" stroke-width="1" />
                                <line x1="275" y1="30" x2="275" y2="160" stroke="#37474F" stroke-width="1" />
                                <line x1="295" y1="30" x2="295" y2="160" stroke="#37474F" stroke-width="1" />
                            </g>

                            <!-- Roof Truss Structure -->
                            <path d="M-10 25 L20 40 L160 10 L300 40 L330 25 L330 5 L160 -15 L-10 5 Z" fill="#546E7A"
                                stroke="#263238" stroke-width="2" />
                            <!-- Cross Bracing -->
                            <line x1="20" y1="40" x2="100" y2="15" stroke="#37474F" stroke-width="1" />
                            <line x1="300" y1="40" x2="220" y2="15" stroke="#37474F" stroke-width="1" />

                            <!-- Signage -->
                            <rect x="90" y="5" width="140" height="20" fill="#1565C0" rx="2" />
                            <text x="160" y="19" text-anchor="middle" fill="#FFFFFF" font-family="Arial, sans-serif"
                                font-weight="bold" font-size="14" letter-spacing="2">LOGISTICS</text>

                            <!-- Safety Warning Stripes -->
                            <rect x="0" y="140" width="20" height="10" fill="#FDD835" />
                            <rect x="300" y="140" width="20" height="10" fill="#FDD835" />
                            <path d="M0 145 L10 140 M10 150 L20 145" stroke="#000" stroke-width="2" />
                            <path d="M300 145 L310 140 M310 150 L320 145" stroke="#000" stroke-width="2" />
                        </svg>

                    </div>

                    <!-- Grid inside WRAPPER -->
                    <div class="game-grid">
                        <div class="shaft-container" id="shafts-anchor" style="grid-column: 1; grid-row: 1;"></div>
                        <div class="shaft-container" id="shafts-right-anchor" style="grid-column: 3; grid-row: 1;">
                        </div>
                        <!-- New Shaft Button: Dynamically positioned in updateNextShaftCostText -->
                        <div class="next-shaft-btn-container"
                            style="padding: 40px; display:flex; justify-content:center; grid-column: 1; grid-row: 2;">
                            <button class="btn-upgrade-simple"
                                style="padding: 18px 40px; font-size:1.4rem; box-shadow: 0 8px 25px rgba(0,0,0,0.6); position: relative; z-index: 50; pointer-events: auto;"
                                onclick="game.buyShaft()"> New Shaft <br><span id="txt-next-cost"
                                    style="color:#FFF176">$100</span> </button>
                        </div>
                        <div class="elevator-shaft" style="position: relative;">
                            <!-- STATIC BUTTON moved out of cabin -->
                            <div
                                style="position: absolute; top: -45px; left: 50%; transform: translateX(-50%); z-index: 10; width: 100%; text-align: center;">
                                <button id="btn-ele" class="btn-upgrade-simple" onclick="game.openUpgrade('ELE')">Lvl
                                    1</button>
                            </div>

                            <div id="ele-cable" class="elevator-cable"></div>

                            <!-- Decorative Pulley (Dual Gear System) -->
                            <div class="elevator-pulley">
                                <svg width="100" height="60" viewBox="0 0 100 60" style="overflow:visible;">
                                    <!-- Back Plate -->
                                    <rect x="10" y="10" width="80" height="40" fill="#263238" rx="2" />
                                    <!-- Large Gear -->
                                    <g class="pulley-gear-large" transform-origin="40 30">
                                        <circle cx="40" cy="30" r="22" fill="#455A64" stroke="#192024"
                                            stroke-width="2" />
                                        <!-- Teeth -->
                                        <g class="pulley-teeth">
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(0 40 30)" />
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(30 40 30)" />
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(60 40 30)" />
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(90 40 30)" />
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(120 40 30)" />
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(150 40 30)" />
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(180 40 30)" />
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(210 40 30)" />
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(240 40 30)" />
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(270 40 30)" />
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(300 40 30)" />
                                            <rect x="38" y="5" width="4" height="6" rx="1"
                                                transform="rotate(330 40 30)" />
                                        </g>
                                        <circle cx="40" cy="30" r="6" fill="#192024" />
                                    </g>
                                    <!-- Small Gear (Meshed) -->
                                    <g class="pulley-gear-small" transform-origin="72 30">
                                        <circle cx="72" cy="30" r="10" fill="#607D8B" stroke="#192024"
                                            stroke-width="1.5" />
                                        <g class="pulley-teeth">
                                            <rect x="71" y="18" width="2" height="4" transform="rotate(0 72 30)" />
                                            <rect x="71" y="18" width="2" height="4" transform="rotate(45 72 30)" />
                                            <rect x="71" y="18" width="2" height="4" transform="rotate(90 72 30)" />
                                            <rect x="71" y="18" width="2" height="4" transform="rotate(135 72 30)" />
                                            <rect x="71" y="18" width="2" height="4" transform="rotate(180 72 30)" />
                                            <rect x="71" y="18" width="2" height="4" transform="rotate(225 72 30)" />
                                            <rect x="71" y="18" width="2" height="4" transform="rotate(270 72 30)" />
                                            <rect x="71" y="18" width="2" height="4" transform="rotate(315 72 30)" />
                                        </g>
                                        <circle cx="72" cy="30" r="3" fill="#192024" />
                                    </g>
                                </svg>
                            </div>

                            <div class="elevator-rail"></div>
                            <div id="elevator-cabin" class="elevator-cabin">
                                <svg width="110" height="100" viewBox="0 0 110 100" style="overflow:visible;">
                                    <defs>
                                        <linearGradient id="cabinMetalWide" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" style="stop-color:#263238" />
                                            <stop offset="30%" style="stop-color:#455A64" />
                                            <stop offset="70%" style="stop-color:#455A64" />
                                            <stop offset="100%" style="stop-color:#263238" />
                                        </linearGradient>
                                        <linearGradient id="windowGradWide" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:rgba(0,150,255,0.25)" />
                                            <stop offset="100%" style="stop-color:rgba(0,150,255,0.05)" />
                                        </linearGradient>
                                    </defs>
                                    <!-- Reinforced Frame (Outer) -->
                                    <rect x="5" y="8" width="100" height="89" fill="#192024" rx="5" />
                                    <!-- Main Cabin Box -->
                                    <rect x="8" y="10" width="94" height="85" fill="url(#cabinMetalWide)"
                                        stroke="#192024" stroke-width="2" rx="4" />

                                    <!-- Rivets -->
                                    <circle class="cabin-rivet" cx="12" cy="14" r="1.5" />
                                    <circle class="cabin-rivet" cx="98" cy="14" r="1.5" />
                                    <circle class="cabin-rivet" cx="12" cy="91" r="1.5" />
                                    <circle class="cabin-rivet" cx="98" cy="91" r="1.5" />
                                    <circle class="cabin-rivet" cx="12" cy="52" r="1.5" />
                                    <circle class="cabin-rivet" cx="98" cy="52" r="1.5" />

                                    <!-- Window / Glass Shield (Wider) -->
                                    <rect class="cabin-window" x="15" y="15" width="80" height="40" rx="3"
                                        fill="url(#windowGradWide)" />
                                    <path d="M15 15 L95 55" stroke="rgba(255,255,255,0.15)" stroke-width="1.5" />

                                    <!-- Safety Bar (Steel look) -->
                                    <rect x="8" y="78" width="94" height="5" fill="#78909C" stroke="#455A64"
                                        stroke-width="1" />
                                    <rect x="8" y="78" width="94" height="2" fill="rgba(255,255,255,0.3)" />

                                    <!-- Hanger Top (Chain Connection) -->
                                    <rect x="40" y="2" width="30" height="8" fill="#192024" rx="2" />
                                    <circle cx="55" cy="5" r="5" fill="#546E7A" stroke="#263238" stroke-width="1.5" />

                                    <!-- NEW OPERATOR CHARACTER (Shifted for width) -->
                                    <g class="operator-anim" transform="translate(10, 0)">
                                        <!-- Control Panel Stand -->
                                        <rect x="55" y="60" width="20" height="25" fill="#78909C" stroke="#455A64"
                                            rx="2" />
                                        <rect x="53" y="55" width="24" height="10" fill="#CFD8DC" />

                                        <!-- LEVER GROUP -->
                                        <g class="control-lever" transform-origin="65 55">
                                            <path d="M65 55 L75 40" stroke="#F44336" stroke-width="4"
                                                stroke-linecap="round" />
                                            <circle cx="75" cy="40" r="4" fill="#D32F2F" />
                                        </g>

                                        <!-- The Character -->
                                        <g class="character-group">
                                            <!-- Legs -->
                                            <g class="leg-l" transform-origin="38 65">
                                                <rect x="32" y="65" width="7" height="18" fill="#1A237E" rx="2" />
                                                <rect x="30" y="80" width="11" height="5" fill="#212121" rx="1" />
                                            </g>
                                            <g class="leg-r" transform-origin="46 65">
                                                <rect x="44" y="65" width="7" height="18" fill="#1A237E" rx="2" />
                                                <rect x="42" y="80" width="11" height="5" fill="#212121" rx="1" />
                                            </g>

                                            <!-- Torso -->
                                            <g class="torso" transform-origin="42 60">
                                                <rect x="30" y="45" width="24" height="22" fill="#3949AB" rx="3" />
                                                <!-- Belt -->
                                                <rect x="30" y="62" width="24" height="4" fill="#212121" />
                                                <rect x="40" y="62" width="4" height="4" fill="#FFC107" />

                                                <!-- Head -->
                                                <g class="head" transform="translate(1, -5)">
                                                    <circle cx="41" cy="38" r="11" fill="#FFCC80" />
                                                    <path d="M30 34 Q41 28 52 34 L52 38 L30 38 Z" fill="#1A237E" />
                                                    <rect x="28" y="36" width="28" height="4" fill="#303F9F" rx="1" />
                                                    <circle cx="45" cy="36" r="1.5" fill="#212121" />
                                                    <circle cx="37" cy="36" r="1.5" fill="#212121" />
                                                </g>

                                                <!-- Arms -->
                                                <g class="arm-l" transform-origin="32 48" transform="rotate(-15)">
                                                    <rect x="23" y="48" width="8" height="18" fill="#3949AB" rx="2" />
                                                    <circle cx="27" cy="64" r="4" fill="#FFCC80" />
                                                </g>
                                                <g class="arm-r" transform-origin="52 48" transform="rotate(-45)">
                                                    <rect x="53" y="48" width="8" height="18" fill="#3949AB" rx="2" />
                                                    <circle cx="57" cy="64" r="4" fill="#FFCC80" />
                                                </g>
                                            </g>
                                        </g>
                                    </g>
                                </svg>
                                <div class="elevator-fill glint-effect" id="elevator-fill"
                                    style="background: var(--gold-gem-gradient); box-shadow: inset 0 0 15px rgba(0,0,0,0.4);">
                                </div>
                            </div>
                        </div>
                    </div>

                </div> <!-- End Wrapper -->
            </div>
        </div>
    </div>

    <style>
        /* --- TUTORIAL --- */
        .tutorial-pointer {
            position: fixed;
            font-size: 4rem;
            z-index: 10000;
            pointer-events: none;
            animation: pointer-bounce 1s infinite ease-in-out;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
            transition: all 0.3s;
        }

        @keyframes pointer-bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        #orientation-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #263238;
            z-index: 20000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #FFC107;
        }

        /* Show only on portrait mobile */
        @media screen and (orientation: portrait) {
            #orientation-warning {
                display: flex;
            }
        }

        /* Ensure UI Layer passes clicks */
        #ui-layer {
            pointer-events: none;
        }

        #ui-layer>* {
            pointer-events: auto;
        }

        .btn-skip-tutorial {
            position: fixed;
            top: 90px;
            right: 20px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 10000;
            font-family: 'Fredoka One', cursive;
            font-size: 0.9rem;
            transition: transform 0.2s;
        }

        .btn-skip-tutorial:hover {
            transform: scale(1.05);
            background: rgba(255, 50, 50, 0.8);
        }

        /* TUTORIAL POINTER (Missing in previous step) */
        .tutorial-pointer {
            position: fixed;
            z-index: 10000;
            font-size: 3rem;
            pointer-events: none;
            animation: bouncePointer 1s infinite;
            filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.5));
            /* Ensure it is visible on top of everything */
            color: white;
            text-shadow: 0 0 5px black;
        }

        @keyframes bouncePointer {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        /* NEW TUTORIAL STYLES */
        .tutorial-welcome {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 11000;
            color: white;
            font-family: 'Fredoka One', cursive;
            font-size: 3rem;
            text-align: center;
            animation: fadeInOut 2s forwards;
            pointer-events: none;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }

            20% {
                opacity: 1;
                transform: scale(1);
            }

            80% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(1.1);
            }
        }

        .tutorial-overlay-text {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80%;
            max-width: 400px;
            transform: translate(-50%, -50%);
            background: #263238;
            border: 4px solid #FFD54F;
            color: white;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Roboto', sans-serif;
            text-align: center;
            z-index: 11000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
        }

        .tutorial-overlay-text h3 {
            margin-top: 0;
            color: #FFD54F;
            font-family: 'Fredoka One', cursive;
        }

        .tutorial-close-btn {
            background: #F44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
        }

        .mission-widget.hidden {
            display: none !important;
        }

        /* Pulse Animation for Upgrade Button */
        .btn-pulse {
            animation: btn-pulse-anim 1s infinite;
            border: 2px solid #00E676 !important;
        }

        @keyframes btn-pulse-anim {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(0, 230, 118, 0.4);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(0, 230, 118, 0.8);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(0, 230, 118, 0.4);
            }
        }

        /* Mobile Optimization for Popup */
        @media (max-height: 500px) {
            .tutorial-overlay-text {
                top: 20%;
                transform: translate(-50%, 0);
            }
        }
    </style>
    <script>
        // --- ASSETS ---
        function getHelicopterSVG() {
            return `<svg width="140" height="70" viewBox="0 0 140 70" style="overflow:visible;">
                <defs>
                    <linearGradient id="heliBodyGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#37474F" />
                        <stop offset="50%" style="stop-color:#263238" />
                        <stop offset="100%" style="stop-color:#102027" />
                    </linearGradient>
                    <linearGradient id="heliCockpitGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#81D4FA" />
                        <stop offset="100%" style="stop-color:#0288D1" />
                    </linearGradient>
                </defs>
                
                <!-- Tail Boom -->
                <path d="M15 30 L80 30 L85 45 L20 45 Z" fill="#263238" />
                <rect x="10" y="25" width="10" height="25" fill="#1B262C" rx="2" /> <!-- Tail Fin -->
                
                <!-- Tail Rotor -->
                <g transform="translate(12, 30)">
                    <g class="heli-rotor-tail">
                        <rect x="-10" y="-1" width="20" height="2" fill="#90A4AE" rx="1" />
                        <rect x="-1" y="-10" width="2" height="20" fill="#90A4AE" rx="1" />
                        <circle cx="0" cy="0" r="3" fill="#37474F" />
                    </g>
                </g>

                <!-- Small Stabilizer -->
                <rect x="30" y="28" width="15" height="4" fill="#37474F" rx="1" />

                <!-- Main Body -->
                <path d="M50 20 Q130 15 130 45 Q130 65 85 65 Q50 65 50 45 Z" fill="url(#heliBodyGrad)" stroke="#102027" stroke-width="1.5" />
                
                <!-- Cockpit Glass -->
                <path d="M90 22 Q125 22 125 45 L90 45 Z" fill="url(#heliCockpitGrad)" opacity="0.7" />
                <path d="M100 25 L120 40" stroke="white" stroke-width="1" opacity="0.3" stroke-linecap="round" /> <!-- Reflection -->
                
                <!-- Skids -->
                <g stroke="#1B262C" stroke-width="4" stroke-linecap="round">
                    <line x1="65" y1="65" x2="60" y2="70" />
                    <line x1="110" y1="65" x2="115" y2="70" />
                    <path d="M50 72 L125 72 L130 68" fill="none" stroke-width="5" />
                </g>
                
                <!-- Top Engine Intake / Cowling -->
                <path d="M75 18 L105 18 L100 25 L80 25 Z" fill="#1B262C" />

                <!-- Main Rotor Shaft -->
                <rect x="88" y="10" width="4" height="10" fill="#37474F" />
                
                <!-- Main Rotor (4 Blades) -->
                <g transform="translate(90, 10)">
                    <g class="heli-rotor-main">
                        <rect x="-60" y="-2" width="120" height="4" fill="#90A4AE" rx="2" opacity="0.8" />
                        <rect x="-2" y="-60" width="4" height="120" fill="#90A4AE" rx="2" opacity="0.3" /> <!-- Blurred vertical blades -->
                        <circle cx="0" cy="0" r="6" fill="#37474F" />
                    </g>
                </g>

                <!-- Navigation Lights -->
                <circle class="heli-beacon" cx="90" cy="18" r="4" fill="#ff1744" /> <!-- Red Beacon -->
                <circle cx="128" cy="45" r="2" fill="#00E676" /> <!-- Green Nav Light -->
                
                <!-- Detail Lines -->
                <line x1="60" y1="45" x2="120" y2="45" stroke="rgba(255,255,255,0.1)" stroke-width="1" />
                <rect x="85" y="55" width="25" height="3" fill="#ff1744" rx="1.5" opacity="0.8" /> <!-- Decal -->
            </svg>`;
        }

        function getMinerSVG() {
            return `<svg width="80" height="80" viewBox="0 0 80 80" style="overflow:visible;">
            <g class="character-group">
                <!-- LEGS -->
                <g class="leg-l" transform-origin="40 55">
                    <rect x="36" y="55" width="7" height="18" fill="#4E342E" rx="2"/> <!-- Darker Pants -->
                    <rect x="34" y="72" width="11" height="6" fill="#212121" rx="1"/> <!-- Boot -->
                    <rect x="34" y="76" width="11" height="2" fill="#000" /> <!-- Sole -->
                </g>
                <g class="leg-r" transform-origin="40 55">
                    <rect x="44" y="55" width="7" height="18" fill="#4E342E" rx="2"/>
                    <rect x="42" y="72" width="11" height="6" fill="#212121" rx="1"/>
                    <rect x="42" y="76" width="11" height="2" fill="#000" />
                </g>

                <!-- TORSO GROUP -->
                <g class="torso" transform-origin="42 55">
                    <!-- Body: Dirty Vest -->
                    <rect x="32" y="38" width="22" height="24" fill="#EF6C00" rx="4"/> <!-- Orange High-Vis -->
                    <rect x="36" y="38" width="14" height="24" fill="#FF9800" /> <!-- Inner Highlight -->
                    <path d="M32 38 L37 62 L49 62 L54 38 Z" fill="#E65100" opacity="0.3"/> <!-- Shadow/Shape -->
                    
                    <!-- Belt -->
                    <rect x="32" y="58" width="22" height="5" fill="#3E2723" />
                    <rect x="40" y="58" width="6" height="5" fill="#BDBDBD" stroke="#757575" stroke-width="1"/> <!-- Buckle -->

                    <!-- HEAD GROUP -->
                    <g class="head" transform="translate(0, -6)">
                        <circle cx="43" cy="30" r="10.5" fill="#FFCC80"/> <!-- Face -->
                        <!-- Beard/Stubble -->
                        <path d="M33 30 Q43 42 53 30" fill="#3E2723" opacity="0.2" />
                        
                        <!-- Helmet (Hard Hat) -->
                        <path d="M31 28 Q43 10 55 28" fill="#FFEB3B" stroke="#FBC02D" stroke-width="2"/> 
                        <rect x="29" y="28" width="28" height="4" fill="#F9A825" rx="1"/> <!-- Rim -->
                        
                        <!-- Lamp -->
                        <g transform="translate(43, 21)">
                             <rect x="-3" y="-3" width="6" height="6" fill="#424242" rx="1"/>
                             <circle cx="0" cy="0" r="2.5" fill="#FFF"/>
                             <circle cx="0" cy="0" r="6" fill="white" opacity="0.4" /> <!-- Glow -->
                        </g>

                        <!-- Face Details -->
                        <circle cx="46" cy="32" r="1.5" fill="#212121"/> <!-- Eye -->
                        <circle cx="39" cy="32" r="1.5" fill="#212121"/> <!-- Eye -->
                        <rect class="miner-moustache" x="40" y="37" width="6" height="2" fill="#3E2723" rx="1" style="transition: opacity 0.2s;" /> <!-- Moustache -->
                        <!-- Smile (Replaces moustache when working) -->
                        <path class="miner-smile" d="M39 36 Q43 39 47 36" fill="none" stroke="#212121" stroke-width="2" stroke-linecap="round" style="opacity:0; transition: opacity 0.2s;" />
                    </g>

                    <!-- Left Arm (Shoulder) -->
                    <g class="arm-l" transform-origin="34 42">
                         <rect x="24" y="42" width="9" height="18" fill="#EF6C00" rx="3"/> <!-- Sleeve -->
                         <rect x="24" y="55" width="9" height="6" fill="#FFCC80"/> <!-- Skin -->
                        <circle cx="28" cy="62" r="4.5" fill="#FFCC80"/> <!-- Hand -->
                    </g>
                    
                    <!-- Right Arm (Front - Holds Pickaxe) -->
                    <g class="arm-r" transform-origin="52 42">
                        <rect x="52" y="42" width="9" height="18" fill="#EF6C00" rx="3"/>
                        <rect x="52" y="55" width="9" height="6" fill="#FFCC80"/>
                        <circle cx="56" cy="62" r="4.5" fill="#FFCC80"/> <!-- Hand -->
                        
                        <!-- PICKAXE -->
                        <!-- Fixed grip: Hand is at (0,0) relative to this group. Shift handle UP so (0,0) is mid-shaft. -->
                        <g class="pickaxe" transform="translate(56, 62) rotate(20)">
                            <!-- Handle (Longer, held in middle) -->
                            <!-- Starts at -30 (top) goes to +15 (bottom) -->
                            <rect x="-2.5" y="-35" width="5" height="50" fill="#8D6E63" rx="1"/> 
                            
                            <!-- Metal Head (At Top) -->
                            <g transform="translate(0, -35)">
                                <path d="M-20 8 Q0 -5 20 8 L22 2 Q0 -15 -22 2 Z" fill="#CFD8DC" stroke="#546E7A" stroke-width="1"/>
                                <path d="M-22 2 L-20 8 L0 0 Z" fill="#78909C"/> <!-- Sharp Tip Shadow -->
                            </g>
                        </g>

                        <!-- SACK (Carried over shoulder or in hand) -->
                        <g class="sack" transform="translate(56, 62) rotate(-10)">
                             <!-- Sack Body -->
                             <path d="M-10 0 Q-15 15 -5 25 Q5 30 15 20 Q20 5 10 -5 Z" fill="#795548" stroke="#5D4037" stroke-width="1"/>
                             <path d="M-5 5 Q5 15 10 0" fill="none" stroke="#5D4037" stroke-width="1" opacity="0.5"/>
                             <!-- Precious Contents Peeking Out -->
                             <circle cx="2" cy="-2" r="3" fill="#FFD54F" stroke="#FF6F00" stroke-width="0.5" />
                             <!-- Sparkle -->
                             <path class="svg-sparkle" d="M2 -6 L3 -10 L4 -6 L8 -5 L4 -4 L3 0 L2 -4 L-2 -5 Z" fill="white" transform="scale(0.5) translate(4, -12)"/>
                             <path d="M-3 -4 L0 -8 L3 -4 Z" fill="#00E5FF" opacity="0.9" />
                             <circle cx="8" cy="-1" r="2.5" fill="#FFD54F" stroke="#FF6F00" stroke-width="0.5" />
                        </g>
                    </g>
                </g>
            </g>
            </svg>`;
        }
        function getCartSVG() {
            return `<svg width="140" height="90" viewBox="0 0 140 90" style="overflow:visible;">
            <defs>
                <linearGradient id="cartMetal" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#78909C" />
                    <stop offset="50%" style="stop-color:#455A64" />
                    <stop offset="100%" style="stop-color:#263238" />
                </linearGradient>
                <linearGradient id="gemGoldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#FFD54F" />
                    <stop offset="50%" style="stop-color:#FF6F00" />
                    <stop offset="100%" style="stop-color:#00B0FF" />
                </linearGradient>
            </defs>
            <g class="character-group">
                <!-- THE PUSHER (Guy) -->
                <g class="guy pushing-lean" transform="translate(85, -2)">
                    <g class="leg-l" transform-origin="15 50">
                        <rect x="10" y="50" width="7" height="20" fill="#263238" rx="2"/>
                        <rect x="8" y="68" width="12" height="6" fill="#111" rx="1"/>
                    </g>
                    <g class="leg-r" transform-origin="15 50">
                        <rect x="22" y="50" width="7" height="20" fill="#263238" rx="2"/>
                        <rect x="20" y="68" width="12" height="6" fill="#111" rx="1"/>
                    </g>
                    <g class="torso">
                        <rect x="10" y="25" width="22" height="28" fill="#FF9800" rx="4"/> <!-- Orange Vest -->
                        <rect x="10" y="32" width="22" height="4" fill="#E0E0E0" opacity="0.6"/> <!-- Reflective Stripe -->
                        <rect x="10" y="42" width="22" height="4" fill="#E0E0E0" opacity="0.6"/> <!-- Reflective Stripe -->
                        
                        <!-- Head -->
                        <g class="head" transform="translate(4, -2)">
                            <circle cx="15" cy="18" r="10" fill="#FFCC80"/>
                            <!-- Beard -->
                            <path d="M7 20 Q15 28 23 20" fill="#3E2723" opacity="0.3"/>
                            <!-- Helmet -->
                            <path d="M5 16 Q15 2 25 16" fill="#FFEB3B" stroke="#FBC02D" stroke-width="2"/>
                            <rect x="3" y="15" width="24" height="3" fill="#F9A825" rx="1"/>
                            <!-- Face -->
                            <circle cx="12" cy="19" r="1.5" fill="#212121"/>
                            <circle cx="18" cy="19" r="1.5" fill="#212121"/>
                        </g>

                        <!-- Arms (Pushing Position) -->
                        <g class="arm-r" transform-origin="15 35" transform="rotate(-60)">
                            <rect x="18" y="30" width="7" height="22" fill="#FF9800" rx="3"/>
                            <circle cx="21.5" cy="52" r="5" fill="#FFCC80"/>
                        </g>
                    </g>
                </g>

                <!-- THE CART (Reinforced) -->
                <g class="cart cart-wobble" transform="translate(0, 35)">
                    <!-- Structural Beams -->
                    <rect x="5" y="5" width="70" height="32" fill="#37474F" rx="2"/>
                    <!-- Main Body -->
                    <rect x="10" y="0" width="60" height="30" fill="url(#cartMetal)" stroke="#192024" stroke-width="2" rx="1"/>
                    
                    <!-- Rivets -->
                    <circle cx="15" cy="5" r="1.5" fill="#B0BEC5" opacity="0.8"/>
                    <circle cx="15" cy="25" r="1.5" fill="#B0BEC5" opacity="0.8"/>
                    <circle cx="65" cy="5" r="1.5" fill="#B0BEC5" opacity="0.8"/>
                    <circle cx="65" cy="25" r="1.5" fill="#B0BEC5" opacity="0.8"/>
                    <circle cx="40" cy="15" r="1.5" fill="#B0BEC5" opacity="0.5"/>

                    <!-- Industrial Wheels -->
                    <g class="wheel-front">
                        <circle cx="20" cy="32" r="10" fill="#212121" stroke="#455A64" stroke-width="3"/>
                        <circle cx="20" cy="32" r="3" fill="#9E9E9E"/>
                    </g>
                    <g class="wheel-back">
                        <circle cx="60" cy="32" r="10" fill="#212121" stroke="#455A64" stroke-width="3"/>
                        <circle cx="60" cy="32" r="3" fill="#9E9E9E"/>
                    </g>

                    <!-- Connection Handle -->
                    <rect x="70" y="10" width="20" height="6" fill="#5D4037" rx="2"/>

                        <!-- THE CARGO (Gem Pile) -->
                        <g class="ore-pile" style="transform: scaleY(0); transform-origin: bottom; transition: transform 0.2s;">
                            <path d="M15 5 Q40 -25 65 5 Z" fill="url(#gemGoldGrad)" stroke="#E65100" stroke-width="1"/>
                            <!-- Sparkles -->
                            <path class="svg-sparkle" d="M30 -5 L32 -10 L34 -5 L39 -3 L34 -1 L32 4 L30 -1 L25 -3 Z" fill="white" style="animation-delay: 0s;"/>
                            <path class="svg-sparkle" d="M50 -10 L51 -14 L52 -10 L56 -9 L52 -8 L51 -4 L50 -8 L46 -9 Z" fill="white" style="animation-delay: 0.5s;"/>
                            <!-- Gem Details -->
                            <path d="M30 -5 L35 -12 L40 -5 Z" fill="#FFF" opacity="0.6">
                            <animate attributeName="opacity" values="0.4;0.8;0.4" dur="2s" repeatCount="indefinite" />
                        </path>
                        <circle cx="50" cy="-2" r="3" fill="#FFEB3B" opacity="0.8"/>
                        <circle cx="25" cy="2" r="2" fill="#00E5FF" opacity="0.8"/>
                    </g>
                </g>
            </g>
            </svg>`;
        }

        const $ = s => document.querySelector(s);
        const fmt = n => { if (typeof n !== 'number' || isNaN(n)) return "0"; if (n < 1000) return Math.floor(n); const s = ["", "k", "m", "b", "t", "aa"]; const i = Math.floor(Math.log10(n) / 3); return (n / Math.pow(1000, i)).toFixed(1) + (s[i] || ""); };
        const CFG = { shaftH: 160, shaftGap: 20, baseCostShaft: 500, baseCostEle: 50, baseCostWH: 100 };

        /* --- MANAGER SYSTEM LOGIC --- */
        const MANAGERS = {
            JUNIOR: { name: 'Junior', cost: 500, type: 'cash', dur: 60, cool: 300, color: '#B0BEC5', mult: 2.0 },
            SENIOR: { name: 'Senior', cost: 5000, type: 'cash', dur: 120, cool: 600, color: '#FFD54F', mult: 4.0 },
            EXECUTIVE: { name: 'Executive', cost: 200, type: 'super', dur: 300, cool: 900, color: '#F44336', mult: 10.0 }
        };

        const WORLDS = [
            { idx: 0, id: 'COAL', name: 'Coal Mine', cost: 0, mult: 1, css: { skyTop: '#4FC3F7', skyBot: '#B3E5FC', earth: '#3E2723', dirt: '#5D4037', grass: '#43A047' } },
            { idx: 1, id: 'GOLD', name: 'Gold Mine', cost: 1e12, mult: 50, css: { skyTop: '#FFF59D', skyBot: '#FFF9C4', earth: '#5D4037', dirt: '#795548', grass: '#FBC02D' } },
            { idx: 2, id: 'RUBY', name: 'Ruby Mine', cost: 1e15, mult: 2500, css: { skyTop: '#F48FB1', skyBot: '#FCE4EC', earth: '#4A148C', dirt: '#880E4F', grass: '#D81B60' } },
            { idx: 3, id: 'MOON', name: 'Moon Base', cost: 1e17, mult: 10000, css: { skyTop: '#263238', skyBot: '#000000', earth: '#212121', dirt: '#424242', grass: '#616161' } }
        ];

        /* --- RESEARCH TREE SYSTEM --- */
        const RESEARCH_NODES = {
            'pickaxe_1': { id: 'pickaxe_1', name: 'Alloy Pickaxes', desc: 'Increases Miner Mine Rate by +25%', icon: 'â›ï¸', cost: 10000, type: 'cash', effect: { target: 'mineRate', val: 0.25 }, req: null, x: 30, y: 210 },
            'sack_1': { id: 'sack_1', name: 'Industrial Sacks', desc: 'Increases Miner Capacity by +20%', icon: 'ðŸŽ’', cost: 50000, type: 'cash', effect: { target: 'capacity', val: 0.20 }, req: 'pickaxe_1', x: 220, y: 80 },
            'bin_1': { id: 'bin_1', name: 'Titanium Bins', desc: 'Increases Shaft Bin Capacity by +50%', icon: 'ðŸ“¦', cost: 250000, type: 'cash', effect: { target: 'binCap', val: 0.50 }, req: 'sack_1', x: 220, y: 340 },
            'pump_1': { id: 'pump_1', name: 'Lift Pumps', desc: 'Increases Elevator Rate by +30%', icon: 'â›½', cost: 1e6, type: 'cash', effect: { target: 'loadRate', val: 0.30 }, req: 'bin_1', x: 410, y: 340 },
            'survey_1': { id: 'survey_1', name: 'Deep Surveying', desc: 'Global Earnings Multiplier +15%', icon: 'ðŸ“¡', cost: 5e6, type: 'cash', effect: { target: 'globalEarnings', val: 0.15 }, req: 'pump_1', x: 600, y: 340 },
            'sc_1': { id: 'sc_1', name: 'SuperCash Sync', desc: 'SuperCash Chance & Bonus +20%', icon: 'ðŸ’Ž', cost: 1e8, type: 'cash', effect: { target: 'scChance', val: 0.20 }, req: 'survey_1', x: 600, y: 80 },
            'axle_1': { id: 'axle_1', name: 'Heavy Axles', desc: 'Warehouse Capacity by +25%', icon: 'ðŸš›', cost: 5e8, type: 'cash', effect: { target: 'whCapacity', val: 0.25 }, req: 'sc_1', x: 410, y: 80 },
            'ai_1': { id: 'ai_1', name: 'Logistics AI', desc: 'Reduces Manager Cooldowns by -10%', icon: 'ðŸ¤–', cost: 1e9, type: 'cash', effect: { target: 'coolDown', val: -0.10 }, req: 'axle_1', x: 220, y: 210 }
        };

        class ResearchTree {
            constructor() {
                this.unlocked = []; // IDs of unlocked nodes
                this.multipliers = {
                    mineRate: 1,
                    capacity: 1,
                    binCap: 1,
                    loadRate: 1,
                    globalEarnings: 1,
                    scChance: 1,
                    whCapacity: 1,
                    coolDown: 1
                };
            }
            isUnlocked(id) { return this.unlocked.includes(id); }
            canUnlock(id) {
                const node = RESEARCH_NODES[id];
                if (!node) return false;
                if (this.isUnlocked(id)) return false;
                if (node.req === null) return true;
                // Handle multiple requirements
                if (Array.isArray(node.req)) {
                    return node.req.every(reqId => this.isUnlocked(reqId));
                }
                return this.isUnlocked(node.req);
            }
            unlock(id) {
                if (this.canUnlock(id)) {
                    this.unlocked.push(id);
                    this.applyEffect(id);
                    return true;
                }
                return false;
            }
            applyEffect(id) {
                const node = RESEARCH_NODES[id];
                const { target, val } = node.effect;
                if (target === 'coolDown') {
                    this.multipliers[target] += val; // Cooldown reduction is additive negative
                } else {
                    this.multipliers[target] += val; // Most multipliers are additive positive (binary stacking)
                }
            }
            loadState(data) {
                if (!data) return;
                this.unlocked = data.unlocked || [];
                // Recalculate all multipliers
                this.multipliers = { mineRate: 1, capacity: 1, binCap: 1, loadRate: 1, globalEarnings: 1, scChance: 1, whCapacity: 1, coolDown: 1 };
                this.unlocked.forEach(id => this.applyEffect(id));
            }
        }

        class Manager {
            constructor(type, target) {
                this.type = type; // 'JUNIOR', 'SENIOR', 'EXECUTIVE'
                this.target = target;
                this.stats = MANAGERS[type];
                this.state = 'READY'; // READY, ACTIVE, COOLDOWN
                this.timer = 0;
                this.el = null; // View element
                this.openHireCb = null; // Callback for swap button
                this.stateChangeCb = null; // Callback for activation/deactivation
            }
            createUI(parent, coordsClass) {
                this.el = document.createElement('div');
                this.el.className = `manager-slot ${coordsClass}`;
                this.updateUI();

                this.el.onclick = (e) => {
                    e.stopPropagation();
                    if (this.state === 'READY') this.activate();
                };

                // SWAP BUTTON (Premium SVG)
                let swapBtn = document.createElement('div');
                swapBtn.className = 'manager-swap-btn';
                swapBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M7 16V4M7 4L3 8M7 4L11 8M17 8v12m0 0l4-4m-4 4l-4-4"/>
                    </svg>`;
                swapBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (this.openHireCb) this.openHireCb();
                };
                this.el.appendChild(swapBtn);

                parent.appendChild(this.el);
            }
            removeUI() {
                if (this.el) this.el.remove();
            }
            // Add setter for callbacks
            setHireCallback(cb) { this.openHireCb = cb; }
            setStateChangeCallback(cb) { this.stateChangeCb = cb; }

            update(dt) {
                if (this.state === 'ACTIVE') {
                    this.timer -= dt;
                    if (this.timer <= 0) {
                        this.state = 'COOLDOWN';
                        this.timer = this.stats.cool;
                        this.el.classList.remove('manager-active-glow');
                        this.updateUI();
                        if (this.stateChangeCb) this.stateChangeCb('COOLDOWN');
                    }
                } else if (this.state === 'COOLDOWN') {
                    const resCoolMult = (typeof game !== 'undefined' && game.research) ? game.research.multipliers.coolDown : 1;
                    const effectiveDt = dt / resCoolMult;
                    // Wait, if val is -0.1, 1 + (-0.1) = 0.9. dt / 0.9 = 1.11dt. Faster cooldown. Correct.
                    this.timer -= effectiveDt;
                    this.updateCooldownUI();
                    if (this.timer <= 0) {
                        this.state = 'READY';
                        this.timer = 0;
                        this.updateUI();
                    }
                }
            }
            activate() {
                this.state = 'ACTIVE';
                this.timer = this.stats.dur;
                this.el.classList.add('manager-active-glow');
                this.updateUI();
                if (this.stateChangeCb) this.stateChangeCb('ACTIVE');
                if (game && game.missions) game.missions.onEvent('MANAGER_ACTIVATE');
                game.createFloatText("ACTIVATE!", this.el.getBoundingClientRect().left - 100, this.el.getBoundingClientRect().top); // Rough check
            }
            updateUI() {
                if (!this.el) return;

                // Keep the swap button if it exists
                let swapBtn = this.el.querySelector('.manager-swap-btn');

                this.el.innerHTML = '';

                if (this.state === 'EMPTY') {
                    this.el.className = this.el.className.replace(' manager-active-glow', '').replace(' filled', '') + ' empty';
                } else {
                    this.el.classList.remove('empty');
                    this.el.classList.add('filled');
                    let icon = document.createElement('div');
                    icon.className = 'manager-icon';
                    // Simple avatar generator
                    let color = this.type === 'SENIOR' ? '#FFD54F' : (this.type === 'EXECUTIVE' ? '#F44336' : '#90A4AE');
                    icon.style.background = `radial-gradient(circle at 30% 30%, ${color}, #444)`;
                    icon.innerHTML = `<div style="font-size:24px; text-align:center; padding-top:8px;">${this.type === 'EXECUTIVE' ? 'ðŸ•´ï¸' : (this.type === 'SENIOR' ? 'ðŸ¤µ' : 'ðŸ‘·')}</div>`;
                    this.el.appendChild(icon);
                }

                // Re-append swap button so it's always on top
                if (swapBtn) this.el.appendChild(swapBtn);
            }
            updateCooldownUI() {
                if (!this.el) return;
                // Simple textual countdown overlay
                let ov = this.el.querySelector('.manager-timer-pie');
                if (!ov) {
                    ov = document.createElement('div');
                    ov.className = 'manager-timer-pie';
                    this.el.appendChild(ov);
                }
                const m = Math.floor(this.timer / 60);
                const s = Math.floor(this.timer % 60);
                ov.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            }
            getSpeedMult() {
                return (this.state === 'ACTIVE') ? this.stats.mult : 1.0;
            }
        }

        class Miner {
            constructor(parent, index) {
                this.parent = parent;
                this.index = index || 0;
                this.personalOffset = (this.index - 1) * 30; // Stagger targets to prevent overlap
                this.el = document.createElement('div');
                this.el.className = 'character-container';
                this.el.innerHTML = getMinerSVG();
                parent.appendChild(this.el);

                this.x = 100 + (this.index * 60); // Initial staggered position
                this.state = 'IDLE';
                this.stats = { speed: 80, capacity: 50, mineRate: 20 };
                this.load = 0;
                this.soundTimer = 0; // Sound loop timer

                // Add Helmet Light
                this.light = document.createElement('div');
                this.light.className = 'light-source miner-light';
                this.el.appendChild(this.light);

                // Dropped Gear Element (Item lying on ground)
                this.droppedGear = document.createElement('div');
                this.droppedGear.className = 'dropped-gear';
                this.droppedGear.style.bottom = '35px';
                parent.appendChild(this.droppedGear);
                this.lastDroppedType = '';
            }
            update(dt, rockX) {
                // Update Light Opacity
                if (game.dayNight) this.light.style.opacity = game.dayNight.getNightIntensity();

                // Position dropped gear first time
                if (this.droppedGear.style.left === '') {
                    this.droppedGear.style.left = (rockX - 30) + 'px';
                }

                // Apply personal offset to prevent overlap
                const sideFactor = this.parent.classList.contains('right-side') ? -1 : 1;
                const offset = this.personalOffset * sideFactor;

                const baseBinX = this.parent.classList.contains('right-side') ? 460 : 140;
                const targetBinX = baseBinX - offset;

                const baseRockX = (this.parent.classList.contains('right-side') ? 60 : rockX);
                const targetRockX = baseRockX + offset;

                // VISUAL STATE MANAGEMENT
                const carryingSack = (this.state !== 'MINING');

                if (carryingSack) {
                    this.el.classList.add('miner-carrying-sack');
                    this.updateDroppedGear('PICKAXE');
                } else {
                    this.el.classList.remove('miner-carrying-sack');
                    this.updateDroppedGear('SACK');
                }

                switch (this.state) {
                    case 'IDLE': this.flip(false); this.setAnim('walk'); this.state = 'TO_ROCK'; break;
                    case 'TO_ROCK': {
                        // Closer strike point: 20px gap + personal offset
                        const reachRock = this.parent.classList.contains('right-side') ? (this.x > targetRockX + 20) : (this.x < targetRockX - 20);

                        if (reachRock) {
                            // Fixed visual speed for miners - no management bonus to speed!
                            this.x += (this.parent.classList.contains('right-side') ? -1 : 1) * this.stats.speed * dt;
                        }
                        else {
                            this.state = 'MINING';
                            this.setAnim('mine');
                            // Ensure miner is facing the ROCK during mining
                            this.flip(this.parent.classList.contains('right-side'));
                            this.soundTimer = 0; // Play immediately
                        }
                    }
                        break;
                    case 'MINING':
                        let shaft = game.shafts[this.parent.dataset.id];
                        // PAUSE LOGIC: Stop if shaft bin is full
                        if (shaft.bin >= shaft.binCap) {
                            if (!this.valIsPaused) {
                                this.setAnim('sit'); // Sit down
                                this.flip(true); // Face away from rock (against the wall)
                                this.valIsPaused = true;
                            }
                            break; // Stop processing
                        }
                        // Resume if was paused
                        if (this.valIsPaused) {
                            this.flip(false); // Face rock again
                            this.setAnim('mine');
                            this.valIsPaused = false;
                        }

                        if (this.load < this.stats.capacity) {
                            this.load += this.stats.mineRate * dt;
                            // Continuous Sound (Every 0.6s)
                            this.soundTimer -= dt;
                            if (this.soundTimer <= 0) {
                                game.audio.playSFX('mine');
                                this.soundTimer = 0.6; // Synced with CSS animation

                                // SPAWN SPARKS at impact point (Precise Screen Coordinates)
                                let shaftObj = game.shafts[this.parent.dataset.id];
                                let rockFace = shaftObj.el.querySelector('.rock-face');
                                if (rockFace) {
                                    const rfRect = rockFace.getBoundingClientRect();
                                    // Impact is at the inner edge of the rock-face rounded shape
                                    const strikeX = (shaftObj.side === 'RIGHT') ? rfRect.right - 15 : rfRect.left + 15;
                                    const strikeY = rfRect.top + (rfRect.height * 0.4); // Strike slightly above middle
                                    game.spawnSparks(strikeX, strikeY, shaftObj.side);
                                }
                            }
                        } else {
                            this.load = this.stats.capacity;
                            this.flip(true);
                            this.setAnim('walk');
                            this.state = 'TO_BIN';
                        }
                        break;

                    case 'TO_BIN':
                        const reachBin = this.parent.classList.contains('right-side') ? (this.x < targetBinX) : (this.x > targetBinX);

                        if (reachBin) {
                            this.x += (this.parent.classList.contains('right-side') ? 1 : -1) * this.stats.speed * dt;
                        } else {
                            this.state = 'DEPOSIT';
                            game.shafts[this.parent.dataset.id].deposit(this.load);
                            this.load = 0;
                            this.state = 'IDLE';
                        }
                        break;
                }
                this.el.style.left = this.x + 'px';
            }
            setAnim(a) {
                this.el.classList.remove('anim-walk', 'anim-mine', 'anim-sit', 'working-mood');
                if (a) {
                    this.el.classList.add('anim-' + a);
                    // Add happy expression if walking or mining (not sitting/resting)
                    if (a === 'walk' || a === 'mine') {
                        this.el.classList.add('working-mood');
                    }
                }
            }
            flip(l) { this.el.querySelector('svg').style.transform = l ? 'scaleX(-1)' : 'scaleX(1)'; }

            updateDroppedGear(type) {
                if (this.lastDroppedType === type) return;
                this.lastDroppedType = type;
                if (type === 'PICKAXE') {
                    // Pickaxe lying on ground
                    this.droppedGear.innerHTML = `<svg width="40" height="40" viewBox="0 0 40 40" style="overflow:visible"><g transform="translate(10,25) rotate(-45)"><rect x="-2" y="-15" width="4" height="30" fill="#8D6E63" rx="1"/><path d="M-15 0 Q0 -10 15 0 L17 -5 Q0 -20 -17 -5 Z" fill="#CFD8DC" stroke="#546E7A" stroke-width="1"/></g></svg>`;
                } else {
                    // Sack sitting on ground
                    this.droppedGear.innerHTML = `<svg width="40" height="40" viewBox="0 0 40 40" style="overflow:visible">
                        <g transform="translate(5,20)">
                            <path d="M0 10 Q-5 25 5 35 Q15 40 25 30 Q30 15 20 5 Z" fill="#795548" stroke="#5D4037" stroke-width="1"/>
                            <path d="M5 15 Q15 25 20 10" fill="none" stroke="#5D4037" stroke-width="1" opacity="0.5"/>
                            <!-- Contents -->
                            <circle cx="12" cy="8" r="4" fill="#FFD54F" stroke="#FF6F00" stroke-width="1" />
                            <path d="M18 5 L22 0 L26 5 Z" fill="#00E5FF" opacity="0.8" />
                        </g>
                    </svg>`;
                }
            }
        }
        class Shaft {
            constructor(id, savedLevel, globalMult, side) {
                this.id = id; this.level = savedLevel || 1; this.bin = 0;
                this.globalMult = globalMult || 1;
                this.side = side || (id % 2 === 0 ? 'LEFT' : 'RIGHT');
                this.el = document.createElement('div');
                this.el.className = 'mine-shaft' + (this.side === 'RIGHT' ? ' right-side' : '');
                this.el.dataset.id = id;

                // Add 3D Floor
                let floor = document.createElement('div');
                floor.className = 'shaft-floor';
                this.el.appendChild(floor);

                // Add Tunnel Visual
                let tunnel = document.createElement('div');
                tunnel.className = 'shaft-tunnel';
                this.el.appendChild(tunnel);

                // Add Flickering Torches on the wooden beams
                [100, 300].forEach(tx => {
                    let torch = document.createElement('div');
                    torch.className = 'torch';
                    // Mirror position for right side
                    if (this.side === 'RIGHT') {
                        torch.style.right = tx + 'px';
                    } else {
                        torch.style.left = tx + 'px';
                    }
                    torch.innerHTML = `
                        <div class="torch-stick"></div>
                        <div class="torch-flame" style="animation-delay: ${Math.random() * -0.2}s"></div>
                        <div class="torch-glow" style="animation-delay: ${Math.random() * -2}s"></div>
                    `;
                    tunnel.appendChild(torch);
                });

                let binBox = document.createElement('div'); binBox.className = 'bin-box';
                // Status Light
                let statusLight = document.createElement('div'); statusLight.className = 'bin-status-light'; binBox.appendChild(statusLight);

                this.binBar = document.createElement('div'); this.binBar.className = 'bin-resource glint-effect';
                this.binBar.style.background = 'var(--gold-gem-gradient)';
                this.binBar.style.boxShadow = 'inset 0 0 10px rgba(0,0,0,0.5)';
                binBox.appendChild(this.binBar); this.el.appendChild(binBox);
                let rock = document.createElement('div'); rock.className = 'rock-face'; this.el.appendChild(rock);

                // Level Box with Stats
                let upg = document.createElement('div'); upg.className = 'shaft-level-box';

                // Calculate theoretical miner power for badge
                let theoreticalMiners = 1;
                if (this.level >= 25) theoreticalMiners = 2;
                if (this.level >= 50) theoreticalMiners = 3;

                upg.innerHTML = `
                    <div class="shaft-earnings-text" style="color:#FFF176; font-size:0.9rem; text-align:right; margin-bottom:2px;">$0/s</div>
                    <button class="btn-upgrade-simple">Lvl 1</button>
                    ${theoreticalMiners > 1 ? `<div class="worker-badge" style="position:absolute; top:-10px; right:-10px; background:#FF5252; color:white; font-size:0.8rem; padding:2px 5px; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.3); transform:rotate(15deg);">${theoreticalMiners}x</div>` : ''}
                `;
                upg.onclick = (e) => {
                    if (e.target.tagName !== 'BUTTON' && !e.target.closest('button')) return;
                    game.openUpgrade('SHAFT', this.id);
                };
                upg.querySelector('button').onclick = (e) => {
                    e.stopPropagation();
                    game.openUpgrade('SHAFT', this.id);
                };

                this.statText = upg.querySelector('.shaft-earnings-text');
                this.btn = upg.querySelector('button');
                this.el.appendChild(upg);

                if (this.side === 'RIGHT') {
                    $('#shafts-right-anchor').appendChild(this.el);
                } else {
                    $('#shafts-anchor').appendChild(this.el);
                }

                // MANAGER SLOT
                this.manager = null; // Instance
                this.dummyManagerUI = document.createElement('div');
                this.dummyManagerUI.className = 'manager-slot empty ' + (this.side === 'RIGHT' ? 'pos-shaft-manager-right' : 'pos-shaft-manager');
                this.dummyManagerUI.onclick = (e) => { e.stopPropagation(); game.openManagerHire('SHAFT', this.id); };
                this.el.appendChild(this.dummyManagerUI);

                // MINER MANAGEMENT: Array of miners
                this.miners = [];
                // First miner always exists
                this.miners.push(new Miner(this.el, 0));

                this.recalcStats(); this.updateBtn();
            }
            deposit(a) {
                this.bin += a; this.updateVis();
                const binX = (this.side === 'RIGHT' ? 460 : 140);
                game.createFloatText(a, binX, this.el.offsetTop + 60);
                game.audio.playSFX('coin');
            }

            take(a) { if (this.bin >= a) { this.bin -= a; this.updateVis(); return a; } let t = this.bin; this.bin = 0; this.updateVis(); return t; }
            updateVis() {
                let p = (this.bin / this.binCap) * 100;
                if (p > 100) p = 100;
                this.binBar.style.height = p + '%';
            }

            getCost() {
                // Cost also scales with depth significantly to balance the income
                // Increased depthMult from 2.2 to 5.0 as requested
                let depthMult = Math.pow(5.0, this.id);
                return Math.floor(CFG.baseCostShaft * Math.pow(1.3, this.level) * depthMult);
            }

            updateBtn() {
                this.btn.innerText = `Lvl ${this.level}`;

                // Calculate Theoretical $/s (Sum of all miners)
                const dist = 400;
                let totalPPS = 0;

                // Effective speed with Manager
                let mMult = this.manager ? this.manager.getSpeedMult() : 1;

                this.miners.forEach(m => {
                    const speed = m.stats.speed * mMult; // Apply projection
                    const walkTime = (dist / speed) * 2;
                    const mineTime = m.stats.capacity / m.stats.mineRate;
                    const cycleTime = walkTime + mineTime;
                    totalPPS += (m.stats.capacity / cycleTime);
                });

                // totalPPS already includes multipliers from stats
                this.statText.innerText = '$' + fmt(totalPPS) + '/s';

                // Update worker badge to show theoretical power level
                let existingBadge = this.el.querySelector('.worker-badge');
                let theoreticalMiners = 1;
                if (this.level >= 25) theoreticalMiners = 2;
                if (this.level >= 50) theoreticalMiners = 3;

                if (theoreticalMiners > 1) {
                    if (existingBadge) {
                        existingBadge.innerHTML = theoreticalMiners + 'x';
                    } else {
                        let badge = document.createElement('div');
                        badge.className = 'worker-badge';
                        badge.innerHTML = theoreticalMiners + 'x';
                        badge.style.cssText = 'position:absolute; top:-10px; right:-10px; background:#FF5252; color:white; font-size:0.8rem; padding:2px 5px; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.3); transform:rotate(15deg); animation: popIn 0.3s;';
                        this.el.querySelector('.shaft-level-box').appendChild(badge);
                    }
                } else if (existingBadge) {
                    existingBadge.remove();
                }
            }


            recalcStats() {
                // Base Stats
                let lvlMult = Math.pow(1.2, this.level);

                // Exponential Depth: REDUCED from 5^ID to 2.5^ID
                let depthMult = Math.pow(2.5, this.id);

                // Multipliers (Prestige + Boost)
                let boost = 1;
                try {
                    if (typeof game !== 'undefined' && game.boosts) {
                        // Incremental Boost: 1 + (Level * 0.1)
                        // Level 0 = 1x, Level 10 = 2x
                        boost = 1 + (game.boosts.earnings * 0.1);
                    }
                } catch (e) { } // Handle TDZ for 'game' during init

                let totalMult = this.globalMult * boost;

                // Calculate theoretical power level
                let theoreticalMiners = 1;
                if (this.level >= 25) theoreticalMiners = 2;
                if (this.level >= 50) theoreticalMiners = 3;

                // Max physical miners: 3
                let targetMiners = Math.min(theoreticalMiners, 3);
                // Power multiplier for each physical miner
                let powerMult = theoreticalMiners / targetMiners;

                // Add new miners if needed
                while (this.miners.length < targetMiners) {
                    let m = new Miner(this.el, this.miners.length);
                    this.miners.push(m);
                }

                // Speed cap at level 10 - only capacity increases after that
                // Reduced speed scaling: base 60, +1 per level
                let baseSpeed = 60 + (Math.min(this.level, 10) * 1); // Max speed: 70

                this.miners.forEach(m => {
                    m.stats.speed = baseSpeed;
                    const resMult = (typeof game !== 'undefined' && game.research) ? game.research.multipliers : { capacity: 1, mineRate: 1, binCap: 1 };
                    const mMult = this.manager ? this.manager.getSpeedMult() : 1;

                    m.stats.capacity = 50 * lvlMult * depthMult * totalMult * resMult.capacity * powerMult * mMult;
                    m.stats.mineRate = 20 * lvlMult * depthMult * totalMult * resMult.mineRate * powerMult * mMult;
                });

                // Dynamically calculate Bin Capacity based on TOTAL miner capacity
                // 5 full trips per miner to fill the bin
                const sampleMinerCap = 50 * lvlMult * depthMult * totalMult; // baseline cap
                const resMultBin = (typeof game !== 'undefined' && game.research) ? game.research.multipliers.binCap : 1;
                this.binCap = (targetMiners * sampleMinerCap * 5) * resMultBin;
            }

            update(dt, globalMult) {
                if (this.manager) this.manager.update(dt);
                // Miner visual speed is unaffected by managers now
                this.miners.forEach(m => m.update(dt * globalMult, (this.side === 'RIGHT' ? 60 : 540)));
            }
            assignManager(type) {
                if (this.manager) this.manager.removeUI();
                this.manager = new Manager(type, 'SHAFT');
                this.dummyManagerUI.style.display = 'none'; // Hide the empty placeholder
                this.manager.createUI(this.el, (this.side === 'RIGHT' ? 'pos-shaft-manager-right' : 'pos-shaft-manager'));
                this.manager.setHireCallback(() => game.openManagerHire('SHAFT', this.id));
                this.manager.setStateChangeCallback(() => {
                    this.recalcStats();
                    this.updateBtn();
                });
            }
            upgrade() {
                const oldLevel = this.level;
                this.level++;
                this.recalcStats();
                this.updateBtn();

                // MILESTONE REWARDS
                const milestones = [
                    { l: 10, r: 2 },
                    { l: 25, r: 5 },
                    { l: 50, r: 10 },
                    { l: 100, r: 20 },
                    { l: 200, r: 50 }
                ];

                milestones.forEach(m => {
                    if (oldLevel < m.l && this.level >= m.l) {
                        // Reached Milestone
                        game.superCash += m.r;
                        // Delayed slightly to not overlap with cost popup if any
                        setTimeout(() => {
                            game.createFloatText(`ðŸ’Ž +${m.r}`, 300, 150 + (this.id * 160)); // Approximate shaft height position
                            game.audio.playSFX('diamond');
                        }, 200);

                        // Force UI refresh for currency
                        $('#txt-supercash').innerText = game.superCash;
                        // Pulse the SuperCash UI
                        $('.currency-pill').forEach(el => {
                            if (el.innerHTML.includes('txt-supercash')) {
                                el.classList.remove('pulse');
                                void el.offsetWidth;
                                el.classList.add('pulse');
                            }
                        });
                    }
                });

                game.saveGame();
            }
        }

        class Elevator {
            constructor() {
                this.y = 0;
                this.state = 'DOWN';
                this.load = 0;
                this.cap = 200;
                this.speed = 40; // Reduced base speed to 40
                this.loadRate = 50; // Units per second that can be loaded
                this.currentShaft = -1; // Track which shaft we're loading from
                this.el = $('#elevator-cabin');
                this.fillEl = $('#elevator-fill');
                this.level = 1;

                // Add Floodlight
                this.light = document.createElement('div');
                this.light.className = 'light-source elevator-light';
                this.el.appendChild(this.light);

                // Manager
                this.manager = null;
                this.dummyManagerUI = document.createElement('div');
                this.dummyManagerUI.className = 'manager-slot empty pos-ele-manager';
                this.dummyManagerUI.onclick = (e) => { e.stopPropagation(); game.openManagerHire('ELE', null); };
                $('.elevator-shaft').appendChild(this.dummyManagerUI); // Attach to shaft container, not cabin
            }
            assignManager(type) {
                if (this.manager) this.manager.removeUI();
                this.manager = new Manager(type, 'ELE');
                this.dummyManagerUI.style.display = 'none';
                this.manager.createUI($('.elevator-shaft'), 'pos-ele-manager');
                this.manager.setHireCallback(() => game.openManagerHire('ELE', null));
                this.manager.setStateChangeCallback(() => {
                    // Elevator updates stats in real-time in update() loop, but we can play a sound or trigger UI
                    console.log("Elevator Manager State Changed");
                });
            }
            update(dt, globalMult) {
                // Dim/Brighten Light
                if (game.dayNight) this.light.style.opacity = game.dayNight.getNightIntensity();

                // Manager Update (Real Time)
                if (this.manager) this.manager.update(dt);

                let mMult = this.manager ? this.manager.getSpeedMult() : 1;
                let resMult = (typeof game !== 'undefined' && game.research) ? game.research.multipliers.loadRate : 1;

                // Effective stats
                let effSpeed = this.speed * globalMult;
                let effCap = this.cap * mMult;
                let effLoadRate = this.loadRate * mMult * globalMult * resMult;

                let depthCount = Math.ceil(game.shafts.length / 2);
                let bottom = (depthCount * (CFG.shaftH + CFG.shaftGap));

                if (this.state === 'DOWN') {
                    this.y += effSpeed * dt;
                    // ANIMATION STATE
                    this.el.classList.add('move-down');
                    this.el.classList.remove('move-up', 'moving');

                    // Sound
                    game.audio.startLoop('eleMove');

                    if (this.y >= bottom - 80) {
                        this.state = 'UP';
                        this.el.classList.remove('moving');
                        this.el.parentElement.classList.remove('moving');
                        game.audio.playSFX('eleArrival');
                        game.audio.stopLoop('eleMove');
                    } else {
                        this.el.classList.add('moving');
                        this.el.parentElement.classList.add('moving');
                    }
                } else if (this.state === 'UP') {
                    this.y -= effSpeed * dt;
                    // ANIMATION STATE
                    this.el.classList.add('move-up');
                    this.el.classList.remove('move-down', 'moving');

                    // Sound
                    game.audio.startLoop('eleMove');

                    // Check each shaft for potential loading
                    game.shafts.forEach((s, i) => {
                        let depth = Math.floor(i / 2);
                        let sY = depth * (CFG.shaftH + CFG.shaftGap) + 50;

                        // If we're near a shaft and have room and shaft has resources
                        if (Math.abs(this.y - sY) < 15 && this.load < effCap && s.bin > 0) {
                            // Stop and enter LOADING state
                            if (this.state === 'UP' && this.currentShaft !== i) {
                                this.state = 'LOADING';
                                this.currentShaft = i;
                                this.y = sY; // Snap to exact position
                                // Remove anim classes when stopped
                                this.el.classList.remove('move-up', 'move-down', 'moving');
                                this.el.parentElement.classList.remove('moving');

                                // Sound
                                game.audio.playSFX('eleArrival');
                                game.audio.stopLoop('eleMove');
                            }
                        }
                    });

                    if (this.y <= 0) {
                        this.y = 0;
                        game.elevDepot += this.load;
                        this.load = 0;
                        this.updateVis(effCap);
                        this.state = 'DOWN';
                        this.currentShaft = -1;
                        this.el.classList.remove('move-up', 'moving'); // Will switch to DOWN next frame
                        this.el.parentElement.classList.remove('moving');

                        // Sound
                        game.audio.stopLoop('eleMove');
                        game.audio.playSFX('eleArrival');
                    } else {
                        this.el.classList.add('moving');
                        this.el.parentElement.classList.add('moving');
                    }
                } else if (this.state === 'LOADING') {
                    // IDLE/LOADING -> No movement classes
                    this.el.classList.remove('move-up', 'move-down');
                    // Loading state - load at specific rate
                    let shaft = game.shafts[this.currentShaft];
                    if (shaft && shaft.bin > 0 && this.load < effCap) {
                        let room = effCap - this.load;
                        let canLoad = effLoadRate * dt; // How much we can load this frame
                        let available = Math.min(shaft.bin, canLoad);
                        let toLoad = Math.min(room, available);

                        if (toLoad > 0) {
                            shaft.bin -= toLoad;
                            shaft.updateVis();
                            this.load += toLoad;
                            this.updateVis(effCap);
                        } else {
                            // Done loading this shaft, continue up
                            this.state = 'UP';
                        }
                    } else {
                        // No more to load or full, continue up
                        this.state = 'UP';
                    }
                }

                this.el.style.top = this.y + 'px';
                $('#ele-cable').style.height = (Math.max(0, this.y + 10)) + 'px';

                // Visual feedback for loading state
                if (this.state === 'LOADING') {
                    this.el.style.filter = 'brightness(1.3)';
                } else {
                    this.el.style.filter = 'brightness(1)';
                }
            }
            updateVis(customCap) {
                let c = customCap || this.cap;
                let p = (this.load / c) * 100;
                if (p > 100) p = 100;
                this.fillEl.style.height = (p * 0.5) + 'px';
            }
            upgrade() {
                this.level++;
                this.cap *= 1.3;
                // Speed cap at level 11 - only capacity increases after that
                if (this.level <= 11) {
                    this.speed += 2; // Increment speed by 2
                }
                // Load rate increases exponentially to match capacity (keeps load time ~4s)
                this.loadRate = 50 * Math.pow(1.3, this.level - 1);
                $('#btn-ele').innerText = `Lvl ${this.level}`;
                game.saveGame();
            }
            loadState(lvl) {
                this.level = lvl;
                this.cap = 200 * Math.pow(1.3, lvl - 1);
                // Speed cap at level 11
                this.speed = 40 + (2 * Math.min(lvl - 1, 10));
                // Load rate increases exponentially with level
                this.loadRate = 50 * Math.pow(1.3, lvl - 1);
                $('#btn-ele').innerText = `Lvl ${this.level}`;
            }
        }

        class Warehouse {
            // Updated Warehouse Coords for 1200px Layout
            constructor() {
                this.transporters = [];
                this.level = 1;
                this.depotVis = $('#depot-fill');

                // Window Glows - Matched to new Hanging Lamps (Lamps at x=60 and x=260, y=58)
                this.glows = [];
                // Center 30px glow
                this.addGlow(45, 43); // 58 - 15 = 43
                this.addGlow(245, 43);

                // Add Back Wall Glow (The Singularity)
                let g = document.createElement('div');
                g.className = 'warehouse-window-glow';
                g.style.left = '145px'; g.style.top = '65px'; // Center 160,80 -> -15,-15
                g.style.width = '30px'; g.style.height = '30px';
                g.style.borderRadius = '50%';
                g.style.background = '#00B0FF';
                g.style.boxShadow = '0 0 30px #00E5FF';
                $('.warehouse-visual').appendChild(g);
                this.glows.push(g);

                // Manager
                this.manager = null; // Instance
                this.dummyManagerUI = document.createElement('div');
                this.dummyManagerUI.className = 'manager-slot empty pos-wh-manager';
                this.dummyManagerUI.onclick = (e) => { e.stopPropagation(); game.openManagerHire('WH', null); };
                // Append to FRONT layer
                $('.warehouse-front').appendChild(this.dummyManagerUI);

                // Spawn initial transporter so cart moves from the start
                this.spawnTransporter();
            }
            assignManager(type) {
                if (this.manager) this.manager.removeUI();
                this.manager = new Manager(type, 'WH');
                this.dummyManagerUI.style.display = 'none';
                // Append real manager to FRONT layer so it's visible on top of house
                this.manager.createUI($('.warehouse-front'), 'pos-wh-manager');
                this.manager.setHireCallback(() => game.openManagerHire('WH', null));
                this.manager.setStateChangeCallback(() => {
                    this.applyStats();
                });
            }
            addGlow(x, y) {
                let g = document.createElement('div');
                g.className = 'warehouse-window-glow';
                g.style.left = x + 'px';
                g.style.top = y + 'px';
                g.style.width = '30px';
                g.style.height = '30px';
                $('.warehouse-visual').appendChild(g);
                this.glows.push(g);
            }
            spawnTransporter() {
                // Initialize as IDLE
                let t = { el: document.createElement('div'), x: 1210, state: 'IDLE', load: 0, cap: 300, speed: 45 };
                t.el.className = 'character-transporter'; t.el.innerHTML = getCartSVG();
                $('#surface-angels-layer').appendChild(t.el); this.transporters.push(t);

                // Add Light (Lantern on Cart)
                let l = document.createElement('div');
                l.className = 'light-source';
                l.style.width = '80px'; l.style.height = '80px';
                l.style.left = '10px'; l.style.top = '-20px'; // Position on cart
                t.el.appendChild(l);

                this.applyStats();
            }
            update(dt, globalMult) {
                if (this.manager) this.manager.update(dt);
                let dP = (game.elevDepot / 1000) * 100; if (dP > 100) dP = 100; this.depotVis.style.height = dP + '%';
                // Toggle glows based on night
                let intensity = game.dayNight ? game.dayNight.getNightIntensity() : 0;
                this.glows.forEach(g => g.style.opacity = intensity);

                this.transporters.forEach(t => {
                    // Warehouse visual speed is unaffected by managers now
                    let effSpeed = t.speed * globalMult;

                    // Update light opacity
                    let l = t.el.querySelector('.light-source');
                    if (l) l.style.opacity = intensity;

                    let elevX = 800; // Dropoff Point (on the grass right of elevator at 1400px world)
                    let homeX = 1210; // Home Point (Deep inside new warehouse)
                    let cartPile = t.el.querySelector('.ore-pile');

                    if (t.state === 'IDLE') {
                        t.el.classList.remove('anim-walk');
                        game.audio.stopLoop('cartMove');
                        if (game.elevDepot > 0) t.state = 'TO_ELEV';
                    }
                    else if (t.state === 'TO_ELEV') {
                        t.el.querySelector('.guy').style.transform = 'scaleX(1) translate(0,0)';
                        t.el.querySelector('.cart').style.transform = 'translate(0, 35px)';
                        t.el.classList.add('anim-walk');
                        game.audio.startLoop('cartMove');

                        if (t.x > elevX) t.x -= effSpeed * dt; else {
                            let room = t.cap - t.load; let taken = Math.min(game.elevDepot, room);
                            game.elevDepot -= taken; t.load = taken;
                            cartPile.style.transform = `scaleY(${t.load > 0 ? 1 : 0})`; t.state = 'TO_HOME';
                        }
                    } else {
                        t.el.querySelector('svg').style.transform = 'scaleX(-1)';
                        game.audio.startLoop('cartMove');

                        if (t.x < homeX) t.x += effSpeed * dt; else {
                            if (t.load > 0) {
                                const researchMult = (this.research) ? this.research.multipliers.globalEarnings : 1;
                                const income = t.load * researchMult;
                                game.addMoney(income);
                                // JUICINESS: Spawn Flying Coins
                                game.spawnFlyingMoney(t.x + 30, 200, Math.min(5, Math.ceil(t.load / 10))); // Spawn up to 5 coins visual
                                game.createFloatText(income, 1210, 160);
                                game.audio.playSFX('unload');
                            }
                            t.load = 0; cartPile.style.transform = `scaleY(0)`; t.el.querySelector('svg').style.transform = 'scaleX(1)';
                            game.audio.stopLoop('cartMove');

                            // Creating smart loop - only go if needed
                            if (game.elevDepot > 0) t.state = 'TO_ELEV';
                            else t.state = 'IDLE';
                        }
                    }
                    t.el.style.left = t.x + 'px';
                });
            }
            applyStats() {
                let baseCap = 300 * Math.pow(1.3, this.level - 1);
                // Speed cap at level 15 - only capacity increases after that
                let baseSpd = 30 * Math.pow(1.02, Math.min(this.level - 1, 14)); // Reduced base speed and scaling

                // COMPENSATION: Fewer carts -> Higher Capacity per cart
                let intendedCount = 1 + Math.floor((this.level - 1) / 5);
                let actualCount = this.transporters.length;
                let compMult = (actualCount > 0) ? (intendedCount / actualCount) : 1;

                const resMult = (typeof game !== 'undefined' && game.research) ? game.research.multipliers.whCapacity : 1;
                const mMult = this.manager ? this.manager.getSpeedMult() : 1;
                this.transporters.forEach(t => { t.cap = baseCap * compMult * resMult * mMult; t.speed = baseSpd; });
            }
            upgrade() {
                this.level++;
                if (this.transporters.length < 2 && (this.level - 1) % 5 === 0) this.spawnTransporter();
                this.applyStats();
                $('#btn-wh').innerText = `Lvl ${this.level}`;
                game.saveGame();
            }
            loadState(lvl) {
                this.level = lvl;
                let intendedCount = 1 + Math.floor((lvl - 1) / 5);
                let visualCount = Math.min(intendedCount, 2);
                while (this.transporters.length < visualCount) this.spawnTransporter();
                if (this.transporters.length === 0) this.spawnTransporter();
                this.applyStats();
                $('#btn-wh').innerText = `Lvl ${this.level}`;
            }
        }

        class DayNightManager {
            constructor() {
                this.time = 8; // Start at 8 AM
                this.dayDuration = 60; // seconds for full 24h
                this.overlay = $('#night-overlay');
                this.sky = $('.sky-area');
                this.sky = $('.sky-area');
                this.currentIntensity = 0;
                this.theme = { dayTop: '#4FC3F7', dayBot: '#B3E5FC' };
            }
            setTheme(top, bot) {
                this.theme.dayTop = top;
                this.theme.dayBot = bot;
                this.applyVisuals();
            }
            update(dt) {
                this.time += (dt / this.dayDuration) * 24;
                if (this.time >= 24) this.time = 0;

                this.applyVisuals();
            }
            applyVisuals() {
                // 0-5 Night, 5-8 Sunrise, 8-18 Day, 18-21 Sunset, 21-24 Night
                let opacity = 0;
                let skyColor = this.theme.dayTop; // Default Day

                if (this.time < 5) { // Late Night
                    opacity = 0.7;
                    skyColor = "#0D47A1";
                } else if (this.time < 8) { // Sunrise
                    let t = (this.time - 5) / 3; // 0 to 1
                    opacity = 0.7 - (t * 0.7);
                    skyColor = this.lerpColor("#0D47A1", this.theme.dayTop, t);
                } else if (this.time < 18) { // Day
                    opacity = 0;
                    skyColor = this.theme.dayTop;
                } else if (this.time < 21) { // Sunset
                    let t = (this.time - 18) / 3;
                    opacity = t * 0.5; // Start darkening
                    skyColor = this.lerpColor(this.theme.dayTop, "#FF6F00", t);
                } else { // Night
                    let t = (this.time - 21) / 3;
                    opacity = 0.5 + (t * 0.2); // 0.5 -> 0.7
                    skyColor = this.lerpColor("#FF6F00", "#0D47A1", t);
                }

                this.currentIntensity = opacity > 0.1 ? 1 : 0; // Cache for lights
                this.overlay.style.opacity = opacity;
                this.sky.style.background = `linear-gradient(to bottom, ${skyColor}, ${this.theme.dayBot})`;
            }
            getNightIntensity() {
                return this.currentIntensity;
            }
            lerpColor(a, b, amount) {
                var ah = parseInt(a.replace(/#/g, ''), 16),
                    ar = ah >> 16, ag = ah >> 8 & 0xff, ab = ah & 0xff,
                    bh = parseInt(b.replace(/#/g, ''), 16),
                    br = bh >> 16, bg = bh >> 8 & 0xff, bb = bh & 0xff,
                    rr = ar + amount * (br - ar),
                    rg = ag + amount * (bg - ag),
                    rb = ab + amount * (bb - ab);
                return '#' + ((1 << 24) + (rr << 16) + (rg << 8) + (rb | 0)).toString(16).slice(1);
            }
        }

        // --- AUDIO SYSTEM ---
        class AudioSystem {
            constructor() {
                this.bgm = new Audio('audio/Gamesound.mp3');
                this.bgm.loop = true;

                // Research Music
                this.researchMusic = new Audio('audio/Researchmusik.mp3');
                this.researchMusic.loop = true;
                this.researchMusic.volume = 0;

                // Invasion BGM
                this.invasionBgm = new Audio('audio/Koboldmusik.mp3');
                this.invasionBgm.loop = true;
                this.invasionBgm.volume = 0;

                this.fadeIntervals = new Map(); // Track intervals per audio object

                // SFX POOL
                this.sfx = {
                    coin: new Audio('audio/Coin.mp3'),
                    error: new Audio('audio/Error.mp3'),
                    mine: new Audio('audio/Miningsound.mp3'),
                    newWorld: new Audio('audio/Newworldsound.mp3'),
                    upgrade: new Audio('audio/Upgradebutton.mp3'),
                    koboldsound: new Audio('audio/Koboldsound.mp3'),
                    diamond: new Audio('audio/Diamond.mp3'),
                    eleMove: new Audio('audio/Elevatormovesound 2.mp3'),
                    eleArrival: new Audio('audio/Elevatorarrivalsound 2.mp3'),
                    cartMove: new Audio('audio/Warehousecartmove.mp3'),
                    unload: new Audio('audio/Unloading.mp3'),
                    helicopter: new Audio('audio/helicopter.mp3')
                };

                this.sfx.eleMove.loop = true;
                this.sfx.cartMove.loop = true;
                this.sfx.helicopter.loop = true;

                // Shop Music (Exclusive Loop)
                this.shopMusic = new Audio('audio/Shopsound.mp3');
                this.shopMusic.loop = true;

                // Throttling for mining sounds
                this.lastMineSound = 0;

                this.isShopMode = false;
                this.duckingMultiplier = 1.0; // 1.0 = normal, < 1.0 = ducked

                // Load separate settings
                this.musicEnabled = localStorage.getItem('idleMinerMusicEnabled') !== 'false'; // Default true
                this.sfxEnabled = localStorage.getItem('idleMinerSFXEnabled') !== 'false'; // Default true
                this.musicVolume = parseFloat(localStorage.getItem('idleMinerMusicVolume') || '0.5'); // 0-1
                this.sfxVolume = parseFloat(localStorage.getItem('idleMinerSFXVolume') || '0.6'); // 0-1

                // Legacy support (old 'enabled' key)
                if (localStorage.getItem('idleMinerSound') === 'false') {
                    this.musicEnabled = false;
                    this.sfxEnabled = false;
                }

                this.initialized = false;

                // Apply volumes
                this.updateVolumes();
            }

            updateVolumes() {
                this.bgm.volume = this.musicEnabled ? this.musicVolume : 0;
                this.shopMusic.volume = this.musicEnabled ? this.musicVolume : 0;
                this.researchMusic.volume = this.musicEnabled ? this.musicVolume : 0;
                this.invasionBgm.volume = this.musicEnabled ? this.musicVolume : 0;
            }

            setMusicVolume(v) {
                this.musicVolume = Math.max(0, Math.min(1, v));
                localStorage.setItem('idleMinerMusicVolume', this.musicVolume);
                this.updateVolumes();
            }

            setSFXVolume(v) {
                this.sfxVolume = Math.max(0, Math.min(1, v));
                localStorage.setItem('idleMinerSFXVolume', this.sfxVolume);
            }

            duckSFX(isDucked) {
                this.duckingMultiplier = isDucked ? 0.2 : 1.0;
                // Update active loops immediately
                if (this.sfxEnabled) {
                    if (!this.sfx.eleMove.paused) this.sfx.eleMove.volume = (0.2) * this.sfxVolume * this.duckingMultiplier;
                    if (!this.sfx.cartMove.paused) this.sfx.cartMove.volume = (0.2) * this.sfxVolume * this.duckingMultiplier;
                }
            }

            // FADE IN Invasion Music
            startInvasionMusic() {
                if (!this.musicEnabled) return;
                this.invasionBgm.currentTime = 0;
                this.invasionBgm.play().catch(e => console.log("Invasion music failed", e));
                this.fadeIn(this.invasionBgm, 0.5);
                this.fadeOut(this.bgm);
            }

            stopInvasionMusic() {
                this.fadeOut(this.invasionBgm);
                if (this.musicEnabled) {
                    this.bgm.play().catch(e => { });
                    this.fadeIn(this.bgm, this.musicVolume);
                }
            }

            startResearchMusic() {
                if (!this.musicEnabled) return;
                this.researchMusic.currentTime = 0;
                this.researchMusic.play().catch(e => console.log("Research music failed", e));
                this.fadeIn(this.researchMusic, this.musicVolume);
                this.fadeOut(this.bgm);
            }

            stopResearchMusic() {
                this.fadeOut(this.researchMusic);
                if (this.musicEnabled) {
                    this.bgm.play().catch(e => { });
                    this.fadeIn(this.bgm, this.musicVolume);
                }
            }

            fadeIn(audio, targetVol) {
                if (this.fadeIntervals.has(audio)) {
                    clearInterval(this.fadeIntervals.get(audio));
                }

                if (audio.paused) audio.play().catch(e => { });

                let interval = setInterval(() => {
                    let vol = audio.volume;
                    vol += 0.05;
                    if (vol >= targetVol) {
                        vol = targetVol;
                        clearInterval(interval);
                        this.fadeIntervals.delete(audio);
                    }
                    audio.volume = vol;
                }, 100);
                this.fadeIntervals.set(audio, interval);
            }

            fadeOut(audio, durationMs = 1000) {
                if (this.fadeIntervals.has(audio)) {
                    clearInterval(this.fadeIntervals.get(audio));
                }

                const steps = 20;
                const intervalTime = durationMs / steps;
                const volStep = audio.volume / steps;

                let interval = setInterval(() => {
                    let vol = audio.volume;
                    vol -= volStep;
                    if (vol <= 0) {
                        vol = 0;
                        audio.pause();
                        clearInterval(interval);
                        this.fadeIntervals.delete(audio);
                    }
                    audio.volume = Math.max(0, vol);
                }, intervalTime);
                this.fadeIntervals.set(audio, interval);
            }

            init() {
                // Try to autoplay immediately
                this.tryAutoplay();

                // Fallback: If autoplay is blocked, wait for user interaction
                const startAudio = () => {
                    if (!this.initialized) {
                        this.initialized = true;
                        if (this.musicEnabled) this.playBGM();
                    }
                    document.removeEventListener('click', startAudio);
                    document.removeEventListener('touchstart', startAudio);
                };
                document.addEventListener('click', startAudio);
                document.addEventListener('touchstart', startAudio);
            }

            tryAutoplay() {
                if (!this.musicEnabled) return;
                // Attempt autoplay with muted start, then unmute
                this.bgm.volume = 0;
                this.bgm.play().then(() => {
                    this.initialized = true;
                    // Fade in from 0 to target volume
                    let vol = 0;
                    const fade = setInterval(() => {
                        vol += 0.05;
                        const targetVol = this.musicVolume;
                        if (vol >= targetVol) { vol = targetVol; clearInterval(fade); }
                        this.bgm.volume = vol;
                    }, 100);
                }).catch(e => {
                    // Autoplay blocked - will wait for user interaction
                    console.log("Autoplay blocked, waiting for user interaction");
                });
            }

            playBGM() {
                if (!this.musicEnabled) return;
                this.bgm.volume = 0;
                this.bgm.play().then(() => {
                    let vol = 0;
                    const fade = setInterval(() => {
                        vol += 0.05;
                        const targetVol = this.musicVolume;
                        if (vol >= targetVol) { vol = targetVol; clearInterval(fade); }
                        this.bgm.volume = vol;
                    }, 100);
                }).catch(e => console.warn("Audio play blocked", e));
            }

            playSFX(id, rate = 1.0) {
                if (!this.sfxEnabled) return;
                // if (this.isShopMode) return; // Allow upgrades in modal!

                // Throttling for mining trigger
                if (id === 'mine') {
                    const now = Date.now();
                    if (now - this.lastMineSound < 150) return; // Limit to ~6 per sec
                    this.lastMineSound = now;
                }

                const src = this.sfx[id];
                if (src) {
                    // Clone to allow overlap
                    const clone = src.cloneNode();
                    clone.playbackRate = rate; // Apply pitch
                    // Preserves Pitch? No, we WANT pitch shift! (default is preservesPitch=true in some browsers, but purely rate change usually shifts pitch)
                    if (clone.preservesPitch !== undefined) clone.preservesPitch = false;

                    const baseVol = (id === 'mine') ? 0.3 : 0.6; // Lower volume for frequent mining
                    clone.volume = baseVol * this.sfxVolume * this.duckingMultiplier; // Apply SFX volume multiplier and ducking
                    if (id === 'error') clone.volume = 0.8 * this.sfxVolume * this.duckingMultiplier;
                    clone.play().catch(e => { });
                    return clone; // Return individual instance for control
                }
            }

            // Persistence for looping sound states
            startLoop(id, volMult = 1.0) {
                if (!this.sfxEnabled) return;
                const src = this.sfx[id];
                if (src) {
                    let baseVol = 0.5;
                    if (id === 'eleMove' || id === 'cartMove') baseVol = 0.2;
                    if (id === 'helicopter') baseVol = 0.25; // 50% lower than default 0.5

                    src.volume = baseVol * this.sfxVolume * volMult * this.duckingMultiplier;
                    if (src.paused) src.play().catch(e => { });
                }
            }

            stopLoop(id) {
                const src = this.sfx[id];
                if (src) {
                    if (this.fadeIntervals && this.fadeIntervals.has(src)) {
                        clearInterval(this.fadeIntervals.get(src));
                        this.fadeIntervals.delete(src);
                    }
                    if (!src.paused) {
                        src.pause();
                        src.currentTime = 0;
                    }
                }
            }

            enterShop() {
                if (!this.musicEnabled) return;
                this.isShopMode = true;
                this.bgm.pause();
                this.shopMusic.currentTime = 0;
                this.shopMusic.volume = this.musicVolume;
                this.shopMusic.play().catch(e => { });
            }

            exitShop() {
                this.isShopMode = false;
                this.shopMusic.pause();
                if (this.musicEnabled) this.bgm.play().catch(e => { });
            }

            toggleMusic() {
                this.musicEnabled = !this.musicEnabled;
                localStorage.setItem('idleMinerMusicEnabled', this.musicEnabled);
                this.updateVolumes();

                if (this.musicEnabled) {
                    if (this.isShopMode) this.shopMusic.play();
                    else if (this.initialized) this.bgm.play();
                } else {
                    this.bgm.pause();
                    this.shopMusic.pause();
                }
                return this.musicEnabled;
            }

            toggleSFX() {
                this.sfxEnabled = !this.sfxEnabled;
                localStorage.setItem('idleMinerSFXEnabled', this.sfxEnabled);
                return this.sfxEnabled;
            }

            // Legacy toggle method (for compatibility)
            toggle() {
                this.musicEnabled = !this.musicEnabled;
                this.sfxEnabled = !this.sfxEnabled;
                localStorage.setItem('idleMinerMusicEnabled', this.musicEnabled);
                localStorage.setItem('idleMinerSFXEnabled', this.sfxEnabled);
                this.updateVolumes();

                if (this.musicEnabled) {
                    if (this.isShopMode) this.shopMusic.play();
                    else if (this.initialized) this.bgm.play();
                } else {
                    this.bgm.pause();
                    this.shopMusic.pause();
                }
                return this.musicEnabled;
            }
        }






        /* --- MISSION SYSTEM LOGIC --- */
        class Mission {
            constructor(id, type, target, reward) {
                this.id = id;
                this.type = type;
                // types: 'SHAFT_LEVEL', 'EARN_CASH', 'BUY_MANAGER', 'ACTIVATE_MANAGER', 'HIRE_MINER'
                this.target = target;
                // target formats:
                // SHAFT_LEVEL: { id: 0, val: 50 }
                // EARN_CASH: { val: 1000 }  (Accumulated during mission)
                // BUY_MANAGER: { val: 1 } (Buy 1 more)
                // ACTIVATE_MANAGER: { val: 5 } (Activate skills 5 times)

                this.reward = reward; // { type: 'SC', val: 5 } or { type: 'CASH', val: 100 }
                this.progress = 0;
                this.goal = (typeof target.val === 'number') ? target.val : 0;
                this.completed = false;
                this.claimed = false;
                this.desc = this.generateDescription();
                this.icon = this.getIcon();
            }

            generateDescription() {
                switch (this.type) {
                    case 'SHAFT_LEVEL': return `Reach Shaft ${this.target.id + 1} Level ${this.target.val}`;
                    case 'EARN_CASH': return `Earn $${fmt(this.target.val)} Cash`;
                    case 'BUY_MANAGER': return `Hire ${this.target.val} New Managers`;
                    case 'ACTIVATE_MANAGER': return `Activate Managers ${this.target.val} Times`;
                    case 'HIRE_MINER': return `Hire workers in Shaft ${this.target.id + 1}`;
                    default: return 'Unknown Mission';
                }
            }

            getIcon() {
                switch (this.type) {
                    case 'SHAFT_LEVEL': return 'â›ï¸';
                    case 'EARN_CASH': return 'ðŸ’°';
                    case 'BUY_MANAGER': return 'ðŸ‘”';
                    case 'ACTIVATE_MANAGER': return 'âš¡';
                    case 'HIRE_MINER': return 'ðŸ‘·';
                    default: return 'â“';
                }
            }

            check(game) {
                if (this.completed) return;

                if (this.type === 'SHAFT_LEVEL') {
                    if (game.shafts[this.target.id] && game.shafts[this.target.id].level >= this.target.val) {
                        this.complete();
                    }
                    this.progress = (game.shafts[this.target.id]) ? game.shafts[this.target.id].level : 0;
                }
                else if (this.type === 'EARN_CASH') {
                    if (game.money >= this.target.val) {
                        this.complete(); // Still auto-complete if (somehow) current balance meets it
                    }
                    // Progress is now handled by increment() via onMoneyEarned
                }
                else if (this.type === 'ACTIVATE_MANAGER' || this.type === 'BUY_MANAGER') {
                    // event based
                    if (this.progress >= this.target.val) this.complete();
                }
            }

            increment(amount = 1) {
                if (this.completed) return;
                this.progress += amount;
                if (this.progress >= this.target.val) this.complete();
            }

            complete() {
                this.completed = true;
                this.progress = this.goal; // Cap visual
            }
        }

        class MissionController {
            constructor(game) {
                this.game = game;
                this.missions = []; // 3 slots
                this.maxMissions = 3;
                this.widget = null;
                this.listContainer = null;
                this.compactHeader = null;
                this.isExpanded = false;

                // Create UI
                this.createUI();

                this.lastUIUpdate = 0; // Throttle timestamp

                // Init Missions (if empty)
                this.fillMissions();
            }

            onMoneyEarned(amount) {
                let changed = false;
                this.missions.forEach(m => {
                    if (!m.completed && !m.claimed && m.type === 'EARN_CASH') {
                        m.increment(amount);
                        changed = true;
                    }
                });
                if (changed) this.updateUI(); // Reflect changes immediately
            }

            createUI() {
                // Widget Container
                this.widget = document.createElement('div');
                this.widget.className = 'mission-widget';

                // Compact Header (Serves as Toggle)
                this.compactHeader = document.createElement('div');
                this.compactHeader.className = 'mission-header-compact';
                this.compactHeader.innerHTML = `
                    <div class="mission-icon-main">ðŸŽ¯</div>
                    <div class="mission-info-compact">
                        <div class="mission-title-compact">Loading...</div>
                        <div class="mission-progress-bg"><div class="mission-progress-fill"></div></div>
                    </div>
                    <div class="mission-toggle-btn">â–¼</div>
                `;
                this.compactHeader.onclick = (e) => {
                    e.stopPropagation();
                    this.toggleExpand();
                };
                this.widget.onclick = () => {
                    // Mobile: Tap wrapper to expand if collapsed
                    if (window.innerWidth <= 768 && !this.isExpanded) {
                        this.toggleExpand();
                    }
                };

                this.widget.appendChild(this.compactHeader);

                // Expanded List
                this.listContainer = document.createElement('div');
                this.listContainer.className = 'mission-list-container';
                this.widget.appendChild(this.listContainer);

                document.body.appendChild(this.widget);
            }

            toggleExpand() {
                this.isExpanded = !this.isExpanded;
                if (this.isExpanded) {
                    this.widget.classList.add('expanded');
                    this.renderList();
                } else {
                    this.widget.classList.remove('expanded');
                }
            }

            fillMissions() {
                while (this.missions.length < this.maxMissions) {
                    this.missions.push(this.generateMission());
                }
                this.updateUI(true); // Initial Render (Forced)
            }

            generateMission() {
                const types = ['SHAFT_LEVEL', 'EARN_CASH', 'ACTIVATE_MANAGER']; // BUY_MANAGER removed for simplicity for now
                const type = types[Math.floor(Math.random() * types.length)];
                let target = {};
                let reward = { type: 'SC', val: 2 + Math.floor(Math.random() * 5) }; // 2-6 SC

                // Difficulty scaling based on current progress
                // We need safe checks if game is initialized
                const deepestShaftId = this.game.shafts.length - 1;
                const lastShaft = this.game.shafts[deepestShaftId];

                if (type === 'SHAFT_LEVEL') {
                    // Pick a random unlocked shaft
                    const sId = Math.floor(Math.random() * this.game.shafts.length);
                    const currentLvl = this.game.shafts[sId].level;
                    // Goal is current + 10 to 50
                    const add = 10 + Math.floor(Math.random() * 40);
                    target = { id: sId, val: currentLvl + add };
                    reward.val = 5 + Math.floor(add / 5);
                }
                else if (type === 'EARN_CASH') {
                    // 10x to 100x current money OR generation rate * 300s
                    let current = this.game.money;
                    if (current < 100) current = 100;
                    target = { val: current * (5 + Math.random() * 10) };
                    reward.val = 5;
                }
                else if (type === 'ACTIVATE_MANAGER') {
                    target = { val: 3 + Math.floor(Math.random() * 5) }; // 3 to 8 times
                }

                return new Mission(Date.now() + Math.random(), type, target, reward);
            }

            onEvent(evt, data) {
                // Hook for event-based missions
                let changes = false;
                this.missions.forEach(m => {
                    if (!m.completed && !m.claimed) {
                        if (m.type === 'ACTIVATE_MANAGER' && evt === 'MANAGER_ACTIVATE') {
                            m.increment(1);
                            changes = true;
                        }
                    }
                });
                if (changes) this.updateUI();
            }

            checkProgress() {
                // Polling for state-based missions
                let changes = false;
                this.missions.forEach(m => {
                    if (!m.completed && !m.claimed) {
                        let oldProg = m.progress;
                        m.check(this.game);
                        if (m.completed || m.progress !== oldProg) changes = true;
                    }
                });
                if (changes || this.isExpanded) this.updateUI();
            }

            claim(missionId) {
                const mIndex = this.missions.findIndex(m => m.id === missionId);
                if (mIndex === -1) return;

                const m = this.missions[mIndex];
                if (!m.completed) return;

                // Grant ID
                if (m.reward.type === 'SC') {
                    this.game.superCash += m.reward.val;
                    this.game.createFloatText(`+${m.reward.val} SC`, window.innerWidth / 2, window.innerHeight / 2, '#00E676');
                } else {
                    this.game.addMoney(m.reward.val);
                    this.game.createFloatText(`+$${fmt(m.reward.val)}`, window.innerWidth / 2, window.innerHeight / 2, '#FFD54F');
                }

                // Show Fancy Popup
                this.showCompletionEffect(m);

                // Remove and Replace
                this.missions.splice(mIndex, 1);
                this.fillMissions();
                this.updateUI(true);

                // Save Game triggers?
                this.game.saveGame();
            }

            showCompletionEffect(m) {
                // JUICY pop effect
                const overlay = document.createElement('div');
                overlay.className = 'mission-complete-overlay anim-mission-pop';
                overlay.innerHTML = `
                    <div class="mission-complete-inner">
                        <div style="font-size:30px; margin-bottom:10px;">${m.getIcon()}</div>
                        <div style="font-size:18px; color:#FFD54F;">MISSION COMPLETE!</div>
                        <div style="font-size:14px; margin-top:5px; opacity:0.8;">${m.desc}</div>
                        <div style="font-size:24px; color:#00E676; margin-top:10px; font-weight:bold;">+${m.reward.val} SC</div>
                    </div>
                `;
                document.body.appendChild(overlay);
                setTimeout(() => overlay.remove(), 2000);
                this.game.audio.playSFX('upgrade'); // Reuse upgrade sound for now
            }

            updateUI(force = false) {
                const now = Date.now();
                if (!force && (now - this.lastUIUpdate < 200)) return; // Throttle to 5fps
                this.lastUIUpdate = now;
                // Update Compact Header (Show first uncompleted or most progressed?)
                // Strategy: Show the "closest" mission
                const active = this.missions.filter(m => !m.completed);
                const first = active[0] || this.missions[0]; // Fallback

                if (first) {
                    const pct = Math.min(100, (first.progress / first.goal) * 100);
                    this.compactHeader.querySelector('.mission-title-compact').innerText = first.desc;
                    this.compactHeader.querySelector('.mission-progress-fill').style.width = `${pct}%`;
                    this.compactHeader.querySelector('.mission-icon-main').innerText = first.getIcon();
                }

                // Update List if Expanded
                if (this.isExpanded) {
                    this.listContainer.innerHTML = '';
                    this.missions.forEach(m => {
                        const item = document.createElement('div');
                        item.className = 'mission-item ' + (m.completed ? 'completed' : '');

                        const pct = Math.min(100, (m.progress / m.goal) * 100);

                        let actionBtn = '';
                        if (m.completed) {
                            actionBtn = `<button class="btn-claim-mission">CLAIM</button>`;
                        } else {
                            actionBtn = `<div class="mission-status-text">${Math.floor(pct)}%</div>`;
                        }

                        item.innerHTML = `
                            <div class="mission-item-header">
                                <div class="mission-name">${m.icon} ${m.desc}</div>
                                <div class="mission-reward">${m.reward.type === 'SC' ? 'ðŸ’Ž' : '$'} ${m.reward.val}</div>
                            </div>
                            ${!m.completed ?
                                `<div class="mission-progress-bg" style="margin-top:5px; background:rgba(0,0,0,0.3); height:4px;">
                                    <div class="mission-progress-fill" style="width:${pct}%"></div>
                                </div>` : ''}
                            ${actionBtn}
                        `;

                        if (m.completed) {
                            item.querySelector('button').onclick = () => this.claim(m.id);
                        }

                        this.listContainer.appendChild(item);
                    });
                }
            }
        }

        /* --- MONSTER INVASION SYSTEM --- */
        class MonsterManager {
            constructor(gameInstance) {
                this.game = gameInstance;
                this.layer = document.getElementById('monster-layer');

                // Settings: Spawn every 5 to 7 Minutes (300 to 420 seconds)
                this.timer = 60; // First invasion after 60 seconds as requested
                this.state = 'IDLE'; // IDLE, WARNING, ATTACK, RETREAT

                // Difficulty Scaling & Stats
                this.invasionLevel = 0;
                this.goblinHp = 10;
                this.heroWindow = 5000;
                this.sessionStolen = 0;
                this.sessionRecovered = 0;

                this.thieves = [];
                this.bushes = [];

                this.initBushes();

                // DEBUG COMMAND (Console Only now)
                window.triggerInvasion = () => {
                    console.log("TRIGGERING INVASION");
                    this.timer = 5; // Start in 5 seconds
                };
            }

            initBushes() {
                // NO BUSHES - Goblins spawn from tree positions
                this.runners = [];
                // Define 5 tree spawn positions (spread across grass)
                this.treePositions = [
                    { x: 120, y: 160, scale: 0.25 },
                    { x: 360, y: 165, scale: 0.28 },
                    { x: 600, y: 168, scale: 0.3 },
                    { x: 840, y: 165, scale: 0.28 },
                    { x: 1080, y: 160, scale: 0.25 }
                ];
            }

            update(dt) {
                // NO BUSH UPDATES NEEDED
                if (this.state === 'IDLE') {
                    this.timer -= dt;
                    if (this.timer <= 10) {
                        this.enterWarning();
                    }
                } else if (this.state === 'WARNING') {
                    this.timer -= dt;
                    if (this.timer <= 0) {
                        this.startAttack();
                    }
                } else if (this.state === 'ATTACK') {
                    // Update Thieves
                    let allDefeated = true;
                    this.thieves.forEach(thief => {
                        thief.update(dt);
                        // Active check: If any are still ALIVE (HP > 0) and NOT FLED, then attack is ongoing
                        if (thief.active) allDefeated = false;
                    });

                    // If all gone (dead or fled)
                    if (allDefeated) {
                        this.endInvasion();
                    }
                }
            }

            enterWarning() {
                if (this.state === 'WARNING') return;
                this.state = 'WARNING';
                console.log("Invasion Warning!");

                // Spawn Background Runners (Sneaking Phase)
                this.spawnRunners();
            }

            spawnRunners() {
                // Goblins run between trees (max 3-4 runners)
                let runnerCount = 0;
                const interval = setInterval(() => {
                    if (this.state !== 'WARNING') { clearInterval(interval); return; }
                    runnerCount++;
                    if (runnerCount > 3) clearInterval(interval);

                    // Pick random start and end tree positions
                    const startIdx = Math.floor(Math.random() * (this.treePositions.length - 1));
                    const endIdx = startIdx + 1;

                    const startTree = this.treePositions[startIdx];
                    const endTree = this.treePositions[endIdx];

                    const runner = document.createElement('div');
                    runner.className = 'monster-entity background-runner visible running';
                    // Position BEHIND trees
                    runner.style.left = startTree.x + 'px';
                    runner.style.top = (startTree.y + 30) + 'px';
                    runner.style.transform = `scale(${startTree.scale})`;
                    runner.style.zIndex = '-1';
                    this.layer.appendChild(runner);

                    // Quick run to next tree
                    runner.getBoundingClientRect();
                    setTimeout(() => {
                        runner.style.left = endTree.x + 'px';
                        runner.style.top = (endTree.y + 30) + 'px';
                        runner.style.transform = `scale(${endTree.scale})`;
                    }, 50);

                    setTimeout(() => {
                        runner.remove();
                    }, 2000);

                }, 1500);
            }

            startAttack() {
                this.state = 'ATTACK';
                console.log("Invasion Started!");

                // Audio
                this.game.audio.startInvasionMusic();

                // Reset Stats
                this.sessionStolen = 0;
                this.sessionRecovered = 0;

                // Difficulty Scaling
                this.invasionLevel++;
                this.goblinHp = 5 + (Math.min(this.invasionLevel, 30) * 3); // Capped at Level 30 (Max 95 HP)
                this.heroWindow = 8000 + (this.invasionLevel * 1000); // 8s + 1s per level (More Time)

                // Spawn 3-5 Thieves from RANDOM tree positions
                const numThieves = 3 + Math.floor(Math.random() * 3); // 3, 4, or 5 goblins

                // Randomly select which trees to spawn from
                const availableTrees = [...this.treePositions];
                const selectedTrees = [];

                for (let i = 0; i < numThieves; i++) {
                    const randomIndex = Math.floor(Math.random() * availableTrees.length);
                    selectedTrees.push(availableTrees[randomIndex]);
                    availableTrees.splice(randomIndex, 1); // Remove to avoid duplicates
                }

                // Spawn goblins from selected trees
                selectedTrees.forEach((tree, i) => {
                    const shaftIndex = Math.floor(Math.random() * Math.min(this.game.shafts.length, 5));

                    setTimeout(() => {
                        this.game.audio.sfx.koboldsound.currentTime = 0;
                        this.game.audio.sfx.koboldsound.play().catch(e => { }); // Spawn Sound

                        const thief = new Thief(this, tree.x, tree.y, tree.scale, shaftIndex);
                        this.thieves.push(thief);
                    }, i * 300); // Staggered spawn
                });
            }

            endInvasion() {
                console.log("Invasion Ended");
                this.state = 'IDLE';

                this.game.audio.stopInvasionMusic();

                this.thieves.forEach(t => t.remove()); // Cleanup visuals if any left (e.g. Fled ones might have lingered?)
                this.thieves = [];

                // Automate Next Invasion (2.5 Minutes average = 150 seconds +/- 30s)
                this.timer = 120 + Math.random() * 60;
                console.log(`Next invasion in ${Math.floor(this.timer)} seconds.`);
            }
        }

        class Thief {
            constructor(manager, startX, startY, treeScale, targetIndex) {
                this.manager = manager;
                this.x = startX;
                this.y = startY - 80; // Adjusted for horizon spawn (Top at ~80px, Feet at ~180px)
                this.baseY = this.y; // Track base Y for hopping
                this.targetIndex = targetIndex; // Shaft Index
                this.active = true;

                this.hp = this.manager.goblinHp; // SCALED HP
                this.maxHp = this.hp;
                this.state = 'JUMPING'; // JUMPING, DRILLING, FLEE, DEAD, ESCAPED

                // Combat Tracking
                this.stolenAccumulated = 0;
                this.startDrillTime = 0;

                // Element
                this.el = document.createElement('div');
                this.el.className = 'monster-entity visible spawning running'; // Add spawning & running
                this.el.innerHTML = `
                    <div class="goblin-body"></div>
                    <div class="thief-drill"></div>
                    <div class="challenge-ui">
                        <div class="hp-bar" style="width: 100%"></div>
                        <div class="timer-bar" style="width: 100%; height: 4px; background: gold; margin-top: 2px; box-shadow: 0 0 2px black; opacity: 0; transition: opacity 0.2s;"></div>
                    </div>
                `;

                // Initial Pos (start behind tree and ON TOP of grass horizon)
                this.el.style.left = this.x + 'px';
                this.el.style.top = this.y + 'px';

                // Calculate Target Position
                this.targetX = 600;
                this.targetY = 250 + (targetIndex * 180);

                // Calculate initial distance for perspective growth
                const dx = this.targetX - this.x;
                const dy = this.targetY - this.y;
                this.initialDistance = Math.sqrt(dx * dx + dy * dy);

                // Start VERY small and behind trees
                this.currentScale = treeScale * 0.6; // Smaller than tree
                this.el.style.transform = `scale(${this.currentScale})`;
                this.el.style.zIndex = '1'; // Behind trees initially

                // Click Handler
                this.el.onmousedown = (e) => {
                    e.stopPropagation();
                    this.takeDamage(1);
                };

                this.manager.layer.appendChild(this.el);

                // Remove spawning class after animation
                setTimeout(() => {
                    this.el.classList.remove('spawning');
                }, 400);

                this.jumpTimer = 0;
                this.hasCrossedMidpoint = false; // Track when to change z-index
            }

            update(dt) {
                if (!this.active && this.state !== 'FLEE') return; // If dead/escaped, stop updating unless fleeing

                if (this.state === 'JUMPING') {
                    // Move towards target - AGGRESSIVE SPRINT
                    const dx = this.targetX - this.x;
                    const dy = this.targetY - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < 10) {
                        // Arrived at target
                        this.state = 'DRILLING';
                        this.el.classList.remove('running');
                        this.el.classList.add('stealing');
                        this.el.classList.add('combat'); // Show HP
                        this.el.style.transform = `scale(1)`; // Full size when arrived
                        this.el.style.zIndex = '3'; // In front

                        // Start Drilling Timer (Now serves as ESCAPE TIMER)
                        this.startDrillTime = Date.now();
                        this.el.querySelector('.timer-bar').style.opacity = '1'; // Show timer immediately when drilling starts

                    } else {
                        // Sprint forward with speed increase over time
                        const progress = 1 - (dist / this.initialDistance);
                        const speedBoost = 1 + (progress * 1.5); // Speed increases as they get closer
                        this.x += (dx / dist) * 400 * speedBoost * dt;

                        // Movement + Hop Effect
                        this.baseY += (dy / dist) * 400 * speedBoost * dt;
                        const hop = Math.abs(Math.sin(Date.now() / 100)) * 10; // 10px Hop
                        this.y = this.baseY - hop;

                        this.el.style.left = this.x + 'px';
                        this.el.style.top = this.y + 'px';

                        // SMOOTH SCALING with easing (ease-out cubic)
                        // Start: currentScale (0.2-0.3), End: 1.0
                        const easedProgress = 1 - Math.pow(1 - progress, 3); // Cubic ease-out
                        const targetScale = 1.0;
                        const scale = this.currentScale + (targetScale - this.currentScale) * easedProgress;
                        this.el.style.transform = `scale(${scale})`;

                        // Z-Index transition at midpoint (come from behind trees to front)
                        if (progress > 0.4 && !this.hasCrossedMidpoint) {
                            this.el.style.zIndex = '3'; // Now in front of trees
                            this.hasCrossedMidpoint = true;
                        }
                    }
                } else if (this.state === 'DRILLING') {
                    // Steal Money
                    const stealAmount = Math.max(1, Math.floor(this.manager.game.money * 0.001)); // Modified: 0.1% per tick (User Requested Profit)
                    // Steal every second
                    this.jumpTimer += dt; // Reuse jumpTimer as generic timer
                    if (this.jumpTimer > 1.0) {
                        this.jumpTimer = 0;
                        if (this.manager.game.money > 0) {
                            this.manager.game.money = Math.max(0, this.manager.game.money - stealAmount);
                            this.stolenAccumulated += stealAmount; // TRACK STOLEN AMOUNT
                            this.manager.game.createFloatText(`-$${stealAmount}`, this.x, this.y - 50, 'steal-text');
                        }
                    }

                    // CHECK FOR ESCAPE (Time Limit)
                    if (this.startDrillTime > 0) {
                        const elapsed = Date.now() - this.startDrillTime;
                        if (elapsed >= this.manager.heroWindow) {
                            this.escape();
                        }
                    }

                } else if (this.state === 'FLEE') {
                    // Run away to right
                    this.el.classList.remove('running'); // Stop running animation
                    this.x += 500 * dt;
                    this.el.style.left = this.x + 'px';
                    this.el.style.transform = 'scaleX(-1)'; // Face right
                    this.el.style.opacity = '0.7';

                    if (this.x > 1500) {
                        this.remove();
                    }
                }


                // Update Escape Timer Bar
                if (this.state === 'DRILLING') {
                    let pct = 100;
                    if (this.startDrillTime > 0) {
                        const elapsed = Date.now() - this.startDrillTime;
                        const remaining = Math.max(0, this.manager.heroWindow - elapsed);
                        pct = (Math.max(0, remaining) / this.manager.heroWindow) * 100;
                    }
                    const bar = this.el.querySelector('.timer-bar');
                    if (bar) {
                        bar.style.width = pct + '%';
                        if (pct <= 20) bar.style.backgroundColor = '#FF5252'; // Red warning
                    }
                }
            }

            takeDamage(amount) {
                if (this.state !== 'DRILLING' && this.state !== 'JUMPING') return; // Can only hit while jumping or drilling

                this.hp -= amount;

                // Update UI
                const pct = (this.hp / this.maxHp) * 100;
                this.el.querySelector('.hp-bar').style.width = pct + '%';

                // Hit Effect
                this.el.classList.add('hit');
                setTimeout(() => this.el.classList.remove('hit'), 100);

                this.manager.game.audio.playSFX('mine'); // Hit sound

                if (this.hp <= 0) {
                    this.die();
                }
            }

            escape() {
                this.state = 'FLEE';
                this.active = false; // logic stops, visual flee continues
                this.el.classList.remove('stealing');
                this.el.classList.add('running');

                // Visual Text
                this.manager.game.createFloatText('ENTKOMMEN!', this.x, this.y - 100);
                this.manager.game.createFloatText('Geld Verloren...', this.x, this.y - 130);
            }

            die() {
                if (this.state === 'DEAD') return;
                this.state = 'DEAD';
                this.active = false;
                this.el.style.pointerEvents = 'none';

                // REWARD LOGIC: YOU ONLY GET MONEY BACK IF YOU KILL HIM
                let refund = this.stolenAccumulated;

                // NEW SCALING REWARD:
                // 1. Base bonus calculation depends on wealth and frequency of attacks
                // Start with 1% of wealth, increases by 1% per invasion level
                let wealthFactor = Math.max(10, this.manager.game.money * 0.01);
                let growthFactor = 1 + (this.manager.invasionLevel * 0.5); // 50% growth per level
                let baseBonus = wealthFactor * growthFactor;

                // 2. Multiplier for stolen funds also scales
                let bonusMult = 3 + (this.manager.invasionLevel * 0.2);
                let bonus = Math.floor(Math.max(baseBonus, refund * bonusMult));

                const total = refund + bonus;
                if (total > 0) {
                    this.manager.game.addMoney(total);

                    // Show RECOVERY POPUP
                    const popup = document.createElement('div');
                    popup.className = 'recovery-popup';
                    popup.innerHTML = `
                        <div>ðŸ’° $${fmt(refund)} ZurÃ¼ck!</div>
                        <div class="bonus">ðŸ’€ KILL BONUS! +$${fmt(bonus)}</div>
                    `;
                    popup.style.left = (this.x - 50) + 'px';
                    popup.style.top = (this.y - 100) + 'px';
                    document.querySelector('.game-content-wrapper').appendChild(popup);
                    setTimeout(() => popup.remove(), 3000);

                    this.manager.game.audio.playSFX('coin');

                }

                // Death Animation
                this.el.animate([
                    { transform: 'scale(1) rotate(0deg)', opacity: 1, filter: 'grayscale(0)' },
                    { transform: 'scale(0.5) rotate(180deg)', opacity: 0, filter: 'grayscale(1)' }
                ], {
                    duration: 500,
                    easing: 'ease-in'
                }).onfinish = () => this.el.remove();
            }

            flee() {
                this.state = 'FLEE';
                this.el.classList.remove('stealing');
                this.el.classList.remove('combat');
                // Drop some money back?
                // this.manager.game.spawnFlyingMoney(...)
            }

            remove() {
                this.active = false;
                this.el.remove();
            }
        }

        class WeatherManager {
            constructor(game) {
                this.game = game;
                this.layer = $('.sky-area');
                this.state = 'CLEAR'; // CLEAR, RAIN, SNOW
                this.timer = 60 + Math.random() * 120; // 1-3 mins
                this.particles = [];
                this.maxParticles = 50;
                this.spawnRate = 0.2; // Spawn every X seconds
                this.spawnTimer = 0;
            }

            update(dt) {
                this.timer -= dt;
                if (this.timer <= 0) {
                    this.cycleWeather();
                }

                if (this.state !== 'CLEAR') {
                    this.spawnTimer += dt;
                    if (this.spawnTimer >= this.spawnRate) {
                        this.spawnTimer = 0;
                        this.spawnParticle();
                    }
                }
            }

            cycleWeather() {
                const states = ['CLEAR', 'RAIN', 'SNOW'];
                // Some worlds might favor different weather
                const world = WORLDS[this.game.worldId];

                let roll = Math.random();
                if (world.id === 'MOON') {
                    this.state = 'CLEAR'; // No weather on moon (usually)
                } else if (world.id === 'MOUNTAIN') {
                    this.state = roll < 0.6 ? 'SNOW' : (roll < 0.8 ? 'RAIN' : 'CLEAR');
                } else {
                    this.state = roll < 0.7 ? 'CLEAR' : (roll < 0.9 ? 'RAIN' : 'SNOW');
                }

                this.timer = 60 + Math.random() * 120;
                console.log("Weather changed to:", this.state);

                // Cleanup old particles when clearing or changing
                if (this.state === 'CLEAR') {
                    this.clearAllParticles();
                }
            }

            spawnParticle() {
                if (this.particles.length >= this.maxParticles) {
                    const old = this.particles.shift();
                    old.remove();
                }

                const p = document.createElement('div');
                p.className = `weather-particle ${this.state === 'RAIN' ? 'raindrop' : 'snowflake'}`;

                // Random horizontal start
                p.style.left = Math.random() * 100 + '%';

                // Staggered fall duration
                const duration = this.state === 'RAIN' ? (0.8 + Math.random() * 0.4) : (3 + Math.random() * 4);
                p.style.animationDuration = duration + 's';

                this.layer.appendChild(p);
                this.particles.push(p);

                // Auto remove after animation
                setTimeout(() => {
                    const idx = this.particles.indexOf(p);
                    if (idx > -1) this.particles.splice(idx, 1);
                    p.remove();
                }, duration * 1000 + 100);
            }

            clearAllParticles() {
                this.particles.forEach(p => p.remove());
                this.particles = [];
            }

            setTheme(worldId) {
                this.clearAllParticles();
                this.cycleWeather(); // Initial roll for the world
            }
        }

        /* --- HELICOPTER BONUS SYSTEM --- */
        class HelicopterManager {
            constructor(game) {
                this.game = game;
                this.layer = $('#monster-layer');
                this.timer = 15 + Math.random() * 15; // First one sooner (15-30s)
                this.activeHelis = [];
            }

            update(dt) {
                this.timer -= dt;

                // Sound warning: 2 seconds before spawn
                if (this.timer <= 2 && this.timer > 1.9 && this.activeHelis.length === 0) {
                    this.game.audio.startLoop('helicopter');
                }

                if (this.timer <= 0) {
                    this.spawn();
                    this.timer = 120 + Math.random() * 60; // 2-3 mins
                }
                this.activeHelis.forEach(h => h.update(dt));
            }

            spawn() {
                const heli = new Helicopter(this.game, this);
                this.activeHelis.push(heli);
            }

            removeHeli(heli) {
                const idx = this.activeHelis.indexOf(heli);
                if (idx > -1) this.activeHelis.splice(idx, 1);
            }
        }

        class Helicopter {
            constructor(game, manager) {
                this.game = game;
                this.manager = manager;

                // Randomize Start/End for Diagonal Flight
                const fromLeft = Math.random() > 0.5;
                if (fromLeft) {
                    this.x = -150;
                    this.targetX = 1550;
                    this.y = -50 + Math.random() * 50; // High start
                    this.targetY = 200 + Math.random() * 200; // Diagonal down
                } else {
                    this.x = 1550;
                    this.targetX = -150;
                    this.y = -50 + Math.random() * 50;
                    this.targetY = 200 + Math.random() * 200;
                }

                this.speed = 120 + Math.random() * 60;
                const dist = Math.sqrt(Math.pow(this.targetX - this.x, 2) + Math.pow(this.targetY - this.y, 2));
                this.vx = ((this.targetX - this.x) / dist) * this.speed;
                this.vy = ((this.targetY - this.y) / dist) * this.speed;

                this.el = document.createElement('div');
                this.el.className = 'helicopter-entity heli-pulse';
                this.el.innerHTML = getHelicopterSVG();
                this.el.style.left = this.x + 'px';
                this.el.style.top = this.y + 'px';

                // Flip SVG if coming from right
                if (!fromLeft) {
                    this.el.style.transform = 'scaleX(-1)';
                }

                this.el.onmousedown = (e) => {
                    e.stopPropagation();
                    this.claim();
                };

                // The sound already starts in HelicopterManager.update via warning logic
                // but we ensure it's on just in case of manual spawns
                this.game.audio.startLoop('helicopter');
                this.manager.layer.appendChild(this.el);
            }

            update(dt) {
                this.x += this.vx * dt;
                this.y += this.vy * dt;

                this.el.style.left = this.x + 'px';

                // Bobbing added to current diagonal Y
                const bob = Math.sin(Date.now() / 500) * 10;
                this.el.style.top = (this.y + bob) + 'px';

                // Check bounds
                if (this.x < -200 || this.x > 1600 || this.y > 600) {
                    this.remove();
                }
            }

            claim() {
                // Calculate Reward: Total theoretical PPS * 120 (2 minutes)
                let totalPPS = 0;
                this.game.shafts.forEach(s => {
                    const dist = 400;
                    let mMult = s.manager ? s.manager.getSpeedMult() : 1;
                    s.miners.forEach(m => {
                        const speed = m.stats.speed * mMult;
                        const walkTime = (dist / speed) * 2;
                        const mineTime = m.stats.capacity / m.stats.mineRate;
                        const cycleTime = walkTime + mineTime;
                        totalPPS += (m.stats.capacity / cycleTime);
                    });
                });

                const reward = Math.floor(Math.max(100, totalPPS * 120));
                this.game.addMoney(reward);

                this.game.createFloatText(`+$${fmt(reward)}`, this.x + 60, this.y, 'bonus-text');
                this.game.audio.playSFX('coin'); // Use coin SFX instead of helicopter SFX on claim

                if (this.game.spawnFlyingMoney) {
                    this.game.spawnFlyingMoney(this.x + 60, this.y, 10);
                }

                this.remove();
            }

            remove() {
                this.el.remove();
                this.manager.removeHeli(this);
                // Stop sound immediately if no more helis are active
                if (this.manager.activeHelis.length === 0) {
                    this.game.audio.stopLoop('helicopter');
                }
            }
        }




        /* --- TUTORIAL MANAGER --- */
        class TutorialManager {
            constructor(game) {
                this.game = game;
                this.active = false;
                this.step = 0;
                this.pointer = null;
                this.skipBtn = null;
                this.targetEl = null;
            }

            start() {
                console.log("Starting Tutorial");
                this.active = true;
                this.createUI();
                this.showWelcome();
            }

            createUI() {
                this.pointer = document.createElement('div');
                this.pointer.className = 'tutorial-pointer';
                this.pointer.innerHTML = 'ðŸ‘‡';
                this.pointer.style.display = 'none';
                document.body.appendChild(this.pointer);

                this.skipBtn = document.createElement('button');
                this.skipBtn.className = 'btn-skip-tutorial';
                this.skipBtn.innerText = 'SKIP TUTORIAL';
                this.skipBtn.onclick = () => this.skip();
                document.body.appendChild(this.skipBtn);
            }

            showWelcome() {
                const w = document.createElement('div');
                w.className = 'tutorial-welcome';
                w.innerHTML = "Welcome to<br>DeepShafts";
                document.body.appendChild(w);
                setTimeout(() => {
                    w.remove();
                    this.step = 1;
                    this.updateStep();
                }, 2000);
            }

            showOverlay(title, text) {
                const o = document.createElement('div');
                o.className = 'tutorial-overlay-text';
                o.innerHTML = `<h3>${title}</h3><p>${text}</p><button class="tutorial-close-btn">GOT IT</button>`;
                document.body.appendChild(o);

                // Pause specific game interactions if needed? No, keep it fluid.

                return new Promise(resolve => {
                    o.querySelector('button').onclick = () => {
                        o.remove();
                        resolve();
                    };
                });
            }

            update(dt) {
                if (!this.active) return;

                // Sync Pointer Position
                if (this.pointer && this.targetEl && this.targetEl.isConnected && this.targetEl.offsetParent !== null) {
                    const rect = this.targetEl.getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0) {
                        this.pointer.style.left = (rect.left + rect.width / 2 - 25) + 'px';
                        this.pointer.style.top = (rect.top - 80) + 'px';
                        this.pointer.style.display = 'block';
                    } else {
                        this.pointer.style.display = 'none';
                    }
                } else if (this.pointer) {
                    this.pointer.style.display = 'none';
                }

                // Step Logic
                if (this.step === 1) { // Buy Shaft
                    if (this.game.shafts.length > 0) {
                        this.step = 2;
                        this.updateStep();
                    }
                } else if (this.step === 2) { // Upgrade Shaft 1 to Level 2
                    const shaft = this.game.shafts[0];
                    if (shaft) {
                        // User feedback: POINT DIRECTLY TO UPGRADE BUTTON. No miner follow.
                        this.targetEl = document.getElementById('btn-shaft-0'); // Using ID logic from Game.updateButtons
                        if (!this.targetEl) this.targetEl = shaft.btn; // Fallback

                        if (this.targetEl) this.targetEl.classList.add('btn-pulse');

                        if (shaft.level >= 2) {
                            if (this.targetEl) this.targetEl.classList.remove('btn-pulse');
                            this.step = 3;
                            this.updateStep();
                        }
                    }
                } else if (this.step === 3) { // Hire Manager
                    // Check if manager is HIRED
                    const shaft = this.game.shafts[0];
                    if (shaft && shaft.manager) {
                        this.step = 3.5; // New Step: Activate Manager
                        this.updateStep();
                    }
                } else if (this.step === 3.5) { // Activate Manager
                    const shaft = this.game.shafts[0];
                    // Check if manager is ACTIVE (state 'ACTIVE')
                    if (shaft && shaft.manager && shaft.manager.state === 'ACTIVE') {
                        this.step = 4;
                        this.updateStep();
                    }
                }
                // Steps 4, 5 handled by UI events
                else if (this.step === 4) { // Open Research
                    const overlay = document.getElementById('research-overlay');
                    if (overlay && overlay.style.display === 'flex') {
                        this.step = 4.5;
                        this.updateStep();
                    }
                } else if (this.step === 5) { // Open Shop
                    const overlay = document.getElementById('modal-overlay');
                    if (overlay && overlay.style.display === 'flex') {
                        this.step = 5.5;
                        this.updateStep();
                    }
                }
            }

            async updateStep() {
                this.targetEl = null;

                if (this.step === 1) {
                    this.targetEl = document.querySelector('.next-shaft-btn-container button');
                } else if (this.step === 2) {
                    // Logic handled in update() to ensure button reference
                } else if (this.step === 3) {
                    // Hire Manager - Shaft 1
                    this.targetEl = document.querySelector('.pos-shaft-manager');
                    if (this.pointer) this.pointer.innerText = 'ðŸ‘‡'; // Reset if needed
                } else if (this.step === 3.5) {
                    // Activate Manager
                    this.targetEl = document.querySelector('.pos-shaft-manager');
                    // Maybe update text?
                    if (this.pointer) this.pointer.innerText = 'âš¡'; // Lightning bolt for activate
                    // Or just keep hand. Hand is fine.
                } else if (this.step === 4) {
                    // Open Research
                    if (this.pointer) this.pointer.innerText = 'ðŸ‘‡';
                    this.targetEl = document.getElementById('btn-research-nav');
                } else if (this.step === 4.5) {
                    // Inside Research
                    if (this.pointer) this.pointer.style.display = 'none';
                    await this.showOverlay("RESEARCH LAB", "Unlock powerful upgrades here to boost your mining efficiency! (Click 'GOT IT' to close)");
                    this.game.closeResearch();
                    this.step = 5;
                    this.updateStep();
                } else if (this.step === 5) {
                    // Open Shop
                    this.targetEl = document.getElementById('btn-shop-nav');
                } else if (this.step === 5.5) {
                    // Inside Shop
                    if (this.pointer) this.pointer.style.display = 'none';
                    await this.showOverlay("SHOP", "Buy Time Warps and permanent boosts here! (Mobile optimized).");
                    this.game.closeModal();
                    this.step = 6;
                    this.updateStep();
                } else if (this.step === 6) {
                    // New Step: Missions (User requested explanation)
                    // Unlock Missions First
                    const mw = document.querySelector('.mission-widget');
                    if (mw) mw.classList.remove('hidden');

                    this.targetEl = mw; // Point to mission widget
                    this.step = 7;
                    // Introduce a small delay or just wait for next update?
                    // We want to show overlay immediately after pointing?
                    // Let's point for a second then show overlay?
                    // Or just show overlay immediately.

                    await this.showOverlay("MISSIONS", "Complete missions here to earn Super Cash and rewards! Check back often.");
                    this.complete();
                }
            }

            skip() {
                this.active = false;
                if (this.pointer) this.pointer.remove();
                if (this.skipBtn) this.skipBtn.remove();

                // Ensure playable state
                if (this.game.shafts.length === 0) this.game.buyShaft();

                // Unlock Missions
                const mw = document.querySelector('.mission-widget');
                if (mw) mw.classList.remove('hidden');
            }

            complete() {
                if (!this.active) return;
                this.active = false;
                if (this.pointer) this.pointer.remove();
                if (this.skipBtn) this.skipBtn.remove();

                // Show completion message
                this.game.createFloatText("GOOD LUCK!", window.innerWidth / 2, window.innerHeight / 2, 'bonus-text');
                this.game.audio.playSFX('upgrade');

                // Unlock Missions
                // const mw = document.querySelector('.mission-widget'); // Removed as it's handled in step 6 now
                // if (mw) mw.classList.remove('hidden');
            }
        }

        class Game {
            constructor() {
                this.audio = new AudioSystem();
                this.monsterManager = new MonsterManager(this);
                this.helicopterManager = new HelicopterManager(this);
                this.audio.init();

                this.money = 100; this.superCash = 0; this.shafts = []; this.elevDepot = 0;

                this.worldId = 0; // Default Coal
                this.prestigeMult = 1;
                this.elevator = new Elevator(); this.warehouse = new Warehouse();
                this.lastTime = 0; this.loop = this.loop.bind(this);
                this.boosts = { speed: 0, earnings: 0 }; // Init Levels (0-10)
                this.soundEnabled = true;

                this.lastSaveTime = Date.now();

                this.dayNight = new DayNightManager(); // Day Night Init
                this.research = new ResearchTree(); // Research Tree Init
                this.weather = new WeatherManager(this); // Weather Init

                this.tutorial = new TutorialManager(this); // Init Tutorial

                this.loadGame();
                // Onboarding Logic: If no shafts (new game), Start Tutorial
                if (this.shafts.length === 0) {
                    this.tutorial.start();
                    this.money = 2000;
                    // Hide Missions initially
                    setTimeout(() => {
                        const mw = document.querySelector('.mission-widget');
                        if (mw) mw.classList.add('hidden');
                    }, 100);
                }

                this.initClouds();
                this.initEnvironment(); // Birds & Fossils

                this.missions = new MissionController(this);

                requestAnimationFrame(this.loop);
                this.activeUpgradeTarget = null; this.activeUpgradeId = null;
                this.modalMode = 'upgrade';
                setInterval(() => this.saveGame(), 5000);

                // Parallax Scroll Listener
                $('#world-container').addEventListener('scroll', () => {
                    const sc = $('#world-container').scrollTop;
                    $('#mountain-bg').style.transform = `translateY(${sc * 0.3}px)`;
                });

                window.addEventListener('resize', () => this.handleResize());
                this.handleResize();
            }

            addMoney(amount) {
                if (typeof amount !== 'number' || isNaN(amount)) return;
                this.money += amount;
                if (amount > 0 && this.missions) this.missions.onMoneyEarned(amount);
            }

            handleResize() {
                const width = window.innerWidth;
                const stage = document.querySelector('#game-stage');
                const ui = document.querySelector('#ui-layer');

                if (stage) {
                    if (width < 1400) {
                        const scale = width / 1400;
                        stage.style.width = '1400px';
                        stage.style.left = '50%';
                        stage.style.transform = `translateX(-50%) scale(${scale})`;
                        stage.style.transformOrigin = 'top center';
                    } else {
                        // Reset for PC
                        stage.style.width = '100%';
                        stage.style.left = '0';
                        stage.style.transform = '';
                    }
                }

                // UI reset - NEVER scale the UI layer with JS
                if (ui) {
                    ui.style.transform = '';
                    ui.style.width = '100%';
                    ui.style.height = '100%';
                }
            }
            // ... (rest of class)
            initEnvironment() {
                // Birds
                const sky = $('.sky-area');
                for (let i = 0; i < 3; i++) {
                    let b = document.createElement('div');
                    b.className = 'bird';
                    b.style.top = (20 + Math.random() * 80) + 'px';
                    b.style.animationDuration = (15 + Math.random() * 10) + 's';
                    b.style.animationDelay = (Math.random() * -20) + 's';
                    sky.appendChild(b);
                }

                // Fossils
                const dirt = $('#dirt-layer');
                const fossils = ['ðŸ¦´', 'ðŸš', 'ðŸŸ', 'ðŸ’Ž', 'ðŸ—¿'];
                for (let i = 0; i < 20; i++) {
                    let f = document.createElement('div');
                    f.className = 'fossil';
                    f.innerText = fossils[Math.floor(Math.random() * fossils.length)];
                    f.style.left = (Math.random() * 100) + '%';
                    f.style.top = (Math.random() * 2500) + 'px'; // Deep down
                    f.style.transform = `rotate(${Math.random() * 360}deg) scale(${0.5 + Math.random()})`;
                    dirt.appendChild(f);
                }
            }
            initClouds() {
                const sky = $('.sky-area');
                for (let i = 0; i < 4; i++) {
                    const cloud = document.createElement('div');
                    cloud.className = 'cloud';
                    cloud.style.width = (60 + Math.random() * 80) + 'px';
                    cloud.style.height = (20 + Math.random() * 20) + 'px';
                    cloud.style.top = (10 + Math.random() * 60) + 'px';
                    cloud.style.left = (Math.random() * 800) + 'px';
                    cloud.style.animationDuration = (25 + Math.random() * 20) + 's';
                    cloud.style.animationDelay = (-Math.random() * 30) + 's';
                    sky.appendChild(cloud);
                }
            }
            saveGame() {
                this.lastSaveTime = Date.now();
                try {
                    localStorage.setItem('idleMinerSave', JSON.stringify({
                        money: this.money,
                        superCash: this.superCash,
                        worldId: this.worldId,
                        prestigeMult: this.prestigeMult,
                        eleLvl: this.elevator.level,
                        whLvl: this.warehouse.level,
                        shafts: this.shafts.map(s => ({ level: s.level, side: s.side, manager: s.manager ? { type: s.manager.type, state: s.manager.state, timer: s.manager.timer } : null })),
                        eleMgr: this.elevator.manager ? { type: this.elevator.manager.type, state: this.elevator.manager.state, timer: this.elevator.manager.timer } : null,
                        whMgr: this.warehouse.manager ? { type: this.warehouse.manager.type, state: this.warehouse.manager.state, timer: this.warehouse.manager.timer } : null,
                        boosts: this.boosts, // SAVE BOOSTS
                        research: { unlocked: this.research.unlocked }, // SAVE RESEARCH
                        lastSave: this.lastSaveTime
                    }));
                } catch (e) { }
            }

            loadGame() {
                const stored = localStorage.getItem('idleMinerSave');
                if (stored) {
                    try {
                        const data = JSON.parse(stored);
                        this.money = (data.money !== undefined && !isNaN(data.money)) ? data.money : 100;
                        this.superCash = data.superCash || 0;
                        this.worldId = data.worldId || 0;
                        this.boosts = data.boosts || { speed: 0, earnings: 0 };
                        // MIGRATION: Convert old booleans to levels
                        if (this.boosts.speed === true) this.boosts.speed = 10;
                        if (this.boosts.speed === false) this.boosts.speed = 0;
                        if (this.boosts.earnings === true) this.boosts.earnings = 10;
                        if (this.boosts.earnings === false) this.boosts.earnings = 0;
                        if (data.research) this.research.loadState(data.research); // LOAD RESEARCH
                        this.prestigeMult = data.prestigeMult || 1;

                        this.applyWorldVisuals(this.worldId);
                        this.elevator.loadState(data.eleLvl || 1);
                        this.warehouse.loadState(data.whLvl || 1);
                        this.elevator.loadState(data.eleLvl || 1);
                        if (data.eleMgr) {
                            this.elevator.assignManager(data.eleMgr.type);
                            // Restore state
                            this.elevator.manager.state = data.eleMgr.state;
                            this.elevator.manager.timer = data.eleMgr.timer;
                            if (data.eleMgr.state === 'ACTIVE') this.elevator.manager.el.classList.add('manager-active-glow');
                            this.elevator.manager.updateUI();
                        }

                        this.warehouse.loadState(data.whLvl || 1);
                        if (data.whMgr) {
                            this.warehouse.assignManager(data.whMgr.type);
                            this.warehouse.manager.state = data.whMgr.state;
                            this.warehouse.manager.timer = data.whMgr.timer;
                            if (data.whMgr.state === 'ACTIVE') this.warehouse.manager.el.classList.add('manager-active-glow');
                            this.warehouse.manager.updateUI();
                        }

                        if (data.shafts) {
                            data.shafts.forEach((sData, i) => {
                                let s = new Shaft(i, sData.level, this.prestigeMult, sData.side);
                                if (sData.manager) {
                                    s.assignManager(sData.manager.type);
                                    s.manager.state = sData.manager.state;
                                    s.manager.timer = sData.manager.timer;
                                    if (sData.manager.state === 'ACTIVE') s.manager.el.classList.add('manager-active-glow');
                                    s.manager.updateUI();
                                }
                                this.shafts.push(s);
                            });
                        }
                        // Offline Earnings
                        if (data.lastSave) {
                            const elapsed = (Date.now() - data.lastSave) / 1000;
                            if (elapsed > 60) {
                                // Simplified offline: just take miner 0 rate * count? 
                                // Actually we should sum all miners.
                                const offlineRate = this.shafts.reduce((sum, s) => {
                                    // simplified: count * rate of first miner (assuming identical)
                                    return sum + (s.miners.length * s.miners[0].stats.mineRate * 0.3);
                                }, 0);
                                const offlineEarnings = Math.floor(offlineRate * Math.min(elapsed, 1800));
                                if (offlineEarnings > 0) {
                                    this.money += offlineEarnings;
                                    setTimeout(() => this.showWelcomeBack(offlineEarnings, elapsed), 500);
                                }
                            }
                        }
                    } catch (e) { this.money = 100; this.worldId = 0; this.prestigeMult = 1; this.applyWorldVisuals(0); }
                }
                // SYNC COST DISPLAY ON LOAD
                this.updateNextShaftCostText();
                this.resizeWorld(); // Ensure world is big enough for loaded shafts
            }
            resizeWorld() {
                // Calculate required height: Top Offset (250) + Max Shaft Depth * (Height+Gap) + Buffer
                // Since shafts alternate, Max Depth is total / 2
                const depthCount = Math.ceil(this.shafts.length / 2);
                const requiredHeight = 350 + (depthCount * (CFG.shaftH + CFG.shaftGap)) + 500;
                const finalHeight = Math.max(2000, requiredHeight);

                $('#game-world').style.height = finalHeight + 'px';

                // Also update Dirt Mask and Overlay if they are absolute/100%
                // They should inherit from game-stage which inherits from game-world
                // But let's trigger a reflow or check if we need to spawn more fossils?

                // Spawn new fossils if we grew significantly? 
                // Simple: Just ensure background layers cover checks out.
                // CSS min-height on game-world + height 100% on children should handle it.
            }
            showWelcomeBack(earnings, seconds) {
                const mins = Math.floor(seconds / 60);
                const popup = document.createElement('div');
                popup.className = 'welcome-popup';
                popup.innerHTML = `
                    <h2>ðŸŽ‰ Welcome back!</h2>
                    <p>You were away for ${mins} minutes</p>
                    <div class="welcome-earnings">+$${fmt(earnings)}</div>
                    <button class="btn-buy-upgrade" onclick="this.parentElement.remove()">Awesome!</button>
                `;
                document.body.appendChild(popup);
            }

            spawnFlyingMoney(startX, startY, count) {
                const targetEl = $('.currency-pill'); // Target the whole pill or the icon
                if (!targetEl) return;

                const rect = targetEl.getBoundingClientRect();
                const targetX = rect.left + 30;
                const targetY = rect.top + 20;

                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const coin = document.createElement('div');
                        coin.className = 'flying-coin';
                        // Initial position (relative to viewport since it's fixed UI layer effectively, 
                        // but wait.. createFloatText uses absolute on game-world? No, float-text is 5000 zindex.
                        // Let's attach coins to UI layer or Body to ensure they are on top of everything.
                        document.body.appendChild(coin);

                        // We need screen coordinates for startX/Y if game is scrolled.
                        // startX/Y passed here are likely World Coordinates (inside #game-world).
                        // #world-container scrolls.
                        // So we need to convert World -> Screen.
                        const container = $('#world-container');
                        const screenX = startX; // Horizontal scroll is usually 0 but we centered it.. wait.
                        // Wrapper is 1200px centered. startX passed is from Warehouse (t.x ~940).
                        // #game-content-wrapper margin: 0 auto.
                        // We need the bounding rect of the wrapper to get true screen X.
                        const wrapperFn = $('.game-content-wrapper').getBoundingClientRect();
                        const finalStartX = wrapperFn.left + startX;
                        const finalStartY = wrapperFn.top + startY; // Scroll is handled here since rect updates with scroll

                        coin.style.left = finalStartX + 'px';
                        coin.style.top = finalStartY + 'px';

                        // Random scatter
                        const scatterX = (Math.random() - 0.5) * 40;
                        const scatterY = (Math.random() - 0.5) * 40;

                        coin.style.transform = `translate(${scatterX}px, ${scatterY}px)`;

                        // Animate
                        coin.animate([
                            { left: (finalStartX + scatterX) + 'px', top: (finalStartY + scatterY) + 'px', transform: 'scale(1)' },
                            { left: targetX + 'px', top: targetY + 'px', transform: 'scale(0.5)' }
                        ], {
                            duration: 600 + Math.random() * 200,
                            easing: 'cubic-bezier(0.5, 0, 0, 1)',
                            fill: 'forwards'
                        }).onfinish = () => {
                            coin.remove();
                            // Pulse UI
                            targetEl.classList.remove('pulse');
                            void targetEl.offsetWidth; // trigger reflow
                            targetEl.classList.add('pulse');
                        };

                    }, i * 100);
                }
            }

            spawnSparks(screenX, screenY, side) {
                for (let i = 0; i < 8; i++) {
                    const spark = document.createElement('div');
                    spark.className = 'mining-spark';

                    // Random dispersion
                    const sx = (Math.random() - 0.5) * 80 + (side === 'RIGHT' ? 30 : -30); // Push away from wall
                    const sy = (Math.random() - 0.5) * 80;

                    spark.style.setProperty('--sx', sx + 'px');
                    spark.style.setProperty('--sy', sy + 'px');
                    spark.style.left = screenX + 'px';
                    spark.style.top = screenY + 'px';

                    document.body.appendChild(spark);
                    setTimeout(() => spark.remove(), 400);
                }
            }
            // Helper to update text
            updateNextShaftCostText() {
                let cost = Math.floor(CFG.baseCostShaft * Math.pow(4, this.shafts.length));
                $('#txt-next-cost').innerText = '$' + fmt(cost);

                // Position the button container in the column where the next shaft will appear
                const nextIsRight = (this.shafts.length % 2 !== 0);
                const btnContainer = $('#txt-next-cost').closest('.next-shaft-btn-container');
                if (btnContainer) {
                    btnContainer.style.gridColumn = nextIsRight ? '3' : '1';
                }
            }

            buyShaft() {
                // Cost for next shaft scales steeply with depth to match the 5x income jump
                let cost = Math.floor(CFG.baseCostShaft * Math.pow(4, this.shafts.length));

                if (this.shafts.length === 0 || this.money >= cost) {
                    if (this.shafts.length > 0) this.money -= cost;

                    // Logic: Alternate sides, but allow buying them in pairs if possible?
                    // For now, just follow the index-based side logic.
                    const side = (this.shafts.length % 2 === 0 ? 'LEFT' : 'RIGHT');
                    this.shafts.push(new Shaft(this.shafts.length, 1, this.prestigeMult, side));

                    // Resize World to fit new shaft
                    this.resizeWorld();

                    // Bonus SuperCash for new shaft
                    if (this.shafts.length > 1) {
                        this.superCash += 5;
                        this.createFloatText('ðŸ’Ž+5', 300, 200);
                        this.audio.playSFX('coin');
                    }
                    this.saveGame();
                    // Update Text for NEXT shaft
                    this.updateNextShaftCostText();
                    this.audio.playSFX('upgrade');
                } else {
                    this.audio.playSFX('error');
                }
            }

            openUpgrade(target, id) {
                this.activeUpgradeTarget = target;
                this.activeUpgradeId = id;
                this.modalMode = 'upgrade';
                $('#modal-overlay').style.display = 'flex';
                this.renderModal();
            }

            /* --- RESEARCH TREE UI METHODS --- */
            openResearch() {
                this.audio.playSFX('coin');
                this.audio.duckSFX(true);
                this.audio.startResearchMusic();
                $('#research-overlay').style.display = 'flex';
                this.renderResearch();
            }

            closeResearch() {
                this.audio.duckSFX(false);
                this.audio.stopResearchMusic();
                $('#research-overlay').style.display = 'none';
            }

            renderResearch() {
                const container = $('#research-tree-container');
                const content = $('.research-content');
                const tooltip = $('#research-global-tooltip');

                content.style.overflowX = 'auto';
                content.style.touchAction = 'auto';

                const availableW = content.clientWidth - 40;
                const availableH = content.clientHeight - 40;
                const designW = 800;
                const designH = 520;

                // Relaxed scaling: Minimum scale for readability, allow scroll if needed
                let finalScale = 1.0;
                if (availableW < designW || availableH < designH) {
                    const scaleW = availableW / designW;
                    const scaleH = availableH / designH;
                    // We don't want it to feel too tiny, so we floor it at 0.85 
                    // and allow scrolling for the rest.
                    finalScale = Math.max(0.85, Math.min(scaleW, scaleH));
                }

                container.style.transformOrigin = 'top left';
                container.style.transform = `scale(${finalScale})`;
                // Adjust margin to pull up content
                container.style.marginBottom = `-${designH * (1 - finalScale)}px`;

                container.innerHTML = '';
                // Add tooltip again if it was cleared
                if (!tooltip) {
                    const t = document.createElement('div');
                    t.id = 'research-global-tooltip';
                    container.parentNode.appendChild(t);
                }

                // Create SVG layer
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.classList.add('research-svg-layer');
                container.appendChild(svg);

                Object.values(RESEARCH_NODES).forEach(node => {
                    const el = document.createElement('div');
                    const unlocked = this.research.isUnlocked(node.id);
                    const canUnlock = this.research.canUnlock(node.id);
                    const cost = node.cost;

                    el.className = `research-node ${unlocked ? 'unlocked' : (canUnlock ? '' : 'locked')}`;
                    el.style.left = node.x + 'px';
                    el.style.top = node.y + 'px'; // No extra padding needed now

                    el.innerHTML = `
                        <div class="research-card-inner">
                            <div class="research-card-front">
                                <div class="research-node-icon">${node.icon}</div>
                                <div class="research-node-name">${node.name}</div>
                                <div class="research-node-cost">${unlocked ? 'ACTIVE' : fmt(cost) + (node.type === 'cash' ? ' $' : ' ðŸ’Ž')}</div>
                            </div>
                            <div class="research-card-back">
                                <b>SYSTEM SPECS</b>
                                ${node.desc}
                            </div>
                        </div>
                    `;

                    // Tooltip Logic
                    // Removed tooltip logic as it's replaced by the card-back.
                    // el.onmouseenter = (e) => {
                    //     const globalTooltip = $('#research-global-tooltip');
                    //     globalTooltip.innerHTML = `<b>${node.name}</b>${node.desc}`;
                    //     globalTooltip.style.display = 'block';

                    //     // Position relative to research-content
                    //     const contentRect = $('.research-content').getBoundingClientRect();
                    //     const nodeRect = el.getBoundingClientRect();

                    //     globalTooltip.style.left = (nodeRect.left - contentRect.left + nodeRect.width / 2 - 120) + 'px';
                    //     // Tooltip bottom will now be directly above the node top
                    //     const tooltipHeight = globalTooltip.offsetHeight || 80;
                    //     globalTooltip.style.top = (nodeRect.top - contentRect.top - tooltipHeight - 5) + 'px';
                    // };
                    // el.onmouseleave = () => {
                    //     $('#research-global-tooltip').style.display = 'none';
                    // };

                    if (!unlocked && canUnlock) {
                        el.onclick = () => {
                            this.buyResearch(node.id);
                            // $('#research-global-tooltip').style.display = 'none'; // Removed as tooltip logic is removed
                        };
                    }

                    container.appendChild(el);

                    // Connections
                    if (node.req) {
                        const reqs = Array.isArray(node.req) ? node.req : [node.req];
                        reqs.forEach(reqId => {
                            const parent = RESEARCH_NODES[reqId];
                            if (parent) {
                                this.drawResearchConnection(svg, parent, node, unlocked);
                            }
                        });
                    }
                });
            }

            drawResearchConnection(svg, from, to, isActive) {
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");

                // Card dimensions are 150x100.
                const x1 = from.x + 75;
                const y1 = from.y + 50;
                const x2 = to.x + 75;
                const y2 = to.y + 50;

                const dx = x2 - x1;
                const dy = y2 - y1;
                const d = `M ${x1} ${y1} C ${x1 + dx * 0.2} ${y1}, ${x2 - dx * 0.2} ${y2}, ${x2} ${y2}`;

                path.setAttribute("d", d);
                path.classList.add('research-connection');
                if (isActive) path.classList.add('active');
                svg.appendChild(path);
            }

            buyResearch(id) {
                const node = RESEARCH_NODES[id];
                const cost = node.cost;
                const affordable = (node.type === 'cash') ? (this.money >= cost) : (this.superCash >= cost);

                if (this.research.canUnlock(id) && affordable) {
                    if (node.type === 'cash') this.money -= cost;
                    else this.superCash -= cost;

                    this.research.unlock(id);
                    this.audio.playSFX('upgrade');
                    this.renderResearch();

                    // Trigger recalcs if needed
                    if (node.effect.target === 'mineRate' || node.effect.target === 'capacity' || node.effect.target === 'binCap') {
                        this.shafts.forEach(s => s.recalcStats());
                    }
                    if (node.effect.target === 'whCapacity') {
                        this.warehouse.applyStats();
                    }

                    this.saveGame();
                } else {
                    this.audio.playSFX('error');
                }
            }
            openShop() {
                this.modalMode = 'shop';
                this.audio.duckSFX(true);
                this.audio.enterShop(); // Exclusive mode
                $('#modal-overlay').style.display = 'flex';
                this.renderModal();
            }


            openSettings() {
                this.modalMode = 'settings';
                $('#modal-overlay').style.display = 'flex';
                this.renderModal();
            }
            showMine() {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.nav-btn').classList.add('active');
            }
            showMap() {
                this.modalMode = 'map';
                $('#modal-overlay').style.display = 'flex';
                this.renderModal();
            }
            closeModal() {
                $('#modal-overlay').style.display = 'none';
                $('#popup-balance-msg').style.display = 'none';
                if (this.modalMode === 'shop') {
                    this.audio.duckSFX(false);
                    this.audio.exitShop(); // Exit exclusive mode
                }
                this.modalMode = null;
            }

            startAutoBuy() {
                if (this.autoBuyTimer) return;
                this.autoBuyInterval = 500; // Start slow
                this.performUpgrade(); // Buy one immediately
                this.autoBuyLoop();
            }

            stopAutoBuy() {
                clearTimeout(this.autoBuyTimer);
                this.autoBuyTimer = null;
                this.autoBuyInterval = 500; // Reset speed
            }

            autoBuyLoop() {
                this.autoBuyTimer = setTimeout(() => {
                    this.performUpgrade();
                    // Accelerate
                    this.autoBuyInterval = Math.max(50, this.autoBuyInterval * 0.85);
                    this.autoBuyLoop();
                }, this.autoBuyInterval);
            }

            performUpgrade() {
                let success = false;
                // Reuse existing logic based on active params
                if (this.activeUpgradeTarget === 'SHAFT') {
                    let s = this.shafts[this.activeUpgradeId];
                    if (this.money >= s.getCost()) {
                        this.money -= s.getCost();
                        s.upgrade();
                        success = true;
                    }
                } else if (this.activeUpgradeTarget === 'ELE') {
                    let e = this.elevator;
                    let cost = Math.floor(CFG.baseCostEle * Math.pow(1.25, e.level));
                    if (this.money >= cost) {
                        this.money -= cost;
                        e.upgrade();
                        success = true;
                    }
                } else if (this.activeUpgradeTarget === 'WH') {
                    let w = this.warehouse;
                    let cost = Math.floor(CFG.baseCostWH * Math.pow(1.25, w.level));
                    if (this.money >= cost) {
                        this.money -= cost;
                        w.upgrade();
                        success = true;
                    }
                }

                if (success) {
                    // Optimized UI Update
                    if (document.getElementById('modal-overlay').style.display !== 'none') {
                        this.updateModalUI();
                    }

                    // Audio with Pitch Shift
                    let pitch = 1.0;
                    if (this.autoBuyInterval) {
                        pitch = 1.0 + ((500 - Math.max(50, this.autoBuyInterval)) / 450) * 0.8;
                    }
                    this.audio.playSFX('upgrade', pitch);
                } else {
                    // Only play error if not currently in auto-buy loop (to avoid sound spam)
                    if (this.autoBuyInterval === 500 || !this.autoBuyTimer) {
                        this.audio.playSFX('error');
                        $('#popup-balance-msg').style.display = 'block';
                        setTimeout(() => $('#popup-balance-msg').style.display = 'none', 1000);
                    }
                    this.stopAutoBuy(); // Stop if we can't afford
                }
            }

            updateModalUI() {
                // Targeted updates to avoid DOM thrashing & animation resets
                if (this.activeUpgradeTarget === 'SHAFT') {
                    let s = this.shafts[this.activeUpgradeId];
                    let cost = s.getCost();

                    // Update Title
                    $('#popup-title').innerText = "Mine Shaft " + (s.id + 1);

                    // Update Button Cost
                    const btn = $('#popup-buy-btn');
                    if (btn) {
                        // Only update text node to avoid killing listeners? 
                        // Actually innerText rewrite might kill listeners if not careful, BUT we attached listeners to the element object.
                        // innerText replacement is safe for listeners attached via property (btn.onclick), but standard Events? 
                        // Wait, renderModal recreates the button. Here we KEEP the button.
                        // So listeners persist!
                        btn.innerText = `Upgrade ($${fmt(cost)})`;
                    }

                    // Update Progress Bar & Milestone Text
                    const milestones = [10, 25, 50, 100, 200];
                    const nextMs = milestones.find(m => m > s.level) || 200;
                    const prevMs = milestones.filter(m => m <= s.level).pop() || 0;
                    const msReward = { 10: 2, 25: 5, 50: 10, 100: 20, 200: 50 }[nextMs] || 50;

                    let progress = 0;
                    if (s.level < nextMs) {
                        progress = Math.max(0, Math.min(100, ((s.level - prevMs) / (nextMs - prevMs)) * 100));
                    } else { progress = 100; }

                    // Find elements within stats
                    const statsContainer = $('#popup-stats');
                    if (statsContainer) {
                        // We need stable selectors for these to update them cleanly.
                        // But we didn't add IDs. Let's try to querySelector by style/structure or just fallback to renderModal if too complex?
                        // Actually, we can just query the first div's children.

                        // Hacky but effective: re-generate the milestone HTML block ONLY? No, that still resets animation.
                        // Let's modify styles directly.
                        const levelSpan = statsContainer.querySelector('div[style*="justify-content:space-between"] span:first-child');
                        const goalSpan = statsContainer.querySelector('div[style*="justify-content:space-between"] span:last-child');
                        const barFill = statsContainer.querySelector('div[style*="linear-gradient(90deg"]');
                        const diamondReward = statsContainer.querySelector('div[style*="right:-10px"] div');

                        if (levelSpan) levelSpan.innerText = `Level ${s.level}`;
                        if (goalSpan) goalSpan.innerText = `Next Goal: Level ${nextMs}`;
                        if (barFill) barFill.style.width = `${progress}%`;
                        if (diamondReward) {
                            let rewardHtml = `ðŸ’Ž<br>${msReward}`;
                            if (nextMs === 25 || nextMs === 50) {
                                rewardHtml += `<div style="font-size:0.6rem; color:#FFF; margin-top:1px; line-height:1; font-weight:bold;">+â›ï¸1</div>`;
                            }
                            diamondReward.innerHTML = rewardHtml;
                        }

                        // Update Worker Stat (if it exists)
                        const workerRow = statsContainer.querySelector('.worker-stat-row');
                        if (workerRow) {
                            let currentWorkers = (s.level >= 50 ? 3 : (s.level >= 25 ? 2 : 1));
                            let nextWorkers = ((s.level + 1) >= 50 ? 3 : ((s.level + 1) >= 25 ? 2 : 1));
                            let nextUnlock = s.level < 25 ? 25 : (s.level < 50 ? 50 : null);

                            workerRow.querySelector('.stat-val-curr').innerText = currentWorkers;
                            workerRow.querySelector('.stat-val-next').innerText = nextWorkers;

                            const hintSpan = workerRow.querySelector('.worker-hint');
                            if (hintSpan) {
                                hintSpan.innerText = (nextUnlock && nextWorkers === currentWorkers) ? `(Next: Lvl ${nextUnlock})` : '';
                            }

                            if (nextWorkers > currentWorkers) {
                                workerRow.querySelector('.stat-next').style.color = '#69F0AE';
                            } else {
                                workerRow.querySelector('.stat-next').style.color = '';
                            }
                        }
                    }
                } else {
                    // Fallback for ELE/WH
                    this.renderModal();
                }
            }

            renderModal() {
                if (this.modalMode === 'shop') {
                    $('#popup-title').innerText = 'ðŸ›’ Shop';
                    $('#popup-stats').innerHTML = `
                        <div class="shop-grid">
                            <div class="shop-item" onclick="game.buyBoost('speed')">
                                <div class="shop-item-icon">âš¡</div>
                                <div class="shop-item-name">Speed (+10%)</div>
                                <div style="font-size:0.8rem; color:#B0BEC5; margin-bottom:5px;">Lvl ${this.boosts.speed}/10 (${(1 + this.boosts.speed * 0.1).toFixed(1)}x)</div>
                                <div class="shop-item-price" style="${this.boosts.speed >= 10 ? 'color:#FFD54F' : ''}">${this.boosts.speed >= 10 ? 'MAX' : 'ðŸ’Ž 10'}</div>
                            </div>
                            <div class="shop-item" onclick="game.buyBoost('earnings')">
                                <div class="shop-item-icon">ðŸ’°</div>
                                <div class="shop-item-name">Profit (+10%)</div>
                                <div style="font-size:0.8rem; color:#B0BEC5; margin-bottom:5px;">Lvl ${this.boosts.earnings}/10 (${(1 + this.boosts.earnings * 0.1).toFixed(1)}x)</div>
                                <div class="shop-item-price" style="${this.boosts.earnings >= 10 ? 'color:#FFD54F' : ''}">${this.boosts.earnings >= 10 ? 'MAX' : 'ðŸ’Ž 10'}</div>
                            </div>
                            <div class="shop-item" onclick="game.instantCollect()">
                                <div class="shop-item-icon">ðŸš€</div>
                                <div class="shop-item-name">Instant Collect</div>
                                <div class="shop-item-price">ðŸ’Ž 5</div>
                            </div>
                            <div class="shop-item" onclick="game.buyManager()">
                                <div class="shop-item-icon">ðŸ‘”</div>
                                <div class="shop-item-name">+1 Manager</div>
                                <div class="shop-item-price">ðŸ’Ž 50</div>
                            </div>
                        </div>
                        <p style="text-align:center;color:#69F0AE;font-weight:bold;">Your SuperCash: ðŸ’Ž ${this.superCash}</p>
                    `;
                    $('#popup-buy-btn').style.display = 'none';
                    return;
                }
                if (this.modalMode === 'settings') {
                    $('#popup-title').innerText = 'âš™ï¸ Settings';
                    $('#popup-stats').innerHTML = `
                        <style>
                            .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; }
                            .volume-control { display: flex; align-items: center; gap: 10px; flex: 1; margin-left: 15px; }
                            .volume-slider { flex: 1; height: 6px; -webkit-appearance: none; appearance: none; background: #455A64; border-radius: 3px; outline: none; }
                            .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: #4CAF50; border-radius: 50%; cursor: pointer; }
                            .volume-slider::-moz-range-thumb { width: 18px; height: 18px; background: #4CAF50; border-radius: 50%; cursor: pointer; border: none; }
                            .volume-value { min-width: 40px; text-align: right; color: #81C784; font-weight: bold; }
                        </style>

                        <div class="settings-row">
                            <span>ðŸŽµ Music</span>
                            <div class="toggle-switch ${this.audio.musicEnabled ? 'on' : ''}" onclick="game.toggleMusic()"></div>
                        </div>
                        
                        <div class="settings-row">
                            <span style="font-size: 0.9rem; color: #B0BEC5;">  LautstÃ¤rke</span>
                            <div class="volume-control">
                                <input type="range" class="volume-slider" min="0" max="100" value="${Math.round(this.audio.musicVolume * 100)}" 
                                    oninput="game.audio.setMusicVolume(this.value / 100); this.nextElementSibling.innerText = this.value + '%';">
                                <span class="volume-value">${Math.round(this.audio.musicVolume * 100)}%</span>
                            </div>
                        </div>

                        <div class="settings-row">
                            <span>ðŸ”Š Sound Effects</span>
                            <div class="toggle-switch ${this.audio.sfxEnabled ? 'on' : ''}" onclick="game.toggleSFX()"></div>
                        </div>
                        
                        <div class="settings-row">
                            <span style="font-size: 0.9rem; color: #B0BEC5;">  LautstÃ¤rke</span>
                            <div class="volume-control">
                                <input type="range" class="volume-slider" min="0" max="100" value="${Math.round(this.audio.sfxVolume * 100)}" 
                                    oninput="game.audio.setSFXVolume(this.value / 100); this.nextElementSibling.innerText = this.value + '%';">
                                <span class="volume-value">${Math.round(this.audio.sfxVolume * 100)}%</span>
                            </div>
                        </div>

                        <div class="settings-row">
                            <span>ðŸ“Š Statistics</span>
                            <span style="color:#666;">Shafts: ${this.shafts.length} | Total: $${fmt(this.money)}</span>
                        </div>
                        <div class="settings-row">
                            <span>ðŸ’¾ Game Save</span>
                            <button class="btn-upgrade-simple btn-danger" onclick="game.resetGame()">Reset</button>
                        </div>
                    `;
                    $('#popup-buy-btn').style.display = 'none';
                    return;
                }
                if (this.modalMode === 'map') {
                    $('#popup-title').innerText = 'ðŸ—ºï¸ World Map';
                    let html = '<div class="shop-grid" style="display:flex; flex-direction:column; gap:10px;">';
                    WORLDS.forEach(w => {
                        let locked = this.money < w.cost && this.worldId < w.idx;
                        let active = this.worldId === w.idx;
                        let canUnlock = this.money >= w.cost && this.worldId !== w.idx;
                        let bg = active ? 'linear-gradient(45deg, #43A047, #2E7D32)' : (locked ? '#455A64' : '#546E7A');

                        html += `
                            <div class="shop-item" style="width:100%; height:auto; padding:15px; background:${bg}; border-color:${active ? '#69F0AE' : '#78909C'}; opacity:${locked ? 0.6 : 1}; cursor:${canUnlock ? 'pointer' : 'default'}" 
                                onclick="${canUnlock ? 'game.performPrestige(' + w.idx + ')' : ''}">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div>
                                        <div style="font-size:1.2rem; font-weight:bold; color:${active ? '#FFF' : '#ECEFF1'}">${w.name} ${active ? '(Active)' : ''}</div>
                                        <div style="font-size:0.9rem; color:#CFD8DC;">${locked ? 'Required: $' + fmt(w.cost) : (active ? 'Current Multiplier: x' + this.prestigeMult : 'ðŸš€ PRESTIGE: x' + w.mult + ' Earnings')}</div>
                                    </div>
                                    <div style="font-size:2rem;">${w.id === 'MOON' ? 'ðŸŒ‘' : (w.id === 'RUBY' ? 'ðŸ”»' : (w.id === 'GOLD' ? 'ðŸ†' : 'ðŸŒ²'))}</div>
                                </div>
                                ${canUnlock ? `<div style="margin-top:5px; padding:5px; background:#D32F2F; color:white; font-size:0.8rem; border-radius:4px; text-transform:uppercase; font-weight:bold; text-align:center;">Sell Now & Restart</div>` : ''}
                            </div>
                        `;
                    });
                    html += '</div>';
                    $('#popup-stats').innerHTML = html;
                    $('#popup-buy-btn').style.display = 'none';
                    return;
                }
                if (this.modalMode === 'hire') {
                    $('#popup-title').innerText = 'ðŸ‘” Hire Manager';
                    const jrCost = this.getManagerCost('JUNIOR', this.activeUpgradeTarget, this.activeUpgradeId);
                    const srCost = this.getManagerCost('SENIOR', this.activeUpgradeTarget, this.activeUpgradeId);
                    const exCost = this.getManagerCost('EXECUTIVE', this.activeUpgradeTarget, this.activeUpgradeId);

                    $('#popup-stats').innerHTML = `
                        <div class="shop-grid">
                            <div class="shop-item" onclick="game.hireManager('JUNIOR')">
                                <div class="shop-item-icon">ðŸ‘·</div>
                                <div class="shop-item-name">Junior Manager</div>
                                <div style="font-size:0.7rem; margin-bottom:5px;">2x Yield (1m)</div>
                                <div class="shop-item-price" style="color:#FFF">$${fmt(jrCost)}</div>
                            </div>
                            <div class="shop-item" onclick="game.hireManager('SENIOR')" style="border-color:#FFCA28; background:linear-gradient(135deg, #424242, #37474F)">
                                <div class="shop-item-icon">ðŸ¤µ</div>
                                <div class="shop-item-name">Senior Manager</div>
                                <div style="font-size:0.7rem; margin-bottom:5px;">4x Yield (2m)</div>
                                <div class="shop-item-price" style="color:#FFF">$${fmt(srCost)}</div>
                            </div>
                            <div class="shop-item" onclick="game.hireManager('EXECUTIVE')" style="border-color:#F44336; background:linear-gradient(135deg, #5D4037, #3E2723); box-shadow: 0 0 10px #D32F2F;">
                                <div class="shop-item-icon">ðŸ•´ï¸</div>
                                <div class="shop-item-name">Executive</div>
                                <div style="font-size:0.7rem; margin-bottom:5px;">10x Yield (5m)</div>
                                <div class="shop-item-price" style="color:#69F0AE">ðŸ’Ž ${MANAGERS.EXECUTIVE.cost}</div>
                            </div>
                        </div>
                    `;
                    $('#popup-buy-btn').style.display = 'none';
                    return;
                }
                $('#popup-buy-btn').style.display = 'block';
                let title = "", statsHtml = "", cost = 0;
                const row = (l, c, n) => `<div class="stats-row"><span>${l}</span><span>${fmt(c)} <span class="stat-next">&#8594; ${fmt(n)}</span></span></div>`;
                if (this.activeUpgradeTarget === 'SHAFT') {
                    let s = this.shafts[this.activeUpgradeId]; title = "Mine Shaft " + (s.id + 1); cost = s.getCost();

                    // MILESTONE PROGRESS BAR
                    const milestones = [10, 25, 50, 100, 200];
                    const nextMs = milestones.find(m => m > s.level) || 200;
                    const prevMs = milestones.filter(m => m <= s.level).pop() || 0;
                    const msReward = { 10: 2, 25: 5, 50: 10, 100: 20, 200: 50 }[nextMs] || 50;

                    // Progress Calculation
                    let progress = 0;
                    if (s.level < nextMs) {
                        progress = Math.max(0, Math.min(100, ((s.level - prevMs) / (nextMs - prevMs)) * 100));
                    } else {
                        progress = 100; // Maxed out?
                    }

                    statsHtml += `
                        <div style="margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.9rem; color:#B0BEC5;">
                                <span>Level ${s.level}</span>
                                <span style="color:#FFF; font-weight:bold;">Next Goal: Level ${nextMs}</span>
                            </div>
                            <div style="position:relative; height:24px; background:#37474F; border-radius:12px; overflow:visible; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);">
                                <div style="width:${progress}%; height:100%; background:linear-gradient(90deg, #FFC107, #FFD54F); border-radius:12px; transition: width 0.5s ease-out; box-shadow: 0 0 10px rgba(255, 193, 7, 0.4);">
                                    <div style="position:absolute; right:0; top:0; bottom:0; width:100%; height:100%; background:linear-gradient(45deg, rgba(255,255,255,0) 40%, rgba(255,255,255,0.5) 50%, rgba(255,255,255,0) 60%); background-size: 200% 100%; animation: shimmer 2s infinite;"></div>
                                </div>
                                <!-- Milestone Diamond Bubble -->
                                <div style="position:absolute; right:-10px; top:50%; transform:translateY(-50%); width:32px; height:32px; background:linear-gradient(135deg, #02fa90, #00c853); border:2px solid #FFF; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 8px rgba(0,0,0,0.4); z-index:10;">
                                    <div style="font-size:0.75rem; font-weight:bold; color:#004D40; text-align:center; line-height:1;">
                                        ðŸ’Ž<br>${msReward}
                                        ${(nextMs === 25 || nextMs === 50) ? `<div style="font-size:0.6rem; color:#FFF; margin-top:1px;">+â›ï¸1</div>` : ''}
                                    </div>
                                </div>
                            </div>
                            <style>
                                @keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: -100% 0; } }
                            </style>
                        </div>
                    `;

                    // Worker Progression Row
                    let currentWorkers = (s.level >= 50 ? 3 : (s.level >= 25 ? 2 : 1));
                    let nextWorkers = ((s.level + 1) >= 50 ? 3 : ((s.level + 1) >= 25 ? 2 : 1));
                    let nextUnlock = s.level < 25 ? 25 : (s.level < 50 ? 50 : null);

                    statsHtml += `
                        <div class="stats-row worker-stat-row">
                            <span>Workers</span>
                            <span>
                                <span class="stat-val-curr">${currentWorkers}</span>
                                <span class="stat-next" style="${nextWorkers > currentWorkers ? 'color:#69F0AE' : ''}">
                                    &#8594; <span class="stat-val-next">${nextWorkers}</span>
                                </span>
                                <span class="worker-hint" style="font-size:0.75rem; color:#B0BEC5; margin-left:10px;">
                                    ${(nextUnlock && nextWorkers === currentWorkers) ? `(Next: Lvl ${nextUnlock})` : ''}
                                </span>
                            </span>
                        </div>
                    `;

                    // Display stats for the first miner, assuming others are similar
                    let currentSpeed = s.miners[0].stats.speed;
                    let nextSpeed = 60 + (Math.min(s.level + 1, 10) * 1);
                    if (currentSpeed >= 70) {
                        statsHtml += `<div class="stats-row"><span>Speed</span><span>${fmt(currentSpeed)} <span style="color:#FFB74D">âš ï¸ MAX</span></span></div>`;
                    } else {
                        statsHtml += row("Speed", currentSpeed, nextSpeed);
                    }
                    statsHtml += row("Capacity", s.miners[0].stats.capacity, s.miners[0].stats.capacity * 1.2);
                } else if (this.activeUpgradeTarget === 'ELE') {
                    let e = this.elevator;
                    title = "Elevator";
                    cost = Math.floor(CFG.baseCostEle * Math.pow(1.25, e.level));

                    // Show capacity (always increases)
                    statsHtml += row("Capacity", e.cap, e.cap * 1.3);

                    // Show speed (only if it will change - before level 11)
                    if (e.level < 11) {
                        statsHtml += row("Speed", e.speed, e.speed + 2);
                    } else {
                        statsHtml += `<div class="stats-row"><span>Speed</span><span>${e.speed} <span style="color:#FFB74D">âš ï¸ MAX</span></span></div>`;
                    }

                    // Show load rate (always increases)
                    let currentLoadRate = e.loadRate;
                    let nextLoadRate = 50 + ((e.level + 1) * 10);
                    statsHtml += row("Loading Speed/s", currentLoadRate, nextLoadRate);
                } else {
                    let w = this.warehouse; title = "Warehouse"; cost = Math.floor(CFG.baseCostWH * Math.pow(1.25, w.level));
                    statsHtml += row("Load", w.transporters[0].cap, w.transporters[0].cap * 1.3);
                }
                $('#popup-title').innerText = title; $('#popup-stats').innerHTML = statsHtml;
                const btn = $('#popup-buy-btn');
                btn.innerText = `Upgrade ($${fmt(cost)})`;
                this.currentUpgradeCost = cost;

                // Auto-Buy Events (Hold to Upgrade)
                btn.onmousedown = (e) => { if (e.button === 0) this.startAutoBuy(); };
                btn.onmouseup = () => this.stopAutoBuy();
                btn.onmouseleave = () => this.stopAutoBuy();
                btn.ontouchstart = (e) => { e.preventDefault(); this.startAutoBuy(); };
                btn.ontouchend = (e) => { e.preventDefault(); this.stopAutoBuy(); };
            }
            buyBoost(type) {
                if (this.boosts[type] >= 10) return; // Maxed

                if (this.superCash >= 10) {
                    this.superCash -= 10;
                    this.boosts[type]++;
                    this.recalcAll(); // Apply new boost immediately
                    this.audio.playSFX('upgrade');
                    this.renderModal();
                } else {
                    alert('Not enough SuperCash! ðŸ’Ž');
                }
            }

            instantCollect() {
                if (this.superCash >= 5) {
                    this.superCash -= 5;
                    this.shafts.forEach(s => {
                        this.money += s.bin;
                        s.bin = 0;
                        s.updateVis();
                    });
                    this.money += this.elevDepot;
                    this.elevDepot = 0;
                    this.renderModal();
                } else {
                    alert('Not enough SuperCash! ðŸ’Ž');
                }
            }
            buyManager() {
                if (this.superCash >= 50) {
                    this.superCash -= 50;
                    this.warehouse.spawnTransporter();
                    this.renderModal();
                } else {
                    alert('Not enough SuperCash! ðŸ’Ž');
                }
            }
            toggleSound() {
                this.audio.toggle();
                this.renderModal();
            }

            toggleMusic() {
                this.audio.toggleMusic();
                this.renderModal();
            }

            toggleSFX() {
                this.audio.toggleSFX();
                this.renderModal();
            }

            recalcAll() {
                this.shafts.forEach(s => { s.recalcStats(); s.updateBtn(); });
                this.warehouse.applyStats();
            }

            resetGame() {

                if (confirm('Really clear game progress?')) {
                    localStorage.removeItem('idleMinerSave');
                    location.reload();
                }
            }
            applyWorldVisuals(idx) {
                if (!WORLDS[idx]) idx = 0;
                const css = WORLDS[idx].css;
                const r = document.documentElement.style;
                // Update CSS variables if we had them or specialized classes.
                // We used vars: --bg-sky (unused now), --bg-ground-dark, --bg-shaft.
                // But most styles are inline or class-based. We need to update Global CSS Vars.
                r.setProperty('--bg-ground-dark', css.earth);
                r.setProperty('--bg-shaft', css.dirt);

                // Update Dirt Layers
                const d = $('#dirt-layer');
                if (d) {
                    d.style.backgroundColor = css.dirt;
                    // Keep gradient? Yes.
                    d.style.backgroundImage = `repeating-linear-gradient(45deg, rgba(0, 0, 0, 0.05) 0px, rgba(0, 0, 0, 0.05) 2px, transparent 2px, transparent 10px), linear-gradient(to bottom, ${css.earth}, ${css.dirt})`;
                }

                // Grass
                const g = document.querySelector('.grass-layer');
                if (g) {
                    g.style.background = `linear-gradient(to bottom, ${css.grass}, ${this.shadeColor(css.grass, -20)})`;
                    g.style.borderBottomColor = this.shadeColor(css.grass, -40);
                }

                // Day-Night Theme
                if (this.dayNight) this.dayNight.setTheme(css.skyTop, css.skyBot);
            }
            shadeColor(color, percent) {
                var R = parseInt(color.substring(1, 3), 16);
                var G = parseInt(color.substring(3, 5), 16);
                var B = parseInt(color.substring(5, 7), 16);
                R = parseInt(R * (100 + percent) / 100);
                G = parseInt(G * (100 + percent) / 100);
                B = parseInt(B * (100 + percent) / 100);
                R = (R < 255) ? R : 255;
                G = (G < 255) ? G : 255;
                B = (B < 255) ? B : 255;
                var RR = ((R.toString(16).length == 1) ? "0" + R.toString(16) : R.toString(16));
                var GG = ((G.toString(16).length == 1) ? "0" + G.toString(16) : G.toString(16));
                var BB = ((B.toString(16).length == 1) ? "0" + B.toString(16) : B.toString(16));
                return "#" + RR + GG + BB;
            }

            performPrestige(idx) {
                const w = WORLDS[idx];
                if (this.money >= w.cost) {
                    if (confirm(`Switch world to ${w.name}? \nWarning: Everything will be reset! You only keep SuperCash, but your income will be multiplied by x${w.mult}!`)) {
                        // RESET
                        this.money = 100;
                        this.shafts = [];
                        $('#shafts-anchor').innerHTML = ''; // Clear Left DOM
                        $('#shafts-right-anchor').innerHTML = ''; // Clear Right DOM

                        // Thoroughly clear Logistics areas to prevent duplicate manager slots/lights
                        const eleShaft = $('.elevator-shaft');
                        if (eleShaft) {
                            eleShaft.querySelectorAll('.manager-slot, .light-source').forEach(el => el.remove());
                        }
                        const whVisual = $('.warehouse-visual');
                        if (whVisual) {
                            whVisual.querySelectorAll('.manager-slot, .light-source, .warehouse-window-glow').forEach(el => el.remove());
                        }
                        const whFront = $('.warehouse-front');
                        if (whFront) {
                            whFront.querySelectorAll('.manager-slot').forEach(el => el.remove());
                        }
                        // Clear transporters from surface
                        const surface = $('#surface-angels-layer');
                        if (surface) surface.innerHTML = '';

                        this.elevator = new Elevator();
                        this.warehouse = new Warehouse();
                        // Reset upgrades visual
                        $('#elevator-fill').style.height = '0px';
                        $('#depot-fill').style.height = '0px';
                        $('#btn-ele').innerText = 'Lvl 1';
                        $('#btn-wh').innerText = 'Lvl 1';

                        // APPLY
                        this.worldId = idx;
                        this.prestigeMult = w.mult;
                        this.applyWorldVisuals(idx);
                        if (this.weather) this.weather.setTheme(idx);

                        // RESTART
                        this.buyShaft(); // Start with 1 shaft
                        this.saveGame();
                        this.closeModal();

                        // Show Effect
                        this.showWelcomeBack(0, 0); // Reuse popup for "Welcome to New World"
                        const p = document.querySelector('.welcome-popup');
                        if (p) {
                            p.querySelector('h2').innerText = 'ðŸš€ New World!';
                            p.querySelector('p').innerText = `Welcome to ${w.name}!`;
                            p.querySelector('.welcome-earnings').innerText = `x${w.mult} Earnings`;
                        }
                        this.audio.playSFX('newWorld');
                    }
                } else {
                    this.audio.playSFX('error');
                }
            }


            tryBuyUpgrade() {
                if (this.money >= this.currentUpgradeCost) {
                    this.money -= this.currentUpgradeCost;
                    this.audio.playSFX('upgrade');
                    if (this.activeUpgradeTarget === 'SHAFT') this.shafts[this.activeUpgradeId].upgrade();
                    else if (this.activeUpgradeTarget === 'ELE') this.elevator.upgrade();
                    else this.warehouse.upgrade();
                    this.renderModal();
                } else {
                    this.audio.playSFX('error');
                    $('#popup-balance-msg').style.display = 'block';
                    setTimeout(() => $('#popup-balance-msg').style.display = 'none', 1000);
                }
            }

            addMoney(amount) {
                this.money += amount;
                if (this.missions) this.missions.onMoneyEarned(amount);
            }

            createFloatText(amt, x, y, color) {
                let el = document.createElement('div'); el.className = 'float-text';
                el.innerText = typeof amt === 'string' ? amt : '+$' + fmt(amt);
                el.style.left = x + 'px'; el.style.top = y + 'px';
                if (color) el.style.color = color;
                // Attach to wrapper so it scales with the world
                document.querySelector('.game-content-wrapper').appendChild(el);
                setTimeout(() => el.remove(), 1000);
            }

            getManagerCost(type, target, id) {
                let base = MANAGERS[type].cost;
                if (target === 'SHAFT' && (type === 'JUNIOR' || type === 'SENIOR') && id !== null) {
                    // Scale Input Cost by Shaft Depth: Base * (2.5 ^ ID)
                    return Math.floor(base * Math.pow(2.5, id));
                }
                return base;
            }

            openManagerHire(target, id) {
                this.modalMode = 'hire';
                this.activeUpgradeTarget = target; // SHAFT, ELE, WH
                this.activeUpgradeId = id;
                $('#modal-overlay').style.display = 'flex';
                this.renderModal();
            }
            hireManager(type) {
                const mgrSpec = MANAGERS[type];
                const cost = this.getManagerCost(type, this.activeUpgradeTarget, this.activeUpgradeId);

                // Check cost
                if ((mgrSpec.type === 'cash' && this.money >= cost) ||
                    (mgrSpec.type === 'super' && this.superCash >= cost)) {

                    if (this.activeUpgradeTarget === 'SHAFT') {
                        if (this.shafts[this.activeUpgradeId].manager) this.shafts[this.activeUpgradeId].manager.el.remove(); // Visual Cleanup
                        this.shafts[this.activeUpgradeId].assignManager(type);
                    } else if (this.activeUpgradeTarget === 'ELE') {
                        if (this.elevator.manager) this.elevator.manager.el.remove();
                        this.elevator.assignManager(type);
                    } else if (this.activeUpgradeTarget === 'WH') {
                        if (this.warehouse.manager) this.warehouse.manager.el.remove();
                        this.warehouse.assignManager(type);
                    }

                    if (mgrSpec.type === 'cash') this.money -= cost;
                    else this.superCash -= cost;

                    this.closeModal();
                } else {
                    alert("Not enough resources!");
                }
            }
            createParticle(x, y) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                p.style.setProperty('--px', (Math.random() * 40 - 20) + 'px');
                p.style.setProperty('--py', (Math.random() * 30 + 10) + 'px');
                p.style.width = p.style.height = (4 + Math.random() * 6) + 'px';
                p.style.background = Math.random() > 0.5 ? '#FFD54F' : '#8D6E63';
                p.style.borderRadius = '50%';
                // Append to wrapper
                document.querySelector('.game-content-wrapper').appendChild(p);
                setTimeout(() => p.remove(), 800);
            }
            updateButtons() {
                // New Shaft
                const nextShaftCost = Math.floor(CFG.baseCostShaft * Math.pow(4, this.shafts.length));
                const btnNewShaft = document.querySelector('button[onclick="game.buyShaft()"]');
                if (btnNewShaft) {
                    if (this.money >= nextShaftCost) {
                        btnNewShaft.classList.add('btn-affordable');
                        btnNewShaft.style.opacity = '1';
                    } else {
                        btnNewShaft.classList.remove('btn-affordable');
                        btnNewShaft.style.opacity = '0.7';
                    }
                }

                // Elevator
                const eleCost = Math.floor(CFG.baseCostEle * Math.pow(1.25, this.elevator.level));
                const btnEle = $('#btn-ele');
                if (btnEle) {
                    if (this.money >= eleCost) btnEle.classList.add('btn-affordable');
                    else btnEle.classList.remove('btn-affordable');
                }

                // Warehouse
                const whCost = Math.floor(CFG.baseCostWH * Math.pow(1.25, this.warehouse.level));
                const btnWh = $('#btn-wh');
                if (btnWh) {
                    if (this.money >= whCost) btnWh.classList.add('btn-affordable');
                    else btnWh.classList.remove('btn-affordable');
                }

                // INDIVIDUAL SHAFTS (User Request: ALL accessible buttons must react)
                this.shafts.forEach((s, i) => {
                    const cost = s.getCost();
                    const btn = document.getElementById('btn-shaft-' + i);
                    if (btn) {
                        if (this.money >= cost) btn.classList.add('btn-affordable');
                        else btn.classList.remove('btn-affordable');
                    }
                });
            }

            loop(timestamp) {
                const dt = Math.min((timestamp - this.lastTime) / 1000, 0.1);
                this.lastTime = timestamp;

                if (this.dayNight) this.dayNight.update(dt); // Update Day Night
                if (this.monsterManager) this.monsterManager.update(dt);
                if (this.helicopterManager) this.helicopterManager.update(dt);
                if (this.weather) this.weather.update(dt); // Update Weather
                if (this.missions) this.missions.checkProgress();
                if (this.tutorial) this.tutorial.update(dt); // Tutorial Update

                // Apply Boosts
                let speedMult = 1 + (this.boosts.speed * 0.1);
                // Removed decrement logic for permanent boosts


                this.shafts.forEach(s => s.update(dt, speedMult)); // Calls miner updates with manager speed
                this.elevator.update(dt, speedMult);
                this.warehouse.update(dt, speedMult);
                // Random SuperCash drop
                let scChance = 0.0001 * (this.research ? this.research.multipliers.scChance : 1);
                if (Math.random() < scChance) {
                    this.superCash += 1;
                    this.createFloatText('ðŸ’Ž+1', 400 + Math.random() * 200, 300);
                }
                $('#txt-cash').innerText = fmt(this.money);
                $('#txt-supercash').innerText = this.superCash;

                // UI Feedback
                this.updateButtons();

                requestAnimationFrame(this.loop);
            }

            toggleMenu() {
                const hud = document.querySelector('.hud-bottom');
                if (hud) {
                    hud.classList.toggle('collapsed');
                    const btn = hud.querySelector('.btn-toggle-menu');
                    if (btn) {
                        btn.innerHTML = hud.classList.contains('collapsed') ? 'â˜°' : 'Ã—';
                    }
                }
            }
        }
        var game = new Game();
        // Ensure applied perks are calculated (since game var was undefined during constructor)
        game.recalcAll();
        // --- MOBILE SCALING LOGIC ---
        function updateMobileScaling() {
            const stage = document.getElementById('game-stage');
            const targetWidth = 1400;
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            if (windowWidth < targetWidth || windowHeight < 800) {
                // Scale to fit width
                const scale = Math.min(windowWidth / targetWidth, 1);

                // Scale the ENTIRE stage (including backgrounds)
                stage.style.width = targetWidth + 'px';
                // Height should be auto or large enough to cover the world
                stage.style.height = '100vw'; // Fallback
                stage.style.minHeight = '2000px';

                stage.style.position = 'absolute';
                stage.style.left = '50%';
                stage.style.top = '0';
                // Use translateX to center the 1400px box, then scale
                stage.style.transform = `translateX(-50%) scale(${scale})`;
                stage.style.transformOrigin = 'top center';

                // Fix for HUD overlap or displacement
                const hud = document.getElementById('ui-layer');
                if (hud) {
                    // Ensure HUD stays at the top of the actual viewport
                    hud.style.height = windowHeight + 'px';
                }
            } else {
                // Reset for PC
                stage.style.width = '100%';
                stage.style.minHeight = '100vh';
                stage.style.left = '0';
                stage.style.top = '0';
                stage.style.transform = 'none';
            }
        }

        window.addEventListener('resize', updateMobileScaling);
        window.addEventListener('DOMContentLoaded', updateMobileScaling);
        updateMobileScaling();

    </script>
    <script type="text/javascript">
        window.SDK_OPTIONS = {
            gameId: "jxqbjaj9st5m8o95ibirxkbw71o2vifi",
            onEvent: function (a) {
                switch (a.name) {
                    case "SDK_GAME_PAUSE":
                        // pause game logic / mute audio
                        break;
                    case "SDK_GAME_START":
                        // advertisement done, resume game logic and unmute audio
                        break;
                    case "SDK_READY":
                        // when sdk is ready
                        break;
                }
            }
        };
        (function (a, b, c) {
            var d = a.getElementsByTagName(b)[0];
            a.getElementById(c) || (a = a.createElement(b), a.id = c, a.src = "https://api.gamemonetize.com/sdk.js", d.parentNode.insertBefore(a, d))
        })(document, "script", "gamemonetize-sdk");

        if (typeof sdk !== 'undefined' && sdk.showBanner !== 'undefined') {
            sdk.showBanner();
        }
    </script>

</body>

</html>
